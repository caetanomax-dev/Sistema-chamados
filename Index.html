<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Sistema de Chamados</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:Arial,sans-serif;background:#f4f6f8}
.layout{display:flex;min-height:100vh}
.sidebar{width:260px;background:#111827;color:#fff;padding:20px}
.sidebar img{max-width:100%;max-height:60px;margin-bottom:10px}
.sidebar h1{font-size:16px;margin:5px 0}
.sidebar button{width:100%;background:none;border:none;color:#d1d5db;padding:12px;text-align:left;border-radius:6px;cursor:pointer;margin-bottom:8px;transition:0.2s}
.sidebar button.active,.sidebar button:hover{background:#2563eb;color:#fff}
.content{flex:1;padding:30px}
.hidden{display:none}

.btn{background:#2563eb;color:#fff;border:none;padding:10px 16px;border-radius:6px;cursor:pointer;transition:0.2s}
.btn:hover{background:#1e40af}
.btn-danger{background:#dc2626;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;transition:0.2s}
.btn-danger:hover{background:#b91c1c}

table{width:100%;border-collapse:collapse;background:#fff;border-radius:8px;margin-top:15px}
th,td{padding:10px;border-bottom:1px solid #e5e7eb}
th{background:#f9fafb;font-size:12px;text-transform:uppercase}

.status{padding:4px 10px;border-radius:999px;font-size:12px;cursor:pointer;transition:0.2s}
.pendente{background:#fef3c7;color:#92400e}
.resolvido{background:#dcfce7;color:#166534}

/* MODAL */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:1000;
}
.modal.active{display:flex}
.modal-content{
  background:#fff;
  padding:20px;
  border-radius:10px;
  width:400px;
  max-height:90vh;
  overflow-y:auto;
}
.modal-content input,
.modal-content textarea{
  width:100%;
  margin-bottom:10px;
  padding:8px;
  border:1px solid #ddd;
  border-radius:4px;
}
.erro{color:#dc2626;padding:10px;background:#fee;border-radius:6px;margin:10px 0}

/* Config */
#config input{
  display:block;
  width:100%;
  margin-bottom:10px;
  padding:8px;
  border:1px solid #ddd;
  border-radius:6px;
}
#config button{margin-top:10px}

/* Cronologia */
#listaCronologia div{
  padding:5px;
  border-bottom:1px solid #eee;
  border-radius:4px;
  margin-bottom:4px;
  background:#f9fafb;
  transition:0.2s;
}
#listaCronologia div.ultimo{background:#dbeafe;}
#listaCronologia div span{font-size:10px;color:#555;display:block;margin-bottom:2px;}
</style>
</head>

<body>

<div class="layout">
  <aside class="sidebar">
    <img id="logoEmpresa" class="hidden">
    <h1 id="nomeEmpresa">Sistema</h1>

    <button class="active" onclick="app.aba('chamados',this)">üìã Chamados</button>
    <button onclick="app.aba('clientes',this)">üë• Clientes</button>
    <button onclick="app.aba('relatorios',this)">üìä Relat√≥rios</button>
    <button onclick="app.aba('config',this)">‚öôÔ∏è Config</button>
  </aside>

  <main class="content">
    <div id="msgErro"></div>

    <!-- Chamados -->
    <section id="chamados">
      <button class="btn" onclick="app.abrirModal()">+ Abrir Chamado</button>
      <table>
        <thead>
          <tr>
            <th>ID</th><th>Cliente</th><th>Solicitante</th>
            <th>T√©cnico</th><th>Descri√ß√£o</th><th>Status</th><th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="listaChamados"></tbody>
      </table>
    </section>

    <!-- Clientes -->
    <section id="clientes" class="hidden">
      <ul id="listaClientes"></ul>
    </section>

    <!-- Relat√≥rios -->
    <section id="relatorios" class="hidden">
      <input id="fCliente" placeholder="Cliente">
      <input id="fSolicitante" placeholder="Solicitante">
      <input id="fTecnico" placeholder="T√©cnico">
      <select id="fStatus">
        <option value="">Todos</option>
        <option value="pendente">Pendente</option>
        <option value="resolvido">Resolvido</option>
      </select>
      <button class="btn" onclick="app.relatorio()">Filtrar</button>

      <table>
        <thead>
          <tr>
            <th>ID</th><th>Cliente</th><th>Solicitante</th>
            <th>T√©cnico</th><th>Status</th><th>Cronologia</th>
          </tr>
        </thead>
        <tbody id="resultadoRelatorio"></tbody>
      </table>
    </section>

    <!-- Configura√ß√µes -->
    <section id="config" class="hidden">
      <input id="confEmpresa" placeholder="Nome da empresa">
      <input id="confLogo" placeholder="URL da logo">
      <button class="btn" onclick="app.salvarConfig()">Salvar</button>
    </section>

  </main>
</div>

<!-- Modal Chamado -->
<div id="modal" class="modal">
  <div class="modal-content">
    <input id="mCliente" placeholder="Cliente">
    <input id="mSolicitante" placeholder="Solicitante">
    <input id="mTecnico" placeholder="T√©cnico">
    <textarea id="mDescricao" placeholder="Descri√ß√£o"></textarea>
    <button class="btn" onclick="app.salvarChamado()">Salvar</button>
    <button class="btn-danger" onclick="app.fecharModal()">Cancelar</button>
  </div>
</div>

<!-- Modal Cronologia -->
<div id="modalCronologia" class="modal">
  <div class="modal-content">
    <h3>Cronologia do Chamado <span id="cronId"></span></h3>
    <div id="listaCronologia" style="max-height:250px; overflow:auto; border:1px solid #ddd; padding:5px; margin-bottom:10px;"></div>
    <textarea id="novaAtualizacao" placeholder="Nova atualiza√ß√£o..."></textarea>
    <button class="btn" onclick="app.salvarAtualizacao()">Adicionar</button>
    <button class="btn-danger" onclick="app.fecharModalCronologia()">Fechar</button>
  </div>
</div>

<script>
// ============================
// COLOQUE AQUI SUA URL E CHAVE
// ============================
const SUPABASE_URL = 'https://boendmrotsttljydigld.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJvZW5kbXJvdHN0dGxqeWRpZ2xkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1OTI5NTksImV4cCI6MjA4MjE2ODk1OX0.k6vVvD6kNV8r-a9lR6jaTcAm1wz5c_jbTDnjKlpo0cE';

const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const app = {
  mostrarErro(msg){
    const div = document.getElementById('msgErro');
    div.innerHTML = `<div class="erro">‚ùå ${msg}</div>`;
    setTimeout(() => div.innerHTML = '', 5000);
    console.error(msg);
  },
  aba(id,btn){
    document.querySelectorAll('section').forEach(s=>s.classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
    document.querySelectorAll('.sidebar button').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
  },
  abrirModal(){ 
    document.getElementById('modal').classList.add('active');
    mCliente.value = '';
    mSolicitante.value = '';
    mTecnico.value = '';
    mDescricao.value = '';
  },
  fecharModal(){ document.getElementById('modal').classList.remove('active'); },

  async carregarChamados(){
    try {
      const {data, error} = await supabaseClient.from('chamados').select('*').order('id',{ascending:false});
      if(error) return this.mostrarErro('Erro ao carregar chamados: ' + error.message);
      const tbody = document.getElementById('listaChamados'); tbody.innerHTML='';
      if(!data || data.length===0){tbody.innerHTML='<tr><td colspan="7">Nenhum chamado</td></tr>'; return;}
      data.forEach(c=>{
        tbody.innerHTML+=`<tr>
          <td>${c.id}</td>
          <td>${c.cliente}</td>
          <td>${c.solicitante}</td>
          <td>${c.tecnico}</td>
          <td style="cursor:pointer; text-decoration:underline;" onclick="app.abrirCronologia(${c.id})">${c.descricao}</td>
          <td><span class="status ${c.status}" onclick="app.toggle(${c.id},'${c.status}')">${c.status}</span></td>
          <td><button class="btn-danger" onclick="app.excluirChamado(${c.id})">üóëÔ∏è</button></td>
        </tr>`;
      });
    } catch(e){ this.mostrarErro('Erro: '+e.message); }
  },

  async salvarChamado(){
    if(!mCliente.value||!mSolicitante.value||!mTecnico.value||!mDescricao.value){alert('Preencha todos os campos!'); return;}
    try{
      const {data: clienteExistente} = await supabaseClient.from('clientes').select('*').eq('nome', mCliente.value).single();
      if(!clienteExistente){ await supabaseClient.from('clientes').insert({nome:mCliente.value}); }
      const {error} = await supabaseClient.from('chamados').insert({cliente:mCliente.value, solicitante:mSolicitante.value, tecnico:mTecnico.value, descricao:mDescricao.value, status:'pendente'});
      if(error) return this.mostrarErro('Erro ao salvar: '+error.message);
      this.fecharModal(); this.carregarChamados(); this.carregarClientes();
    }catch(e){ this.mostrarErro('Erro: '+e.message); }
  },

  async toggle(id,status){
    try{
      const novoStatus = status==='pendente'?'resolvido':'pendente';
      const {error} = await supabaseClient.from('chamados').update({status:novoStatus}).eq('id',id);
      if(error) return this.mostrarErro('Erro ao atualizar: '+error.message);
      this.carregarChamados(); this.relatorio();
    }catch(e){ this.mostrarErro('Erro: '+e.message); }
  },

  async excluirChamado(id){if(!confirm('Excluir este chamado?'))return;
    try{const {error} = await supabaseClient.from('chamados').delete().eq('id',id);
      if(error) return this.mostrarErro('Erro ao excluir: '+error.message);
      this.carregarChamados(); this.carregarClientes();
    }catch(e){this.mostrarErro('Erro: '+e.message);}
  },

  async carregarClientes(){
    try{
      const {data,error} = await supabaseClient.from('clientes').select('*'); if(error) return;
      const ul=document.getElementById('listaClientes'); ul.innerHTML='';
      if(!data||data.length===0){ul.innerHTML='<li>Nenhum cliente</li>'; return;}
      data.forEach(c=>{ul.innerHTML+=`<li>${c.nome} <button class="btn-danger" style="margin-left:5px;" onclick="app.excluirCliente('${c.nome}')">üóëÔ∏è</button></li>`});
    }catch(e){console.error(e);}
  },

  async excluirCliente(nome){
    try{
      const {data: chamadosVinculados} = await supabaseClient.from('chamados').select('*').eq('cliente', nome).limit(1);
      if(chamadosVinculados.length>0){alert('N√£o √© poss√≠vel excluir: existem chamados vinculados a este cliente.'); return;}
      if(!confirm(`Excluir o cliente "${nome}"?`)) return;
      const {error} = await supabaseClient.from('clientes').delete().eq('nome', nome);
      if(error) return this.mostrarErro('Erro ao excluir cliente: '+error.message);
      this.carregarClientes();
    }catch(e){this.mostrarErro('Erro: '+e.message);}
  },

  async relatorio(){
    try{
      let q = supabaseClient.from('chamados').select('*');
      if(fCliente.value) q = q.ilike('cliente','%'+fCliente.value+'%');
      if(fSolicitante.value) q = q.ilike('solicitante','%'+fSolicitante.value+'%');
      if(fTecnico.value) q = q.ilike('tecnico','%'+fTecnico.value+'%');
      if(fStatus.value) q = q.eq('status',fStatus.value);
      const {data,error} = await q; if(error) return this.mostrarErro('Erro no relat√≥rio: '+error.message);
      const tbody=document.getElementById('resultadoRelatorio'); tbody.innerHTML='';
      if(!data||data.length===0){tbody.innerHTML='<tr><td colspan="6">Nenhum resultado</td></tr>'; return;}
      data.forEach(c=>{
        tbody.innerHTML+=`<tr>
          <td>${c.id}</td><td>${c.cliente}</td><td>${c.solicitante}</td>
          <td>${c.tecnico}</td><td>${c.status}</td>
          <td><button class="btn" onclick="app.abrirCronologia(${c.id})">Ver Cronologia</button></td>
        </tr>`;
      });
    }catch(e){this.mostrarErro('Erro: '+e.message);}
  },

  abrirCronologia: async function(id){
    document.getElementById('modalCronologia').classList.add('active');
    document.getElementById('cronId').innerText=id;
    this.carregarCronologia(id);
  },

  fecharModalCronologia: function(){
    document.getElementById('modalCronologia').classList.remove('active');
    document.getElementById('novaAtualizacao').value='';
    document.getElementById('listaCronologia').innerHTML='';
  },

  carregarCronologia: async function(chamado_id){
    const {data,error} = await supabaseClient.from('cronologia_chamados').select('*').eq('chamado_id',chamado_id).order('data',{ascending:true});
    const lista=document.getElementById('listaCronologia'); lista.innerHTML='';
    if(error) return this.mostrarErro('Erro ao carregar cronologia: '+error.message);
    if(!data||data.length===0){lista.innerHTML='Nenhuma atualiza√ß√£o ainda.'; return;}
    data.forEach((c,i)=>{lista.innerHTML+=`<div class="${i===data.length-1?'ultimo':''}"><span>[${new Date(c.data).toLocaleString()}]</span>${c.descricao}</div>`});
  },

  salvarAtualizacao: async function(){
    const desc=document.getElementById('novaAtualizacao').value;
    const id=document.getElementById('cronId').innerText;
    if(!desc) return alert('Digite a atualiza√ß√£o');
    const {error}=await supabaseClient.from('cronologia_chamados').insert({chamado_id:id,descricao:desc});
    if(error) return this.mostrarErro('Erro ao salvar atualiza√ß√£o: '+error.message);
    document.getElementById('novaAtualizacao').value='';
    this.carregarCronologia(id);
  },

  async salvarConfig(){
    try{
      let {error}=await supabaseClient.from('configuracoes').update({empresa:confEmpresa.value,logo_url:confLogo.value}).eq('id',1);
      if(error && error.code==='PGRST116'){await supabaseClient.from('configuracoes').insert({id:1,empresa:confEmpresa.value,logo_url:confLogo.value});}
      this.carregarConfig();
    }catch(e){this.mostrarErro('Erro: '+e.message);}
  },

  async carregarConfig(){
    try{
      const {data} = await supabaseClient.from('configuracoes').select('*').eq('id',1).single();
      if(!data) return;
      nomeEmpresa.innerText=data.empresa||'Sistema';
      confEmpresa.value=data.empresa||'';
      confLogo.value=data.logo_url||'';
      if(data.logo_url){logoEmpresa.src=data.logo_url;logoEmpresa.classList.remove('hidden');}
    }catch(e){console.error(e);}
  },

  async init(){
    try{await supabaseClient.from('chamados').select('id').limit(1);}catch(e){this.mostrarErro('ERRO de conex√£o: '+e.message); return;}
    this.carregarChamados(); this.carregarClientes(); this.carregarConfig();
  }
};

app.init();
</script>

</body>
</html>
