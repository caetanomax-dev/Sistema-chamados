<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Implanta√ß√£o ERP</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        :root {
            --primary: #2563eb; --dark: #1e40af; --success: #10b981; --warning: #f59e0b;
            --danger: #ef4444; --info: #06b6d4; --phase1: #8b5cf6; --phase2: #ec4899;
            --phase3: #f59e0b; --phase4: #06b6d4; --phase5: #10b981;
            --bg: white; --bg2: #f9fafb; --text: #1f2937; --text2: #6b7280;
            --border: #e5e7eb; --card: white;
        }
        body.dark-mode {
            --bg: #0f172a; --bg2: #1e293b; --text: #f1f5f9; --text2: #94a3b8;
            --border: #334155; --card: #1e293b;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
            transition: background 0.3s ease, color 0.3s ease;
        }
        body.dark-mode {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .theme-toggle {
            position: fixed; top: 20px; right: 20px;
            background: var(--card); border: 1px solid var(--border);
            border-radius: 50%; width: 50px; height: 50px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); z-index: 999;
        }
        .theme-toggle:hover {
            transform: scale(1.1); box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .theme-icon { font-size: 24px; transition: transform 0.3s ease; }
        .theme-toggle:hover .theme-icon { transform: rotate(20deg); }
        header {
            background: var(--card); border-radius: 16px; padding: 30px;
            margin-bottom: 30px; box-shadow: 0 4px 6px rgba(0,0,0,0.07);
            border-left: 5px solid var(--primary); animation: slideDown 0.6s ease-out;
            transition: background 0.3s ease;
        }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        header h1 { font-size: 2.2em; margin-bottom: 10px; background: linear-gradient(135deg, var(--primary), var(--dark)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        header p { color: var(--text2); font-size: 0.95em; }
        .section {
            background: var(--card); border-radius: 16px; padding: 30px;
            margin-bottom: 30px; box-shadow: 0 4px 6px rgba(0,0,0,0.07);
            animation: fadeIn 0.6s ease-out; transition: background 0.3s ease;
        }
        .section h2 {
            font-size: 1.5em; margin-bottom: 25px; color: var(--text);
            border-bottom: 3px solid var(--primary); padding-bottom: 15px; display: inline-block;
        }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .form-group { display: flex; flex-direction: column; }
        label { font-weight: 600; margin-bottom: 8px; color: var(--text); font-size: 0.95em; }
        input[type="text"], input[type="date"], select, textarea {
            padding: 12px 15px; border: 2px solid var(--border); border-radius: 8px;
            font-size: 0.95em; font-family: inherit; background: var(--bg2);
            color: var(--text); transition: all 0.3s ease;
        }
        input:focus, select:focus, textarea:focus {
            outline: none; border-color: var(--primary);
            background: var(--card); box-shadow: 0 0 0 3px rgba(37,99,235,0.1);
        }
        .btn {
            padding: 12px 28px; border: none; border-radius: 8px;
            font-size: 0.95em; font-weight: 600; cursor: pointer;
            transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 0.5px;
            display: inline-block; margin-right: 10px; margin-bottom: 10px;
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--dark));
            color: white; width: 100%;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 15px rgba(37,99,235,0.3); }
        .btn-secondary { background: var(--info); color: white; }
        .btn-secondary:hover { background: #0891b2; transform: translateY(-2px); }
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover { background: #059669; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { background: #dc2626; }
        .btn-reset {
            background: var(--border); color: var(--text);
            margin-top: 20px; width: 100%;
        }
        body.dark-mode .btn-reset { background: #475569; color: #f1f5f9; }
        .button-group { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
        .projects-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .project-card {
            background: var(--card); padding: 20px; border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-left: 4px solid var(--primary); transition: all 0.3s ease;
        }
        .project-card:hover { box-shadow: 0 6px 16px rgba(0,0,0,0.12); transform: translateY(-2px); }
        .project-card h3 { font-size: 1.2em; margin-bottom: 10px; color: var(--text); }
        .project-card p { font-size: 0.9em; color: var(--text2); margin-bottom: 5px; }
        .project-card-buttons { display: flex; gap: 10px; margin-top: 15px; }
        .project-card-buttons button { flex: 1; padding: 8px 12px; font-size: 0.85em; }
        .progress-container { margin-bottom: 30px; }
        .progress-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .progress-header h3 { font-size: 1.1em; color: var(--text); margin-bottom: 0; border: none; }
        .progress-percentage { background: linear-gradient(135deg, var(--primary), var(--dark)); color: white; padding: 8px 16px; border-radius: 20px; font-weight: bold; font-size: 0.9em; }
        .progress-bar { width: 100%; height: 10px; background: var(--border); border-radius: 10px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary), var(--success)); border-radius: 10px; width: 0%; transition: width 0.4s ease; }
        .info-card { background: linear-gradient(135deg, var(--bg2), var(--card)); padding: 20px; border-radius: 12px; border-left: 4px solid var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: background 0.3s ease; }
        .info-card label { font-size: 0.85em; color: var(--text2); margin-bottom: 5px; }
        .info-card p { font-size: 1.1em; font-weight: 600; color: var(--text); }
        .client-info-display { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .timeline-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .timeline-item { padding: 20px; border-radius: 12px; border-left: 5px solid #8b5cf6; background: var(--card); box-shadow: 0 2px 8px rgba(0,0,0,0.08); transition: all 0.3s ease; }
        .timeline-item:hover { box-shadow: 0 6px 16px rgba(0,0,0,0.12); }
        .timeline-item h3 { font-size: 1.1em; margin-bottom: 8px; color: var(--text); }
        .timeline-dates { font-size: 0.85em; color: var(--text2); margin-bottom: 15px; font-weight: 500; }
        .phases-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 30px; margin-bottom: 30px; }
        .phase { border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.08); transition: all 0.3s ease; animation: fadeIn 0.6s ease-out; }
        .phase:hover { box-shadow: 0 8px 24px rgba(0,0,0,0.12); }
        .phase-header { padding: 20px; color: white; font-weight: 700; font-size: 1.1em; display: flex; justify-content: space-between; align-items: center; }
        .phase.phase-1 .phase-header { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
        .phase.phase-2 .phase-header { background: linear-gradient(135deg, #ec4899, #db2777); }
        .phase.phase-3 .phase-header { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .phase.phase-4 .phase-header { background: linear-gradient(135deg, #06b6d4, #0891b2); }
        .phase.phase-5 .phase-header { background: linear-gradient(135deg, #10b981, #059669); }
        .phase-counter { background: rgba(255,255,255,0.3); padding: 4px 10px; border-radius: 12px; font-size: 0.85em; font-weight: 600; }
        .phase-content { padding: 20px; background: var(--card); transition: background 0.3s ease; }
        .checklist { list-style: none; margin-bottom: 15px; }
        .checklist-item { display: block; margin-bottom: 12px; padding: 10px; border-radius: 8px; background: var(--bg2); transition: all 0.2s ease; }
        .checklist-item:hover { background: var(--border); }
        .checklist-item-row { display: flex; align-items: flex-start; margin-bottom: 8px; }
        .checklist-item input[type="checkbox"] { cursor: pointer; margin-right: 12px; margin-top: 4px; width: 18px; height: 18px; accent-color: var(--primary); flex-shrink: 0; }
        .checklist-item label { cursor: pointer; flex: 1; margin: 0; font-weight: 500; color: var(--text); }
        .checklist-item input[type="checkbox"]:checked + label { color: var(--text2); text-decoration: line-through; }
        .checklist-date-wrapper { padding-left: 30px; margin-top: 8px; }
        .checklist-date-label { font-size: 0.85em; color: var(--text2); font-weight: 600; margin-bottom: 5px; display: block; }
        .checklist-date input[type="date"] { width: 100%; padding: 8px 10px; font-size: 0.9em; border: 1px solid var(--primary); background: var(--card); color: var(--text); border-radius: 6px; cursor: pointer; }
        .status-badge { display: inline-block; padding: 6px 12px; border-radius: 20px; font-size: 0.8em; font-weight: 600; margin-top: 10px; }
        .status-completed { background: rgba(16,185,129,0.15); color: var(--success); }
        .status-in-progress { background: rgba(245,158,11,0.15); color: var(--warning); }
        .status-pending { background: rgba(239,68,68,0.15); color: var(--danger); }
        .chart-container { position: relative; height: 400px; margin: 30px 0; padding: 20px; background: var(--card); border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); transition: background 0.3s ease; }
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            animation: modalFadeIn 0.2s ease-out;
        }
        @keyframes modalFadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes modalSlideUp { from { opacity: 0; transform: translateY(24px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .modal-content {
            background: var(--card);
            margin: 4% auto;
            padding: 0;
            border-radius: 20px;
            width: 90%; max-width: 700px;
            box-shadow: 0 24px 64px rgba(0,0,0,0.25), 0 4px 16px rgba(0,0,0,0.1);
            max-height: 90vh; overflow: hidden;
            display: flex; flex-direction: column;
            transition: background 0.3s ease;
            animation: modalSlideUp 0.25s ease-out;
            border: 1px solid var(--border);
        }
        .modal-header {
            font-size: 1.25em; font-weight: 700;
            color: var(--text);
            padding: 24px 30px 20px;
            background: linear-gradient(135deg, var(--bg2), var(--card));
            border-bottom: 2px solid var(--border);
            border-radius: 20px 20px 0 0;
            display: flex; align-items: center; gap: 10px;
            letter-spacing: 0.01em;
        }
        .modal-header::before {
            content: '';
            display: block; width: 5px; height: 28px;
            background: linear-gradient(180deg, var(--primary), var(--dark));
            border-radius: 4px; flex-shrink: 0;
        }
        .modal-body {
            padding: 26px 30px;
            overflow-y: auto;
            flex: 1;
        }
        .edit-section {
            margin-bottom: 24px; padding-bottom: 24px;
            border-bottom: 1px solid var(--border);
        }
        .edit-section:last-child { border-bottom: none; margin-bottom: 0; }
        .edit-section h4 {
            margin-bottom: 16px; color: var(--text);
            font-size: 1em; font-weight: 700;
            padding: 10px 14px;
            background: linear-gradient(135deg, rgba(37,99,235,0.08), rgba(37,99,235,0.03));
            border-left: 3px solid var(--primary);
            border-radius: 0 8px 8px 0;
        }
        .edit-item {
            margin-bottom: 14px; padding: 14px 16px;
            background: var(--bg2); border-radius: 10px;
            border: 1px solid var(--border);
            transition: all 0.2s ease;
        }
        .edit-item:hover { border-color: var(--primary); box-shadow: 0 2px 8px rgba(37,99,235,0.08); }
        .edit-item-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 10px;
        }
        .edit-item-header span {
            font-size: 0.8em; font-weight: 700; color: var(--text2);
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .edit-item-fields { display: flex; flex-direction: column; gap: 10px; }
        .edit-item-fields input { padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 0.9em; background: var(--card); color: var(--text); }
        .modal-footer {
            display: flex; gap: 12px; justify-content: flex-end;
            padding: 18px 30px;
            border-top: 1px solid var(--border);
            background: var(--bg2);
            border-radius: 0 0 20px 20px;
        }
        .close-modal {
            background: transparent;
            color: var(--text2);
            padding: 10px 24px; border: 2px solid var(--border);
            border-radius: 8px; font-weight: 600; font-size: 0.9em;
            cursor: pointer; transition: all 0.2s ease;
            letter-spacing: 0.3px;
        }
        .close-modal:hover { background: var(--border); color: var(--text); }
        body.dark-mode .close-modal { border-color: #475569; color: #94a3b8; }
        body.dark-mode .close-modal:hover { background: #475569; color: #f1f5f9; }
        .save-modal {
            background: linear-gradient(135deg, var(--primary), var(--dark));
            color: white; padding: 10px 28px;
            border: none; border-radius: 8px;
            font-weight: 700; font-size: 0.9em;
            cursor: pointer; transition: all 0.25s ease;
            letter-spacing: 0.3px;
            box-shadow: 0 2px 8px rgba(37,99,235,0.25);
        }
        .save-modal:hover { transform: translateY(-2px); box-shadow: 0 6px 18px rgba(37,99,235,0.35); }
        @media (max-width: 768px) { .theme-toggle { top: 80px; } .form-grid, .timeline-container, .phases-container, .client-info-display { grid-template-columns: 1fr; } .button-group { flex-direction: column; } .button-group .btn { width: 100%; margin-right: 0; } .modal-content { width: 95%; margin: 20% auto; padding: 20px; max-height: 85vh; } .modal-footer { padding: 15px 0 0 0; } .modal-footer button { font-size: 0.85em; padding: 10px 16px; } .chart-container { height: 300px; } .project-card-buttons { flex-direction: column; } }
    </style>
</head>
<body>
    <div id="themeToggle" class="theme-toggle" title="Alternar tema claro/escuro">
        <span class="theme-icon">üåô</span>
    </div>

    <div class="container">
        <header>
            <h1>üìä Painel de Implanta√ß√£o ERP</h1>
            <p>Customiza√ß√£o completa de cronograma e checklists de implementa√ß√£o</p>
        </header>

        <section class="section" id="projectsSection">
            <h2>Meus Projetos</h2>
            <div class="projects-list" id="projectsList"></div>
            <hr style="margin: 30px 0; border: none; border-top: 1px solid var(--border);">
            <h2 style="margin-top: 30px;">Novo Projeto</h2>
        </section>

        <section class="section">
            <h2>Informa√ß√µes do Cliente</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label for="clientName">Nome do Cliente</label>
                    <input type="text" id="clientName" placeholder="Digite o nome da empresa">
                </div>
                <div class="form-group">
                    <label for="startDate">Data de In√≠cio</label>
                    <input type="date" id="startDate">
                </div>
                <div class="form-group">
                    <label for="responsible">Respons√°vel pela Implanta√ß√£o</label>
                    <input type="text" id="responsible" placeholder="Nome do respons√°vel">
                </div>
            </div>
            <button class="btn btn-primary" onclick="initializeProject()">Iniciar Projeto</button>
            <button class="btn btn-reset" onclick="resetProject()">Limpar</button>
        </section>

        <section class="section" id="projectSection" style="display: none;">
            <h2>Resumo do Projeto</h2>
            <div class="client-info-display">
                <div class="info-card">
                    <label>Cliente</label>
                    <p id="displayClientName">-</p>
                </div>
                <div class="info-card">
                    <label>Data de In√≠cio</label>
                    <p id="displayStartDate">-</p>
                </div>
                <div class="info-card">
                    <label>Respons√°vel</label>
                    <p id="displayResponsible">-</p>
                </div>
            </div>
            <div class="button-group">
                <button class="btn btn-success" onclick="printPDF()">üñ®Ô∏è Imprimir PDF</button>
                <button class="btn btn-success" onclick="saveProject()">üíæ Salvar Projeto</button>
                <button class="btn btn-danger" onclick="backToProjects()">‚Üê Voltar Projetos</button>
            </div>
        </section>

        <section class="section" id="progressSection" style="display: none;">
            <h2>Progresso Geral</h2>
            <div class="progress-container">
                <div class="progress-header">
                    <h3>Conclus√£o do Projeto</h3>
                    <span class="progress-percentage"><span id="progressPercentage">0</span>%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>
        </section>

        <section class="section" id="chartSection" style="display: none;">
            <h2>Gr√°fico de Entrega dos Processos</h2>
            <div class="chart-container">
                <canvas id="deliveryChart"></canvas>
            </div>
        </section>

        <section class="section" id="timelineSection" style="display: none;">
            <h2>Cronograma de Implanta√ß√£o</h2>
            <div style="margin-bottom: 20px;">
                <button class="btn btn-secondary" onclick="openTimelineEditor()">‚úèÔ∏è Editar Cronograma</button>
                <button class="btn btn-success" onclick="openNewTimelineEntry()" style="width: auto;">+ Nova Etapa</button>
            </div>
            <div class="timeline-container" id="timelineContainer"></div>
        </section>

        <section class="section" id="checklistsSection" style="display: none;">
            <h2>Checklists por Fase</h2>
            <div style="margin-bottom: 20px;">
                <button class="btn btn-secondary" onclick="openChecklistEditor()">‚úèÔ∏è Editar Checklists</button>
                <button class="btn btn-success" onclick="addNewPhase()" style="width: auto;">+ Nova Fase</button>
            </div>
            <div class="phases-container" id="phasesContainer"></div>
        </section>
    </div>

    <div id="timelineModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">‚úèÔ∏è Editar Cronograma</div>
            <div class="modal-body" id="timelineModalBody"></div>
            <div class="modal-footer">
                <button class="close-modal" onclick="closeTimelineEditor()">‚úï Cancelar</button>
                <button class="save-modal" onclick="saveTimelineChanges()">üíæ Salvar Altera√ß√µes</button>
            </div>
        </div>
    </div>

    <div id="newTimelineModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">‚ûï Nova Etapa na Cronologia</div>
            <div class="modal-body">
                <div class="form-group" style="margin-bottom: 18px;">
                    <label>T√≠tulo da Etapa</label>
                    <input type="text" id="newTimeline_title" placeholder="Ex: Valida√ß√£o Final">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 18px;">
                    <div class="form-group">
                        <label>Data In√≠cio</label>
                        <input type="date" id="newTimeline_start">
                    </div>
                    <div class="form-group">
                        <label>Data Fim</label>
                        <input type="date" id="newTimeline_end">
                    </div>
                </div>
                <div class="form-group">
                    <label>Descri√ß√£o <span style="font-weight:400; color:var(--text2);">(opcional)</span></label>
                    <textarea id="newTimeline_description" rows="3" placeholder="Detalhes sobre esta etapa..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="close-modal" onclick="document.getElementById('newTimelineModal').style.display='none'">‚úï Cancelar</button>
                <button class="save-modal" onclick="saveNewTimelineEntry()">üíæ Salvar Etapa</button>
            </div>
        </div>
    </div>

    <div id="checklistModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">‚úèÔ∏è Editar Checklists</div>
            <div class="modal-body" id="checklistModalBody"></div>
            <div class="modal-footer">
                <button class="close-modal" onclick="closeChecklistEditor()">‚úï Cancelar</button>
                <button class="save-modal" onclick="saveChecklistChanges()">üíæ Salvar Altera√ß√µes</button>
            </div>
        </div>
    </div>

    <!-- =====================================================================
         ALTERA√á√ÉO DE ARMAZENAMENTO: Supabase Client SDK
         Substitui√ß√£o: localStorage ‚Üí Supabase
         ===================================================================== -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // =====================================================================
        // CONFIGURA√á√ÉO SUPABASE ‚Äî altere apenas SUPABASE_URL e SUPABASE_ANON_KEY
        // =====================================================================
        const SUPABASE_URL  = 'https://SEU_PROJETO.supabase.co';       // <- substitua
        const SUPABASE_ANON_KEY = 'SUA_CHAVE_ANONIMA_AQUI';            // <- substitua

        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // =====================================================================
        // FUN√á√ïES INTERNAS DE PERSIST√äNCIA (substituem localStorage para projetos)
        // Todas as chamadas externas continuam id√™nticas ‚Äî apenas o mecanismo mudou
        // =====================================================================

        /**
         * Busca todos os projetos do Supabase e retorna no mesmo formato
         * que localStorage.getItem('allProjects') retornava: { [id]: project }
         */
        async function _dbGetAllProjects() {
            const { data, error } = await _supabase
                .from('erp_projects')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) { console.error('Supabase getAll error:', error); return {}; }

            const result = {};
            (data || []).forEach(row => {
                result[row.project_id] = {
                    id:               row.project_id,
                    clientName:       row.client_name,
                    startDate:        row.start_date,
                    responsible:      row.responsible,
                    dates:            row.dates            || {},
                    phases:           row.phases           || [],
                    weeks:            row.weeks            || [],
                    checklistStates:  row.checklist_states || {},
                    checklistDates:   row.checklist_dates  || {},
                    checklistNotes:   row.checklist_notes  || {},
                    createdAt:        row.created_at,
                    savedAt:          row.saved_at
                };
            });
            return result;
        }

        /**
         * Salva (upsert) um projeto no Supabase.
         * Recebe o mesmo objeto que antes ia para localStorage.
         */
        async function _dbSaveProject(projectData) {
            const row = {
                project_id:       projectData.id,
                client_name:      projectData.clientName,
                start_date:       projectData.startDate,
                responsible:      projectData.responsible,
                dates:            projectData.dates            || {},
                phases:           projectData.phases           || [],
                weeks:            projectData.weeks            || [],
                checklist_states: projectData.checklistStates || {},
                checklist_dates:  projectData.checklistDates  || {},
                checklist_notes:  projectData.checklistNotes  || {},
                saved_at:         projectData.savedAt
            };

            const { error } = await _supabase
                .from('erp_projects')
                .upsert(row, { onConflict: 'project_id' });

            if (error) { console.error('Supabase save error:', error); return false; }
            return true;
        }

        /**
         * Exclui um projeto do Supabase pelo ID.
         */
        async function _dbDeleteProject(projectId) {
            const { error } = await _supabase
                .from('erp_projects')
                .delete()
                .eq('project_id', projectId);

            if (error) { console.error('Supabase delete error:', error); return false; }
            return true;
        }
        // =====================================================================
        // FIM DAS FUN√á√ïES INTERNAS DE PERSIST√äNCIA
        // =====================================================================
    </script>
    <!-- FIM DA ALTERA√á√ÉO DE ARMAZENAMENTO -->

    <script>
        function initDarkMode() {
            const isDarkMode = localStorage.getItem('darkMode') === 'true';
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
                document.querySelector('.theme-icon').textContent = '‚òÄÔ∏è';
            }
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const isDarkMode = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDarkMode);
            document.querySelector('.theme-icon').textContent = isDarkMode ? '‚òÄÔ∏è' : 'üåô';
        }

        document.getElementById('themeToggle').addEventListener('click', toggleTheme);
        document.addEventListener('DOMContentLoaded', initDarkMode);

        const defaultPhases = [
            {id: 'phase-1', name: 'Diagn√≥stico', phaseNumber: '1', items: ['Checklist opera√ß√£o preenchido', 'Infraestrutura validada', 'Equipamentos confirmados', 'Convers√£o alinhada', 'Certificado digital solicitado', 'TEF validado']},
            {id: 'phase-2', name: 'Prepara√ß√£o', phaseNumber: '2', items: ['Treinamento cadastro realizado', 'Produtos cadastrados', 'Pre√ßos definidos', 'Etiquetas prontas', 'Dados revisados']},
            {id: 'phase-3', name: 'Instala√ß√£o', phaseNumber: '3', items: ['Atualiza√ß√£o final de dados', 'Instala√ß√£o dos caixas', 'Testes realizados', 'Treinamento operadores', 'Go Live realizado']},
            {id: 'phase-4', name: 'Consolida√ß√£o', phaseNumber: '4', items: ['Treinamento Comercial', 'Treinamento Financeiro', 'Treinamento Fiscal', 'D√∫vidas resolvidas']},
            {id: 'phase-5', name: 'Entrega', phaseNumber: '5', items: ['Cliente operando sozinho', 'Pend√™ncias resolvidas', 'Formaliza√ß√£o de entrega', 'Encaminhado para suporte']}
        ];

        const defaultWeeks = [
            {id: 'week1', title: 'Diagn√≥stico e Planejamento', phaseNumber: '1'},
            {id: 'week2', title: 'Prepara√ß√£o e Cadastros', phaseNumber: '2'},
            {id: 'week3', title: 'Instala√ß√£o e Go Live', phaseNumber: '3'},
            {id: 'week4', title: 'Treinamentos Estrat√©gicos e Entrega', phaseNumber: '4'}
        ];

        let phases = JSON.parse(JSON.stringify(defaultPhases));
        let weeks = JSON.parse(JSON.stringify(defaultWeeks));
        let currentProjectId = null;
        let currentProjectData = null;
        let deliveryChart = null;

        function initializeProject() {
            const clientName = document.getElementById('clientName').value.trim();
            const startDate = document.getElementById('startDate').value;
            const responsible = document.getElementById('responsible').value.trim();

            if (!clientName || !startDate || !responsible) {
                alert('Por favor, preencha todos os campos!');
                return;
            }

            const defaultDates = generateDefaultDates(startDate);
            currentProjectId = Date.now().toString();

            currentProjectData = {
                id: currentProjectId,
                clientName,
                startDate,
                responsible,
                dates: defaultDates,
                phases: JSON.parse(JSON.stringify(defaultPhases)),
                weeks: JSON.parse(JSON.stringify(defaultWeeks)),
                checklistStates: {},
                checklistDates: {},
                createdAt: new Date().toLocaleString('pt-BR')
            };

            phases = JSON.parse(JSON.stringify(currentProjectData.phases));
            weeks = JSON.parse(JSON.stringify(currentProjectData.weeks));

            document.getElementById('projectSection').style.display = 'block';
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('chartSection').style.display = 'block';
            document.getElementById('timelineSection').style.display = 'block';
            document.getElementById('checklistsSection').style.display = 'block';
            document.getElementById('projectsSection').style.display = 'none';

            displayProjectInfo(clientName, startDate, responsible);
            renderTimeline(currentProjectData.dates);
            renderChecklists();
            updateProgress();
            renderDeliveryChart();
        }

        function generateDefaultDates(startDateStr) {
            const startDate = new Date(startDateStr);
            const dates = {};

            for (let week = 1; week <= 4; week++) {
                const weekStart = new Date(startDate);
                weekStart.setDate(weekStart.getDate() + (week - 1) * 7);
                
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekEnd.getDate() + 6);

                dates[`week${week}`] = {
                    start: weekStart.toISOString().split('T')[0],
                    end: weekEnd.toISOString().split('T')[0]
                };
            }

            return dates;
        }

        function displayProjectInfo(clientName, startDate, responsible) {
            document.getElementById('displayClientName').textContent = clientName;
            document.getElementById('displayStartDate').textContent = formatDate(startDate);
            document.getElementById('displayResponsible').textContent = responsible;
        }

        function renderTimeline(dates) {
            const container = document.getElementById('timelineContainer');
            container.innerHTML = '';

            weeks.forEach((week) => {
                const div = document.createElement('div');
                div.className = `timeline-item`;
                
                const weekDates = dates[week.id] || {};
                const dateStr = weekDates.start ? 
                    `${formatDate(weekDates.start)} at√© ${formatDate(weekDates.end)}` : 
                    'Sem datas definidas';

                let extra = '';
                if (week.description) extra = `<p style="font-size:0.88em; color:var(--text2); margin-top:8px;">${week.description}</p>`;
                const deleteBtn = `<button class="btn btn-danger" onclick="removeTimelineEntry('${week.id}')" style="padding:4px 10px; font-size:0.8em; margin-top:10px; width:auto;">‚úï Remover</button>`;

                div.innerHTML = `<h3>${week.title}</h3><div class="timeline-dates">${dateStr}</div>${extra}${deleteBtn}`;
                container.appendChild(div);
            });
        }

        function renderChecklists() {
            const container = document.getElementById('phasesContainer');
            container.innerHTML = '';

            phases.forEach(phase => {
                const phaseDiv = document.createElement('div');
                phaseDiv.className = `phase phase-${phase.phaseNumber}`;
                phaseDiv.id = phase.id;

                const header = document.createElement('div');
                header.className = 'phase-header';
                header.innerHTML = `<span>Fase ${phase.phaseNumber}: ${phase.name}</span><span class="phase-counter"><span class="checked-count">0</span>/<span class="total-count">${phase.items.length}</span></span>`;

                const content = document.createElement('div');
                content.className = 'phase-content';

                const checklist = document.createElement('ul');
                checklist.className = 'checklist';

                phase.items.forEach((item, itemIndex) => {
                    const itemId = `${phase.id}-item-${itemIndex}`;
                    const li = document.createElement('li');
                    li.className = 'checklist-item';

                    const itemRow = document.createElement('div');
                    itemRow.className = 'checklist-item-row';

                    const input = document.createElement('input');
                    input.type = 'checkbox';
                    input.id = itemId;
                    input.onchange = () => {
                        saveChecklistState(phase.id, itemIndex, input.checked);
                        updateProgress();
                        updatePhaseCounter(phase.id);
                        renderDeliveryChart();
                        
                        // Mostrar/esconder campo de data
                        const wrapper = li.querySelector('.checklist-date-wrapper');
                        if (wrapper) {
                            wrapper.style.display = input.checked ? 'block' : 'none';
                        }
                    };

                    const label = document.createElement('label');
                    label.htmlFor = itemId;
                    label.textContent = item;

                    itemRow.appendChild(input);
                    itemRow.appendChild(label);
                    li.appendChild(itemRow);

                    const dateWrapper = document.createElement('div');
                    dateWrapper.className = 'checklist-date-wrapper';

                    const dateLabel = document.createElement('label');
                    dateLabel.className = 'checklist-date-label';
                    dateLabel.textContent = 'Data de conclus√£o:';

                    const dateInput = document.createElement('input');
                    dateInput.type = 'date';
                    dateInput.className = 'checklist-date';
                    dateInput.id = `date-${itemId}`;
                    dateInput.onchange = () => {
                        saveChecklistDate(phase.id, itemIndex, dateInput.value);
                    };

                    dateWrapper.appendChild(dateLabel);
                    dateWrapper.appendChild(dateInput);
                    li.appendChild(dateWrapper);

                    // Campo de observa√ß√£o
                    const noteWrapper = document.createElement('div');
                    noteWrapper.style.cssText = 'padding-left: 30px; margin-top: 6px;';
                    const noteInput = document.createElement('textarea');
                    noteInput.placeholder = 'Observa√ß√£o...';
                    noteInput.rows = 2;
                    noteInput.style.cssText = 'width: 100%; padding: 8px 10px; font-size: 0.85em; border: 1px solid var(--border); border-radius: 6px; background: var(--card); color: var(--text); font-family: inherit; resize: vertical; min-height: 52px; line-height: 1.5; overflow-wrap: break-word; word-break: break-word;';
                    noteInput.id = `note-${itemId}`;
                    // Carregar nota salva
                    if (currentProjectData.checklistNotes && currentProjectData.checklistNotes[phase.id] && currentProjectData.checklistNotes[phase.id][itemIndex] !== undefined) {
                        noteInput.value = currentProjectData.checklistNotes[phase.id][itemIndex];
                    }
                    noteInput.oninput = () => { saveChecklistNote(phase.id, itemIndex, noteInput.value); };
                    noteWrapper.appendChild(noteInput);
                    li.appendChild(noteWrapper);

                    checklist.appendChild(li);
                });

                content.appendChild(checklist);

                const statusBadge = document.createElement('div');
                statusBadge.className = 'status-badge status-pending';
                statusBadge.textContent = 'N√£o iniciado';
                statusBadge.id = `status-${phase.id}`;
                content.appendChild(statusBadge);

                phaseDiv.appendChild(header);
                phaseDiv.appendChild(content);

                container.appendChild(phaseDiv);
            });

            loadChecklistStates();
        }

        function updatePhaseCounter(phaseId) {
            const phaseElement = document.getElementById(phaseId);
            const checkedItems = phaseElement.querySelectorAll('input[type="checkbox"]:checked').length;
            const totalItems = phaseElement.querySelectorAll('input[type="checkbox"]').length;
            
            const counter = phaseElement.querySelector('.phase-counter');
            counter.innerHTML = `<span class="checked-count">${checkedItems}</span>/<span class="total-count">${totalItems}</span>`;

            const statusBadge = phaseElement.querySelector(`#status-${phaseId}`);
            if (checkedItems === 0) {
                statusBadge.className = 'status-badge status-pending';
                statusBadge.textContent = 'N√£o iniciado';
            } else if (checkedItems === totalItems) {
                statusBadge.className = 'status-badge status-completed';
                statusBadge.textContent = 'Conclu√≠do ‚úì';
            } else {
                statusBadge.className = 'status-badge status-in-progress';
                statusBadge.textContent = 'Em progresso...';
            }
        }

        function updateProgress() {
            let totalItems = 0;
            let checkedItems = 0;

            phases.forEach(phase => {
                const phaseElement = document.getElementById(phase.id);
                if (phaseElement) {
                    const checkboxes = phaseElement.querySelectorAll('input[type="checkbox"]');
                    const checkedCheckboxes = phaseElement.querySelectorAll('input[type="checkbox"]:checked');
                    
                    totalItems += checkboxes.length;
                    checkedItems += checkedCheckboxes.length;
                }
            });

            const percentage = totalItems > 0 ? Math.round((checkedItems / totalItems) * 100) : 0;
            document.getElementById('progressPercentage').textContent = percentage;
            document.getElementById('progressFill').style.width = percentage + '%';
        }

        function saveChecklistState(phaseId, itemIndex, checked) {
            if (!currentProjectData.checklistStates) currentProjectData.checklistStates = {};
            if (!currentProjectData.checklistStates[phaseId]) currentProjectData.checklistStates[phaseId] = {};
            currentProjectData.checklistStates[phaseId][itemIndex] = checked;
        }

        function saveChecklistDate(phaseId, itemIndex, date) {
            if (!currentProjectData.checklistDates) currentProjectData.checklistDates = {};
            if (!currentProjectData.checklistDates[phaseId]) currentProjectData.checklistDates[phaseId] = {};
            currentProjectData.checklistDates[phaseId][itemIndex] = date;
        }

        function loadChecklistStates() {
            if (!currentProjectData || !currentProjectData.checklistStates) return;
            
            Object.keys(currentProjectData.checklistStates).forEach(phaseId => {
                Object.keys(currentProjectData.checklistStates[phaseId]).forEach(itemIndex => {
                    const itemId = `${phaseId}-item-${itemIndex}`;
                    const checkbox = document.getElementById(itemId);
                    if (checkbox) {
                        checkbox.checked = currentProjectData.checklistStates[phaseId][itemIndex];
                        
                        // Mostrar/esconder campo de data quando carregar
                        const li = checkbox.closest('.checklist-item');
                        if (li) {
                            const wrapper = li.querySelector('.checklist-date-wrapper');
                            if (wrapper) {
                                wrapper.style.display = checkbox.checked ? 'block' : 'none';
                            }
                        }
                    }
                    
                    const dateInput = document.getElementById(`date-${itemId}`);
                    if (dateInput && currentProjectData.checklistDates && currentProjectData.checklistDates[phaseId] && currentProjectData.checklistDates[phaseId][itemIndex]) {
                        dateInput.value = currentProjectData.checklistDates[phaseId][itemIndex];
                    }
                });
                updatePhaseCounter(phaseId);
            });
            updateProgress();
        }

        function renderDeliveryChart() {
            const chartData = [];
            const labels = [];
            const colors = ['#8b5cf6', '#ec4899', '#f59e0b', '#06b6d4', '#10b981'];

            phases.forEach((phase, index) => {
                const phaseElement = document.getElementById(phase.id);
                const checkedItems = phaseElement.querySelectorAll('input[type="checkbox"]:checked').length;
                const totalItems = phaseElement.querySelectorAll('input[type="checkbox"]').length;
                const percentage = totalItems > 0 ? Math.round((checkedItems / totalItems) * 100) : 0;

                labels.push(`Fase ${phase.phaseNumber}: ${phase.name}`);
                chartData.push(percentage);
            });

            const canvas = document.getElementById('deliveryChart');
            
            if (deliveryChart) deliveryChart.destroy();

            deliveryChart = new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Progresso da Entrega (%)',
                        data: chartData,
                        backgroundColor: colors,
                        borderColor: colors,
                        borderWidth: 2,
                        borderRadius: 8,
                        barThickness: 40
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: { font: { size: 12 } }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        function openTimelineEditor() {
            const modalBody = document.getElementById('timelineModalBody');
            modalBody.innerHTML = '';

            weeks.forEach((week) => {
                const dates = currentProjectData.dates[week.id] || {};
                
                const section = document.createElement('div');
                section.className = 'edit-section';
                section.innerHTML = `
                    <h4>${week.title}</h4>
                    <div style="margin-bottom: 14px;">
                        <label style="font-weight: 600; margin-bottom: 6px; display: block; font-size:0.9em; color:var(--text);">T√≠tulo da Etapa</label>
                        <input type="text" id="edit_${week.id}_title" value="${week.title}" style="width: 100%;">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 14px;">
                        <div>
                            <label style="font-weight: 600; margin-bottom: 6px; display: block; font-size:0.9em; color:var(--text);">üìÖ Data In√≠cio</label>
                            <input type="date" id="edit_${week.id}_start" value="${dates.start || ''}" style="width: 100%;">
                        </div>
                        <div>
                            <label style="font-weight: 600; margin-bottom: 6px; display: block; font-size:0.9em; color:var(--text);">üìÖ Data Fim</label>
                            <input type="date" id="edit_${week.id}_end" value="${dates.end || ''}" style="width: 100%;">
                        </div>
                    </div>`;

                modalBody.appendChild(section);
            });

            document.getElementById('timelineModal').style.display = 'block';
        }

        function closeTimelineEditor() {
            document.getElementById('timelineModal').style.display = 'none';
        }

        function saveTimelineChanges() {
            const newDates = {};

            weeks.forEach(week => {
                const start = document.getElementById(`edit_${week.id}_start`).value;
                const end = document.getElementById(`edit_${week.id}_end`).value;
                const title = document.getElementById(`edit_${week.id}_title`).value;

                if (!start || !end || !title) {
                    alert('Por favor, preencha todos os campos!');
                    return;
                }

                if (new Date(start) > new Date(end)) {
                    alert(`${week.title}: Data de in√≠cio n√£o pode ser maior que fim!`);
                    return;
                }

                newDates[week.id] = { start, end };
                week.title = title;
            });

            currentProjectData.dates = newDates;
            currentProjectData.weeks = weeks;
            renderTimeline(newDates);
            closeTimelineEditor();
        }

        function openChecklistEditor() {
            const modalBody = document.getElementById('checklistModalBody');
            modalBody.innerHTML = '';

            phases.forEach(phase => {
                const section = document.createElement('div');
                section.className = 'edit-section';
                
                let itemsHtml = '';
                phase.items.forEach((item, itemIndex) => {
                    const noteVal = (currentProjectData.checklistNotes && currentProjectData.checklistNotes[phase.id] && currentProjectData.checklistNotes[phase.id][itemIndex]) ? currentProjectData.checklistNotes[phase.id][itemIndex] : '';
                    itemsHtml += `
                        <div class="edit-item">
                            <div class="edit-item-header">
                                <span>Item ${itemIndex + 1}</span>
                                <button onclick="removeChecklistItem('${phase.id}', ${itemIndex})" title="Remover item" style="background:none; border:1px solid var(--border); border-radius:6px; padding:4px 7px; cursor:pointer; color:var(--danger); font-size:0.95em; line-height:1; transition:all 0.2s ease;" onmouseover="this.style.background='rgba(239,68,68,0.1)'; this.style.borderColor='var(--danger)'" onmouseout="this.style.background='none'; this.style.borderColor='var(--border)'">üóë</button>
                            </div>
                            <label style="font-size:0.82em; font-weight:700; color:var(--text2); text-transform:uppercase; letter-spacing:0.4px; display:block; margin-bottom:5px;">Descri√ß√£o do item</label>
                            <input type="text" id="edit_phase_${phase.id}_item_${itemIndex}" value="${item}" style="width: 100%; margin-bottom: 10px;">
                            <label style="font-size:0.82em; font-weight:700; color:var(--text2); text-transform:uppercase; letter-spacing:0.4px; display:block; margin-bottom:5px;">üí¨ Observa√ß√£o</label>
                            <input type="text" id="edit_phase_${phase.id}_note_${itemIndex}" value="${noteVal.replace(/"/g, '&quot;')}" placeholder="Observa√ß√£o sobre este item..." style="width: 100%; font-size:0.9em;">
                        </div>`;
                });

                section.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                        <h4 style="margin:0;">Fase ${phase.phaseNumber}: ${phase.name}</h4>
                        <button class="btn btn-danger" onclick="removePhase('${phase.id}')" style="padding:6px 14px; font-size:0.8em; width:auto; margin:0;">üóë Excluir Fase</button>
                    </div>
                    <div style="margin-bottom: 16px;">
                        <label style="font-weight: 700; margin-bottom: 6px; display: block; font-size:0.9em; color:var(--text);">Nome da Fase</label>
                        <input type="text" id="edit_phase_${phase.id}_name" value="${phase.name}" style="width: 100%;">
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="font-weight: 700; margin-bottom: 10px; display: block; font-size:0.9em; color:var(--text);">Itens do Checklist</label>
                        ${itemsHtml}
                    </div>
                    <button class="btn btn-success" onclick="addChecklistItem('${phase.id}')" style="width: 100%; margin-top: 6px; padding: 10px; font-size:0.9em;">+ Adicionar Item</button>`;

                modalBody.appendChild(section);
            });

            document.getElementById('checklistModal').style.display = 'block';
        }

        function closeChecklistEditor() {
            document.getElementById('checklistModal').style.display = 'none';
        }

        function flushChecklistEditorState() {
            // Salva o que est√° digitado no modal antes de reabrir
            phases.forEach(phase => {
                const nameInput = document.getElementById(`edit_phase_${phase.id}_name`);
                if (nameInput && nameInput.value.trim()) phase.name = nameInput.value.trim();
                if (!currentProjectData.checklistNotes) currentProjectData.checklistNotes = {};
                if (!currentProjectData.checklistNotes[phase.id]) currentProjectData.checklistNotes[phase.id] = {};
                phase.items = phase.items.map((item, index) => {
                    const input = document.getElementById(`edit_phase_${phase.id}_item_${index}`);
                    const noteInput = document.getElementById(`edit_phase_${phase.id}_note_${index}`);
                    if (noteInput) currentProjectData.checklistNotes[phase.id][index] = noteInput.value;
                    return input ? (input.value || item) : item;
                });
            });
        }

        function addChecklistItem(phaseId) {
            flushChecklistEditorState();
            const phase = phases.find(p => p.id === phaseId);
            if (phase) {
                phase.items.push('Novo item');
                openChecklistEditor();
            }
        }

        function removeChecklistItem(phaseId, itemIndex) {
            if (!confirm('Deseja remover este item?')) return;
            flushChecklistEditorState();
            const phase = phases.find(p => p.id === phaseId);
            if (phase) {
                phase.items.splice(itemIndex, 1);
                // Reindexar notas da fase
                if (currentProjectData.checklistNotes && currentProjectData.checklistNotes[phaseId]) {
                    const notes = currentProjectData.checklistNotes[phaseId];
                    const newNotes = {};
                    Object.keys(notes).forEach(k => {
                        const ki = parseInt(k);
                        if (ki < itemIndex) newNotes[ki] = notes[k];
                        else if (ki > itemIndex) newNotes[ki - 1] = notes[k];
                    });
                    currentProjectData.checklistNotes[phaseId] = newNotes;
                }
                openChecklistEditor();
            }
        }

        function saveChecklistChanges() {
            if (!currentProjectData.checklistNotes) currentProjectData.checklistNotes = {};

            phases.forEach(phase => {
                const nameInput = document.getElementById(`edit_phase_${phase.id}_name`);
                if (!nameInput) return;
                const newName = nameInput.value;
                if (!newName) { alert('Nome da fase n√£o pode estar vazio!'); return; }
                phase.name = newName;

                if (!currentProjectData.checklistNotes[phase.id]) currentProjectData.checklistNotes[phase.id] = {};

                phase.items = phase.items.map((item, index) => {
                    const newValue = document.getElementById(`edit_phase_${phase.id}_item_${index}`).value;
                    if (!newValue) { alert('Itens n√£o podem estar vazios!'); return null; }

                    const noteInput = document.getElementById(`edit_phase_${phase.id}_note_${index}`);
                    if (noteInput) currentProjectData.checklistNotes[phase.id][index] = noteInput.value;

                    return newValue;
                }).filter(item => item !== null);
            });

            currentProjectData.phases = phases;
            renderChecklists();
            renderDeliveryChart();
            closeChecklistEditor();
        }

        // ALTERA√á√ÉO DE ARMAZENAMENTO: localStorage ‚Üí Supabase
        async function saveProject() {
            if (!currentProjectId) {
                alert('Nenhum projeto em edi√ß√£o!');
                return;
            }

            currentProjectData.phases  = phases;
            currentProjectData.weeks   = weeks;
            currentProjectData.savedAt = new Date().toLocaleString('pt-BR');

            // ANTES: localStorage.setItem('allProjects', ...)
            // AGORA:  _dbSaveProject salva/atualiza no Supabase
            const ok = await _dbSaveProject(currentProjectData);
            if (!ok) { alert('Erro ao salvar no banco de dados. Verifique o console.'); return; }

            alert('‚úì Projeto salvo com sucesso!');
            backToProjects();
        }

        function printPDF() {
            const clientName = document.getElementById('displayClientName').textContent;
            const responsible = document.getElementById('displayResponsible').textContent;
            const startDate = document.getElementById('displayStartDate').textContent;
            const percentage = document.getElementById('progressPercentage').textContent;

            let styles = '<style>* { margin: 0; padding: 0; box-sizing: border-box; } body { font-family: Segoe UI, Arial, sans-serif; background: white; color: #333; line-height: 1.6; padding: 40px 30px; } .container { max-width: 950px; margin: 0 auto; } .header-top { text-align: center; margin-bottom: 40px; border-bottom: 3px solid #2563eb; padding-bottom: 25px; } .header-top h1 { color: #2563eb; font-size: 32px; margin-bottom: 5px; font-weight: 700; } .header-top p { color: #6b7280; font-size: 14px; } .info-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 35px; } .info-card { background: linear-gradient(135deg, #f3f4f6 0%, #ffffff 100%); padding: 20px; border-left: 5px solid #2563eb; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); } .info-card label { font-weight: 700; color: #6b7280; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-bottom: 8px; } .info-card p { color: #1f2937; font-size: 15px; font-weight: 600; } .progress-section { background: #f9fafb; padding: 25px; border-radius: 8px; margin-bottom: 35px; border: 1px solid #e5e7eb; } .progress-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; } .progress-header h3 { font-size: 16px; color: #1f2937; font-weight: 600; margin: 0; } .progress-percentage { background: linear-gradient(135deg, #2563eb, #1e40af); color: white; padding: 10px 20px; border-radius: 25px; font-weight: 700; font-size: 18px; } .progress-bar { width: 100%; height: 12px; background: #e5e7eb; border-radius: 10px; overflow: hidden; } .progress-fill { height: 100%; background: linear-gradient(90deg, #2563eb, #10b981); border-radius: 10px; width: ' + percentage + '%; } .section-title { font-size: 18px; font-weight: 700; color: #1f2937; border-bottom: 2px solid #2563eb; padding-bottom: 12px; margin: 35px 0 20px 0; } .timeline-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 18px; margin-bottom: 20px; } .timeline-item { border-left: 5px solid #8b5cf6; padding: 18px; background: linear-gradient(135deg, #f9fafb 0%, #ffffff 100%); border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); } .timeline-item h3 { font-size: 14px; font-weight: 700; margin-bottom: 8px; color: #1f2937; } .timeline-dates { font-size: 13px; color: #6b7280; font-weight: 500; } .phases-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 18px; margin-bottom: 30px; } .phase { border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.05); } .phase-header { background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; padding: 15px; font-weight: 700; font-size: 14px; } .phase-content { padding: 15px; } .phase-content ul { list-style: none; } .phase-content li { font-size: 13px; margin-bottom: 8px; padding-left: 22px; position: relative; color: #374151; line-height: 1.5; } .phase-content li:before { content: "o"; position: absolute; left: 0; color: #d1d5db; font-weight: 700; } .phase-content li.checked:before { content: "‚úì"; color: #10b981; } .item-date { font-size: 11px; color: #9ca3af; margin-left: 8px; } .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #e5e7eb; text-align: center; color: #9ca3af; font-size: 11px; }</style>';

            let body = '<div class="container">';
            body += '<div class="header-top"><h1>PAINEL DE IMPLANTACAO ERP</h1><p>Cronograma e Acompanhamento de Projeto</p></div>';
            body += '<div class="info-grid"><div class="info-card"><label>Cliente</label><p>' + clientName + '</p></div><div class="info-card"><label>Responsavel</label><p>' + responsible + '</p></div><div class="info-card"><label>Data de Inicio</label><p>' + startDate + '</p></div></div>';
            body += '<div class="progress-section"><div class="progress-header"><h3>Progresso Geral do Projeto</h3><span class="progress-percentage">' + percentage + '%</span></div><div class="progress-bar"><div class="progress-fill"></div></div></div>';
            body += '<h2 class="section-title">Cronograma de Implantacao</h2><div class="timeline-grid">';

            weeks.forEach((week) => {
                const dates = currentProjectData.dates[week.id] || {};
                const dateStr = dates.start ? formatDate(dates.start) + ' ate ' + formatDate(dates.end) : 'Sem datas';
                body += '<div class="timeline-item"><h3>' + week.title + '</h3><div class="timeline-dates">' + dateStr + '</div></div>';
            });

            body += '</div><h2 class="section-title">Status dos Checklists</h2><div class="phases-grid">';

            phases.forEach(phase => {
                const phaseElement = document.getElementById(phase.id);
                const checkedItems = phaseElement ? phaseElement.querySelectorAll('input[type="checkbox"]:checked').length : 0;
                const totalItems = phaseElement ? phaseElement.querySelectorAll('input[type="checkbox"]').length : 0;
                const phasePercentage = totalItems > 0 ? Math.round((checkedItems / totalItems) * 100) : 0;

                body += '<div class="phase"><div class="phase-header">Fase ' + phase.phaseNumber + ': ' + phase.name + ' - ' + phasePercentage + '%</div><div class="phase-content"><ul>';

                phase.items.forEach((item, index) => {
                    const phaseEl = document.getElementById(phase.id);
                    let isChecked = false;
                    let itemDate = '';
                    if (phaseEl) {
                        const allCheckboxes = phaseEl.querySelectorAll('input[type="checkbox"]');
                        if (allCheckboxes && allCheckboxes[index]) {
                            isChecked = allCheckboxes[index].checked;
                        }
                        const dateInput = phaseEl.querySelector(`#date-${phase.id}-item-${index}`);
                        if (dateInput && dateInput.value) {
                            itemDate = ' - ' + formatDate(dateInput.value);
                        }
                    }
                    body += '<li class="' + (isChecked ? 'checked' : '') + '">' + item + (isChecked && itemDate ? '<span class="item-date">' + itemDate + '</span>' : '') + '</li>';
                });

                body += '</ul></div></div>';
            });

            body += '</div><div class="footer"><p>Documento gerado em ' + new Date().toLocaleDateString('pt-BR') + ' as ' + new Date().toLocaleTimeString('pt-BR') + '</p><p>Sistema de Implantacao ERP</p></div></div>';

            const printWindow = window.open('', 'RelatorioERP');
            if (!printWindow) {
                alert('Permitir abas pop-up no navegador para imprimir o PDF!');
                return;
            }
            
            printWindow.document.write('<!DOCTYPE html><html><head><meta charset="UTF-8">' + styles + '</head><body>' + body + '</body></html>');
            printWindow.document.close();
            
            setTimeout(() => {
                printWindow.focus();
                printWindow.print();
            }, 300);
        }

        // ALTERA√á√ÉO DE ARMAZENAMENTO: localStorage ‚Üí Supabase
        async function loadProjectsList() {
            const projectsList = document.getElementById('projectsList');
            projectsList.innerHTML = '<p style="color: var(--text2); text-align: center; grid-column: 1/-1;">Carregando projetos...</p>';

            // ANTES: JSON.parse(localStorage.getItem('allProjects') || '{}')
            // AGORA:  busca do Supabase
            const allProjects = await _dbGetAllProjects();
            projectsList.innerHTML = '';

            if (Object.keys(allProjects).length === 0) {
                projectsList.innerHTML = '<p style="color: var(--text2); text-align: center; grid-column: 1/-1;">Nenhum projeto salvo ainda</p>';
                return;
            }

            Object.entries(allProjects).forEach(([projectId, project]) => {
                const card = document.createElement('div');
                card.className = 'project-card';
                
                const progressData = calculateProjectProgress(project);

                card.innerHTML = `<h3>${project.clientName}</h3><p><strong>Respons√°vel:</strong> ${project.responsible}</p><p><strong>In√≠cio:</strong> ${formatDate(project.startDate)}</p><p><strong>Progresso:</strong> ${progressData}%</p><p style="font-size: 0.85em; color: var(--text2);">Salvo em: ${project.savedAt}</p><div class="project-card-buttons"><button class="btn btn-secondary" onclick="loadProject('${projectId}')">Abrir</button><button class="btn btn-danger" onclick="deleteProject('${projectId}')">Deletar</button></div>`;
                projectsList.appendChild(card);
            });
        }

        function calculateProjectProgress(project) {
            if (!project.phases) return 0;

            let totalItems = 0;
            let checkedItems = 0;

            project.phases.forEach(phase => {
                if (phase.items && phase.items.length > 0) {
                    totalItems += phase.items.length;
                }
            });

            if (project.checklistStates) {
                Object.values(project.checklistStates).forEach(phaseItems => {
                    Object.values(phaseItems).forEach(checked => {
                        if (checked) checkedItems++;
                    });
                });
            }

            return totalItems > 0 ? Math.round((checkedItems / totalItems) * 100) : 0;
        }

        // ALTERA√á√ÉO DE ARMAZENAMENTO: localStorage ‚Üí Supabase
        async function loadProject(projectId) {
            // ANTES: JSON.parse(localStorage.getItem('allProjects') || '{}')
            // AGORA:  busca do Supabase
            const allProjects = await _dbGetAllProjects();
            const projectData = allProjects[projectId];

            if (!projectData) {
                alert('Projeto n√£o encontrado!');
                return;
            }

            currentProjectId = projectId;
            currentProjectData = JSON.parse(JSON.stringify(projectData));
            phases = JSON.parse(JSON.stringify(projectData.phases || defaultPhases));
            weeks = JSON.parse(JSON.stringify(projectData.weeks || defaultWeeks));

            document.getElementById('projectsSection').style.display = 'none';
            document.getElementById('projectSection').style.display = 'block';
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('chartSection').style.display = 'block';
            document.getElementById('timelineSection').style.display = 'block';
            document.getElementById('checklistsSection').style.display = 'block';

            displayProjectInfo(projectData.clientName, projectData.startDate, projectData.responsible);
            renderTimeline(projectData.dates || {});
            renderChecklists();
            renderDeliveryChart();
        }

        // ALTERA√á√ÉO DE ARMAZENAMENTO: localStorage ‚Üí Supabase
        async function deleteProject(projectId) {
            if (confirm('Deseja deletar este projeto? Esta a√ß√£o n√£o pode ser desfeita!')) {
                // ANTES: JSON.parse(localStorage.getItem('allProjects') || '{}') + setItem
                // AGORA:  remove do Supabase
                await _dbDeleteProject(projectId);
                loadProjectsList();
            }
        }

        function backToProjects() {
            document.getElementById('projectsSection').style.display = 'block';
            document.getElementById('projectSection').style.display = 'none';
            document.getElementById('progressSection').style.display = 'none';
            document.getElementById('chartSection').style.display = 'none';
            document.getElementById('timelineSection').style.display = 'none';
            document.getElementById('checklistsSection').style.display = 'none';
            loadProjectsList();
        }

        function resetProject() {
            document.getElementById('clientName').value = '';
            document.getElementById('startDate').value = '';
            document.getElementById('responsible').value = '';
            document.getElementById('projectSection').style.display = 'none';
            document.getElementById('progressSection').style.display = 'none';
            document.getElementById('chartSection').style.display = 'none';
            document.getElementById('timelineSection').style.display = 'none';
            document.getElementById('checklistsSection').style.display = 'none';
            currentProjectId = null;
            currentProjectData = null;
            phases = JSON.parse(JSON.stringify(defaultPhases));
            weeks = JSON.parse(JSON.stringify(defaultWeeks));
            if (deliveryChart) deliveryChart.destroy();
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            return date.toLocaleDateString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        // ===== NOVA ETAPA NA CRONOLOGIA =====
        function openNewTimelineEntry() {
            document.getElementById('newTimeline_title').value = '';
            document.getElementById('newTimeline_start').value = '';
            document.getElementById('newTimeline_end').value = '';
            document.getElementById('newTimeline_description').value = '';
            document.getElementById('newTimelineModal').style.display = 'block';
        }

        function saveNewTimelineEntry() {
            const title = document.getElementById('newTimeline_title').value.trim();
            const start = document.getElementById('newTimeline_start').value;
            const end = document.getElementById('newTimeline_end').value;
            const description = document.getElementById('newTimeline_description').value.trim();

            if (!title) { alert('O t√≠tulo da etapa √© obrigat√≥rio!'); return; }
            if (start && end && new Date(start) > new Date(end)) {
                alert('Data de in√≠cio n√£o pode ser maior que a data fim!');
                return;
            }

            const newId = 'custom-' + Date.now();
            const newWeek = { id: newId, title, phaseNumber: '', custom: true, description };
            weeks.push(newWeek);

            if (!currentProjectData.dates) currentProjectData.dates = {};
            if (start || end) {
                currentProjectData.dates[newId] = { start: start || '', end: end || '' };
            }
            currentProjectData.weeks = weeks;

            renderTimeline(currentProjectData.dates);
            document.getElementById('newTimelineModal').style.display = 'none';
        }

        // ===== FUN√á√ïES EXTRAS DA CRONOLOGIA (editar/excluir etapa custom) =====
        function removeTimelineEntry(weekId) {
            if (!confirm('Deseja remover esta etapa?')) return;
            weeks = weeks.filter(w => w.id !== weekId);
            if (currentProjectData.dates) delete currentProjectData.dates[weekId];
            currentProjectData.weeks = weeks;
            renderTimeline(currentProjectData.dates || {});
        }

        // ===== NOVA FASE NO CHECKLIST =====
        function addNewPhase() {
            const newPhaseNumber = phases.length + 1;
            const newPhase = {
                id: 'phase-' + Date.now(),
                name: 'Nova Fase',
                phaseNumber: String(newPhaseNumber),
                items: []
            };
            phases.push(newPhase);
            openChecklistEditor();
        }

        // ===== EXCLUIR FASE INTEIRA =====
        function removePhase(phaseId) {
            if (!confirm('Deseja remover esta fase inteira e todos os seus itens?')) return;
            flushChecklistEditorState();
            phases = phases.filter(p => p.id !== phaseId);
            if (currentProjectData.checklistStates) delete currentProjectData.checklistStates[phaseId];
            if (currentProjectData.checklistDates) delete currentProjectData.checklistDates[phaseId];
            if (currentProjectData.checklistNotes) delete currentProjectData.checklistNotes[phaseId];
            openChecklistEditor();
        }

        // ===== SALVAR OBSERVA√á√ÉO DE ITEM =====
        function saveChecklistNote(phaseId, itemIndex, note) {
            if (!currentProjectData.checklistNotes) currentProjectData.checklistNotes = {};
            if (!currentProjectData.checklistNotes[phaseId]) currentProjectData.checklistNotes[phaseId] = {};
            currentProjectData.checklistNotes[phaseId][itemIndex] = note;
        }

        window.onclick = function(event) {
            const timelineModal = document.getElementById('timelineModal');
            const checklistModal = document.getElementById('checklistModal');
            const newTimelineModal = document.getElementById('newTimelineModal');
            if (event.target === timelineModal) timelineModal.style.display = 'none';
            if (event.target === checklistModal) checklistModal.style.display = 'none';
            if (event.target === newTimelineModal) newTimelineModal.style.display = 'none';
        };

        document.addEventListener('DOMContentLoaded', loadProjectsList);
    </script>
</body>
</html>
