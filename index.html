<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Sistema de Chamados</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:Arial,sans-serif;background:#f4f6f8}
.layout{display:flex;min-height:100vh}
.sidebar{width:260px;background:#111827;color:#fff;padding:20px}
.sidebar img{max-width:100%;max-height:60px;margin-bottom:10px}
.sidebar button{width:100%;background:none;border:none;color:#d1d5db;padding:12px;text-align:left;border-radius:6px;cursor:pointer;margin-bottom:8px}
.sidebar button.active,.sidebar button:hover{background:#2563eb;color:#fff}
.content{flex:1;padding:20px}
.hidden{display:none}
.btn{background:#2563eb;color:#fff;border:none;padding:8px 14px;border-radius:6px;cursor:pointer}
.btn-danger{background:#dc2626;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer}
table{width:100%;border-collapse:collapse;background:#fff;margin-top:15px}
th,td{padding:8px;border-bottom:1px solid #ddd;font-size:14px}
th{background:#f9fafb}
.status{padding:4px 10px;border-radius:999px;font-size:12px;cursor:pointer}
.pendente{background:#fef3c7}
.resolvido{background:#dcfce7}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center}
.modal.active{display:flex}
.modal-content{background:#fff;padding:20px;border-radius:10px;width:400px}
.modal-content input,textarea{width:100%;margin-bottom:10px;padding:8px}
</style>
</head>

<body>

<div class="layout">
  <aside class="sidebar">
    <img id="logoEmpresa" class="hidden">
    <h3 id="nomeEmpresa">Sistema</h3>
    <button class="active" onclick="app.aba('chamados',this)">üìã Chamados</button>
    <button onclick="app.aba('clientes',this)">üë• Clientes</button>
    <button onclick="app.aba('relatorios',this)">üìä Relat√≥rios</button>
    <button onclick="app.aba('config',this)">‚öôÔ∏è Config</button>
  </aside>

  <main class="content">

<!-- CHAMADOS -->
<section id="chamados">
<button class="btn" onclick="app.abrirModal()">+ Abrir Chamado</button>
<table>
<thead>
<tr>
<th>ID</th><th>Data</th><th>Cliente</th><th>Solicitante</th>
<th>T√©cnico</th><th>Descri√ß√£o</th><th>Status</th><th>A√ß√µes</th>
</tr>
</thead>
<tbody id="listaChamados"></tbody>
</table>
</section>

<!-- CLIENTES -->
<section id="clientes" class="hidden">
<ul id="listaClientes"></ul>
</section>

<!-- RELAT√ìRIOS -->
<section id="relatorios" class="hidden">
<input id="fCliente" placeholder="Cliente">
<input id="fSolicitante" placeholder="Solicitante">
<input id="fTecnico" placeholder="T√©cnico">
<select id="fStatus">
<option value="">Todos</option>
<option value="pendente">Pendente</option>
<option value="resolvido">Resolvido</option>
</select>
<button class="btn" onclick="app.relatorio()">Filtrar</button>

<table>
<thead>
<tr>
<th>ID</th><th>Data</th><th>Cliente</th>
<th>Solicitante</th><th>T√©cnico</th><th>Status</th><th>Cronologia</th>
</tr>
</thead>
<tbody id="resultadoRelatorio"></tbody>
</table>
</section>

<!-- CONFIG -->
<section id="config" class="hidden">
<input id="confEmpresa" placeholder="Nome da empresa">
<input id="confLogo" placeholder="URL da logo">
<button class="btn" onclick="app.salvarConfig()">Salvar</button>
</section>

</main>
</div>

<!-- MODAL CHAMADO -->
<div id="modal" class="modal">
<div class="modal-content">
<input id="mCliente" placeholder="Cliente">
<input id="mSolicitante" placeholder="Solicitante">
<input id="mTecnico" placeholder="T√©cnico">
<textarea id="mDescricao" placeholder="Descri√ß√£o"></textarea>
<button class="btn" onclick="app.salvarChamado()">Salvar</button>
<button class="btn-danger" onclick="app.fecharModal()">Cancelar</button>
</div>
</div>

<script>
// ======== SUPABASE =========
const SUPABASE_URL = 'https://boendmrotsttljydigld.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJvZW5kbXJvdHN0dGxqeWRpZ2xkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1OTI5NTksImV4cCI6MjA4MjE2ODk1OX0.k6vVvD6kNV8r-a9lR6jaTcAm1wz5c_jbTDnjKlpo0cE';
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const app = {

aba(id,btn){
document.querySelectorAll('section').forEach(s=>s.classList.add('hidden'));
document.getElementById(id).classList.remove('hidden');
document.querySelectorAll('.sidebar button').forEach(b=>b.classList.remove('active'));
btn.classList.add('active');
},

abrirModal(){modal.classList.add('active')},
fecharModal(){modal.classList.remove('active')},

async carregarChamados(){
const hoje = new Date(); hoje.setHours(0,0,0,0);
const {data} = await supabaseClient.from('chamados').select('*').order('created_at',{ascending:false});
listaChamados.innerHTML='';
data.filter(c=>{
if(c.status==='pendente') return true;
const d=new Date(c.created_at); d.setHours(0,0,0,0);
return d.getTime()===hoje.getTime();
}).forEach(c=>{
listaChamados.innerHTML+=`
<tr>
<td>${c.id}</td>
<td>${new Date(c.created_at).toLocaleDateString()}</td>
<td>${c.cliente}</td>
<td>${c.solicitante}</td>
<td>${c.tecnico}</td>
<td>${c.descricao}</td>
<td><span class="status ${c.status}" onclick="app.toggle(${c.id},'${c.status}')">${c.status}</span></td>
<td><button class="btn-danger" onclick="app.excluirChamado(${c.id})">üóëÔ∏è</button></td>
</tr>`;
});
},

async salvarChamado(){
await supabaseClient.from('clientes').upsert({nome:mCliente.value},{onConflict:'nome'});
await supabaseClient.from('chamados').insert({
cliente:mCliente.value, solicitante:mSolicitante.value,
tecnico:mTecnico.value, descricao:mDescricao.value, status:'pendente'
});
this.fecharModal(); this.carregarChamados(); this.carregarClientes();
},

async toggle(id,status){
await supabaseClient.from('chamados').update({status:status==='pendente'?'resolvido':'pendente'}).eq('id',id);
this.carregarChamados();
},

async excluirChamado(id){
if(confirm('Excluir?')){
await supabaseClient.from('chamados').delete().eq('id',id);
this.carregarChamados();
}
},

async carregarClientes(){
const {data} = await supabaseClient.from('clientes').select('*').order('nome');
listaClientes.innerHTML='';
data.forEach(c=>{
listaClientes.innerHTML+=`
<li>${c.nome}
<button class="btn-danger" onclick="app.excluirCliente('${c.nome}')">üóëÔ∏è</button>
</li>`;
});
},

async excluirCliente(nome){
const {data} = await supabaseClient.from('chamados').select('id').eq('cliente',nome).limit(1);
if(data.length){alert('Cliente possui chamados'); return;}
await supabaseClient.from('clientes').delete().eq('nome',nome);
this.carregarClientes();
},

async relatorio(){
let q = supabaseClient.from('chamados').select('*').order('created_at',{ascending:false});
if(fCliente.value) q=q.ilike('cliente','%'+fCliente.value+'%');
if(fSolicitante.value) q=q.ilike('solicitante','%'+fSolicitante.value+'%');
if(fTecnico.value) q=q.ilike('tecnico','%'+fTecnico.value+'%');
if(fStatus.value) q=q.eq('status',fStatus.value);
const {data}=await q;
resultadoRelatorio.innerHTML='';
data.forEach(c=>{
resultadoRelatorio.innerHTML+=`
<tr>
<td>${c.id}</td>
<td>${new Date(c.created_at).toLocaleDateString()}</td>
<td>${c.cliente}</td>
<td>${c.solicitante}</td>
<td>${c.tecnico}</td>
<td>${c.status}</td>
<td>‚Äî</td>
</tr>`;
});
},

async salvarConfig(){
await supabaseClient.from('configuracoes').upsert({id:1,empresa:confEmpresa.value,logo_url:confLogo.value});
this.carregarConfig();
},

async carregarConfig(){
const {data}=await supabaseClient.from('configuracoes').select('*').eq('id',1).single();
if(!data) return;
nomeEmpresa.innerText=data.empresa;
if(data.logo_url){logoEmpresa.src=data.logo_url;logoEmpresa.classList.remove('hidden');}
},

async init(){
await this.carregarChamados();
await this.carregarClientes();
await this.carregarConfig();
}

};

app.init();
</script>

</body>
</html>
