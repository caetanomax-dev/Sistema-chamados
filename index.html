<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Sistema de Chamados</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:Arial,sans-serif;background:#f4f6f8;min-height:100vh}
.layout{display:flex;min-height:100vh;flex-direction:row}
.sidebar{width:260px;background:#111827;color:#fff;padding:20px;overflow-y:auto}
.sidebar img{max-width:100%;max-height:60px;margin-bottom:10px}
.sidebar h1{font-size:16px;margin:5px 0}
.sidebar button{width:100%;background:none;border:none;color:#d1d5db;padding:12px;text-align:left;border-radius:6px;cursor:pointer;margin-bottom:8px;transition:0.2s}
.sidebar button.active,.sidebar button:hover{background:#2563eb;color:#fff}
.content{flex:1;padding:30px;overflow-y:auto}
.hidden{display:none}

@media(max-width:768px){
  .layout{flex-direction:column}
  .sidebar{width:100%;padding:15px}
  .content{padding:15px}
}

.btn{background:#2563eb;color:#fff;border:none;padding:10px 16px;border-radius:6px;cursor:pointer;transition:0.2s}
.btn:hover{background:#1e40af}
.btn-danger{background:#dc2626;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;transition:0.2s}
.btn-danger:hover{background:#b91c1c}

table{width:100%;border-collapse:collapse;background:#fff;border-radius:8px;margin-top:15px}
th,td{padding:10px;border-bottom:1px solid #e5e7eb;font-size:13px}
th{background:#f9fafb;font-size:12px;text-transform:uppercase}

.status{padding:4px 10px;border-radius:999px;font-size:12px;cursor:pointer;transition:0.2s}
.pendente{background:#fef3c7;color:#92400e}
.resolvido{background:#dcfce7;color:#166534}

/* MODAL */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:1000;
}
.modal.active{display:flex}
.modal-content{
  background:#fff;
  padding:20px;
  border-radius:10px;
  width:400px;
  max-height:90vh;
  overflow-y:auto;
}
.modal-content input,
.modal-content textarea{
  width:100%;
  margin-bottom:10px;
  padding:8px;
  border:1px solid #ddd;
  border-radius:4px;
}
.erro{color:#dc2626;padding:10px;background:#fee;border-radius:6px;margin:10px 0}

/* Config */
#config input{
  display:block;
  width:100%;
  margin-bottom:10px;
  padding:8px;
  border:1px solid #ddd;
  border-radius:6px;
}
#config button{margin-top:10px}

/* Cronologia */
#listaCronologia div{
  padding:5px;
  border-bottom:1px solid #eee;
  border-radius:4px;
  margin-bottom:4px;
  background:#f9fafb;
  transition:0.2s;
}
#listaCronologia div.ultimo{background:#dbeafe;}
#listaCronologia div span{font-size:10px;color:#555;display:block;margin-bottom:2px;}

/* Filtros Relat√≥rio */
.filtros{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin-bottom:15px}
.filtros input, .filtros select{padding:8px;border:1px solid #ddd;border-radius:6px}

/* Cards Clientes */
.cliente-card{
  background:#fff;
  border-radius:8px;
  padding:15px;
  box-shadow:0 2px 8px rgba(0,0,0,0.1);
  transition:0.3s;
}
.cliente-card:hover{box-shadow:0 4px 16px rgba(0,0,0,0.15); transform:translateY(-2px)}
.cliente-card h3{margin:0 0 10px 0; color:#1f2937; font-size:16px}
.cliente-stats{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin:10px 0}
.stat-box{
  background:#f0f4f8;
  padding:10px;
  border-radius:6px;
  text-align:center;
}
.stat-box .numero{
  font-size:24px;
  font-weight:bold;
  color:#2563eb;
}
.stat-box .label{
  font-size:11px;
  color:#666;
  text-transform:uppercase;
  margin-top:3px;
}
.stat-box.pendente .numero{color:#d97706}
.stat-box.resolvido .numero{color:#16a34a}
.cliente-actions{display:flex; gap:8px; margin-top:12px}
.cliente-actions button{flex:1; font-size:12px; padding:8px}

/* Autocomplete */
.autocomplete-container{position:relative}
.autocomplete-list{
  position:absolute;
  top:100%;
  left:0;
  right:0;
  background:#fff;
  border:1px solid #ddd;
  border-top:none;
  border-radius:0 0 4px 4px;
  max-height:200px;
  overflow-y:auto;
  display:none;
  z-index:100;
}
.autocomplete-list.active{display:block}
.autocomplete-item{
  padding:10px;
  cursor:pointer;
  border-bottom:1px solid #f0f0f0;
  transition:0.2s;
}
.autocomplete-item:hover{background:#f0f4f8}
</style>
</head>

<body>

<div class="layout">
  <aside class="sidebar">
    <img id="logoEmpresa" class="hidden">
    <h1 id="nomeEmpresa">Sistema</h1>

    <button class="active" onclick="app.aba('chamados',this)">üìã Chamados</button>
    <button onclick="app.aba('clientes',this)">üë• Clientes</button>
    <button onclick="app.aba('relatorios',this)">üìä Relat√≥rios</button>
    <button onclick="app.aba('config',this)">‚öôÔ∏è Config</button>
  </aside>

  <main class="content">
    <div id="msgErro"></div>

    <!-- Chamados -->
    <section id="chamados">
      <button class="btn" onclick="app.abrirModal()">+ Abrir Chamado</button>
      <table>
        <thead>
          <tr>
            <th>ID</th><th>Data</th><th>Cliente</th><th>Solicitante</th>
            <th>T√©cnico</th><th>Descri√ß√£o</th><th>Status</th><th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="listaChamados"></tbody>
      </table>
    </section>

    <!-- Clientes -->
    <section id="clientes" class="hidden">
      <h2>Gest√£o de Clientes</h2>
      <div id="listaClientes" style="display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:15px;"></div>
    </section>

    <!-- Relat√≥rios -->
    <section id="relatorios" class="hidden">
      <h2>Relat√≥rios</h2>
      <div class="filtros">
        <input id="fCliente" placeholder="Cliente">
        <input id="fSolicitante" placeholder="Solicitante">
        <input id="fTecnico" placeholder="T√©cnico">
        <select id="fStatus">
          <option value="">Todos os Status</option>
          <option value="pendente">Pendente</option>
          <option value="resolvido">Resolvido</option>
        </select>
        <input id="fDataInicio" type="date">
        <input id="fDataFim" type="date">
        <button class="btn" onclick="app.relatorio()">üîç Filtrar</button>
      </div>

      <table>
        <thead>
          <tr>
            <th>ID</th><th>Data</th><th>Cliente</th><th>Solicitante</th>
            <th>T√©cnico</th><th>Status</th><th>Cronologia</th>
          </tr>
        </thead>
        <tbody id="resultadoRelatorio"></tbody>
      </table>
    </section>

    <!-- Configura√ß√µes -->
    <section id="config" class="hidden">
      <input id="confEmpresa" placeholder="Nome da empresa">
      <input id="confLogo" placeholder="URL da logo">
      <button class="btn" onclick="app.salvarConfig()">Salvar</button>
    </section>

  </main>
</div>

<!-- Modal Chamado -->
<div id="modal" class="modal">
  <div class="modal-content">
    <div class="autocomplete-container">
      <input id="mCliente" placeholder="Cliente" oninput="app.filtrarClientes()">
      <div id="listaClientesDropdown" class="autocomplete-list"></div>
    </div>
    <input id="mSolicitante" placeholder="Solicitante">
    <input id="mTecnico" placeholder="T√©cnico">
    <textarea id="mDescricao" placeholder="Descri√ß√£o"></textarea>
    <button class="btn" onclick="app.salvarChamado()">Salvar</button>
    <button class="btn-danger" onclick="app.fecharModal()">Cancelar</button>
  </div>
</div>

<!-- Modal Cronologia -->
<div id="modalCronologia" class="modal">
  <div class="modal-content">
    <h3>Cronologia do Chamado <span id="cronId"></span></h3>
    <div id="descricaoChamado" style="display:none; padding:10px; background:#f0f4f8; border:1px solid #ddd; border-radius:6px; margin-bottom:10px;"></div>
    <div id="listaCronologia" style="max-height:250px; overflow:auto; border:1px solid #ddd; padding:5px; margin-bottom:10px;"></div>
    <textarea id="novaAtualizacao" placeholder="Nova atualiza√ß√£o..."></textarea>
    <div style="display:flex; gap:10px; margin-top:10px;">
      <button id="btnAdicionarAtualizacao" class="btn" onclick="app.salvarAtualizacao()" style="flex:1;">Adicionar</button>
      <button class="btn-danger" onclick="app.fecharModalCronologia()" style="flex:1;">Fechar</button>
    </div>
  </div>
</div>

<!-- Modal Editar Chamado -->
<div id="modalEditar" class="modal">
  <div class="modal-content">
    <h3>Editar Chamado <span id="editId"></span></h3>
    <label>Cliente:</label>
    <input id="editCliente" placeholder="Cliente">
    <label>Solicitante:</label>
    <input id="editSolicitante" placeholder="Solicitante">
    <label>T√©cnico:</label>
    <input id="editTecnico" placeholder="T√©cnico">
    <label>Descri√ß√£o:</label>
    <textarea id="editDescricao" placeholder="Descri√ß√£o" style="margin-bottom:10px;"></textarea>
    <h4>Atualiza√ß√µes da Cronologia:</h4>
    <div id="listaCronologiaEditar" style="max-height:250px; overflow:auto; border:1px solid #ddd; padding:5px; margin-bottom:10px;"></div>
    <button class="btn" onclick="app.salvarEdicaoChamado()">Salvar Altera√ß√µes</button>
    <button class="btn-danger" onclick="app.fecharModalEditar()">Cancelar</button>
  </div>
</div>

<script>
// ============================
// COLOQUE AQUI SUA URL E CHAVE
// ============================
const SUPABASE_URL = 'https://boendmrotsttljydigld.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJvZW5kbXJvdHN0dGxqeWRpZ2xkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1OTI5NTksImV4cCI6MjA4MjE2ODk1OX0.k6vVvD6kNV8r-a9lR6jaTcAm1wz5c_jbTDnjKlpo0cE';

const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const app = {
  formatarData(dataString){
    if(!dataString) return '--/--/----';
    const data = new Date(dataString);
    return data.toLocaleDateString('pt-BR');
  },

  mostrarErro(msg){
    const div = document.getElementById('msgErro');
    div.innerHTML = `<div class="erro">‚ùå ${msg}</div>`;
    setTimeout(() => div.innerHTML = '', 5000);
    console.error(msg);
  },
  
  aba(id,btn){
    document.querySelectorAll('section').forEach(s=>s.classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
    document.querySelectorAll('.sidebar button').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
  },
  
  abrirModal(){ 
    document.getElementById('modal').classList.add('active');
    mCliente.value = '';
    mSolicitante.value = '';
    mTecnico.value = '';
    mDescricao.value = '';
    document.getElementById('listaClientesDropdown').innerHTML = '';
    document.getElementById('listaClientesDropdown').classList.remove('active');
  },
  
  fecharModal(){ document.getElementById('modal').classList.remove('active'); },

  filtrarClientes(){
    const input = document.getElementById('mCliente').value.toLowerCase();
    const dropdown = document.getElementById('listaClientesDropdown');
    
    if(input.length === 0){
      dropdown.classList.remove('active');
      return;
    }
    
    supabaseClient.from('clientes').select('nome').then(({data}) => {
      dropdown.innerHTML = '';
      
      if(!data || data.length === 0){
        dropdown.classList.remove('active');
        return;
      }
      
      const filtrados = data.filter(c => c.nome.toLowerCase().includes(input));
      
      if(filtrados.length === 0){
        dropdown.classList.remove('active');
        return;
      }
      
      filtrados.forEach(cliente => {
        const item = document.createElement('div');
        item.className = 'autocomplete-item';
        item.textContent = cliente.nome;
        item.onclick = () => {
          document.getElementById('mCliente').value = cliente.nome;
          dropdown.classList.remove('active');
        };
        dropdown.appendChild(item);
      });
      
      dropdown.classList.add('active');
    });
  },

  ehDataAtual(dataString){
    if(!dataString) return false;
    const data = new Date(dataString);
    const hoje = new Date();
    return data.toLocaleDateString('pt-BR') === hoje.toLocaleDateString('pt-BR');
  },

  async carregarChamados(){
    try {
      const {data, error} = await supabaseClient.from('chamados').select('*').order('id',{ascending:false});
      if(error) return this.mostrarErro('Erro ao carregar chamados: ' + error.message);
      const tbody = document.getElementById('listaChamados'); tbody.innerHTML='';
      if(!data || data.length===0){tbody.innerHTML='<tr><td colspan="8">Nenhum chamado</td></tr>'; return;}
      
      // Filtrar: pendentes OU resolvidos de hoje
      const chamadosFiltrados = data.filter(c => 
        c.status === 'pendente' || this.ehDataAtual(c.created_at)
      );
      
      if(chamadosFiltrados.length===0){tbody.innerHTML='<tr><td colspan="8">Nenhum chamado pendente ou de hoje</td></tr>'; return;}
      
      chamadosFiltrados.forEach(c=>{
        tbody.innerHTML+=`<tr>
          <td>${c.id}</td>
          <td>${this.formatarData(c.created_at)}</td>
          <td>${c.cliente}</td>
          <td>${c.solicitante}</td>
          <td>${c.tecnico}</td>
          <td style="cursor:pointer; text-decoration:underline;" onclick="app.abrirCronologia(${c.id})">${c.descricao}</td>
          <td><span class="status ${c.status}" onclick="app.toggle(${c.id},'${c.status}')">${c.status}</span></td>
          <td><button class="btn" onclick="app.abrirModalEditar(${c.id})">‚úèÔ∏è Editar</button></td>
        </tr>`;
      });
    } catch(e){ this.mostrarErro('Erro: '+e.message); }
  },

  async salvarChamado(){
    if(!mCliente.value||!mSolicitante.value||!mTecnico.value||!mDescricao.value){alert('Preencha todos os campos!'); return;}
    try{
      const {data: clienteExistente} = await supabaseClient.from('clientes').select('*').eq('nome', mCliente.value).single();
      if(!clienteExistente){ await supabaseClient.from('clientes').insert({nome:mCliente.value}); }
      const {error} = await supabaseClient.from('chamados').insert({cliente:mCliente.value, solicitante:mSolicitante.value, tecnico:mTecnico.value, descricao:mDescricao.value, status:'pendente', created_at: new Date().toISOString()});
      if(error) return this.mostrarErro('Erro ao salvar: '+error.message);
      this.fecharModal(); this.carregarChamados(); this.carregarClientes();
    }catch(e){ this.mostrarErro('Erro: '+e.message); }
  },

  async toggle(id,status){
    try{
      const novoStatus = status==='pendente'?'resolvido':'pendente';
      const {error} = await supabaseClient.from('chamados').update({status:novoStatus}).eq('id',id);
      if(error) return this.mostrarErro('Erro ao atualizar: '+error.message);
      this.carregarChamados(); this.relatorio();
    }catch(e){ this.mostrarErro('Erro: '+e.message); }
  },

  async excluirChamado(id){if(!confirm('Excluir este chamado?'))return;
    try{const {error} = await supabaseClient.from('chamados').delete().eq('id',id);
      if(error) return this.mostrarErro('Erro ao excluir: '+error.message);
      this.carregarChamados(); this.carregarClientes();
    }catch(e){this.mostrarErro('Erro: '+e.message);}
  },

  async carregarClientes(){
    try{
      const {data,error} = await supabaseClient.from('clientes').select('*'); if(error) return;
      const div=document.getElementById('listaClientes'); div.innerHTML='';
      if(!data||data.length===0){div.innerHTML='<p style="grid-column:1/-1; text-align:center; color:#999;">Nenhum cliente cadastrado</p>'; return;}
      
      for(let c of data){
        // Contar chamados
        const {data: chamados} = await supabaseClient.from('chamados').select('status').eq('cliente', c.nome);
        const pendentes = chamados?.filter(ch => ch.status === 'pendente').length || 0;
        const resolvidos = chamados?.filter(ch => ch.status === 'resolvido').length || 0;
        const total = pendentes + resolvidos;
        
        div.innerHTML+=`
          <div class="cliente-card">
            <h3>üë§ ${c.nome}</h3>
            <div class="cliente-stats">
              <div class="stat-box pendente">
                <div class="numero">${pendentes}</div>
                <div class="label">Pendentes</div>
              </div>
              <div class="stat-box resolvido">
                <div class="numero">${resolvidos}</div>
                <div class="label">Resolvidos</div>
              </div>
            </div>
            <div style="font-size:12px; color:#666; text-align:center; margin:8px 0;">Total: <strong>${total}</strong> chamado${total!==1?'s':''}</div>
            <div class="cliente-actions">
              <button class="btn-danger" onclick="app.excluirCliente('${c.nome}')" style="flex:1;">üóëÔ∏è Deletar</button>
            </div>
          </div>
        `;
      }
    }catch(e){console.error(e);}
  },

  async excluirCliente(nome){
    try{
      const {data: chamadosVinculados} = await supabaseClient.from('chamados').select('*').eq('cliente', nome).limit(1);
      if(chamadosVinculados.length>0){alert('N√£o √© poss√≠vel excluir: existem chamados vinculados a este cliente.'); return;}
      if(!confirm(`Excluir o cliente "${nome}"?`)) return;
      const {error} = await supabaseClient.from('clientes').delete().eq('nome', nome);
      if(error) return this.mostrarErro('Erro ao excluir cliente: '+error.message);
      this.carregarClientes();
    }catch(e){this.mostrarErro('Erro: '+e.message);}
  },

  async relatorio(){
    try{
      let q = supabaseClient.from('chamados').select('*');
      if(fCliente.value) q = q.ilike('cliente','%'+fCliente.value+'%');
      if(fSolicitante.value) q = q.ilike('solicitante','%'+fSolicitante.value+'%');
      if(fTecnico.value) q = q.ilike('tecnico','%'+fTecnico.value+'%');
      if(fStatus.value) q = q.eq('status',fStatus.value);
      
      const {data,error} = await q.order('created_at',{ascending:false});
      if(error) return this.mostrarErro('Erro no relat√≥rio: '+error.message);
      
      // Filtrar localmente por data
      let resultados = data || [];
      
      if(fDataInicio.value || fDataFim.value){
        resultados = resultados.filter(c => {
          const dataChamado = c.created_at; // Pega a data bruta do banco
          
          if(fDataInicio.value){
            // Data inicial: 2025-12-29 vira 2025-12-29T00:00:00
            const dataInicio = new Date(fDataInicio.value + 'T00:00:00').getTime();
            const chamadoTime = new Date(dataChamado).getTime();
            if(chamadoTime < dataInicio) return false;
          }
          
          if(fDataFim.value){
            // Data final: 2025-12-29 vira 2025-12-29T23:59:59
            const dataFim = new Date(fDataFim.value + 'T23:59:59').getTime();
            const chamadoTime = new Date(dataChamado).getTime();
            if(chamadoTime > dataFim) return false;
          }
          
          return true;
        });
      }
      
      const tbody=document.getElementById('resultadoRelatorio'); tbody.innerHTML='';
      if(!resultados||resultados.length===0){tbody.innerHTML='<tr><td colspan="7">Nenhum resultado</td></tr>'; return;}
      resultados.forEach(c=>{
        tbody.innerHTML+=`<tr>
          <td>${c.id}</td>
          <td>${this.formatarData(c.created_at)}</td>
          <td>${c.cliente}</td>
          <td>${c.solicitante}</td>
          <td>${c.tecnico}</td>
          <td><span class="status ${c.status}">${c.status}</span></td>
          <td><button class="btn" onclick="app.abrirCronologia(${c.id}, true)">Ver</button></td>
        </tr>`;
      });
    }catch(e){this.mostrarErro('Erro: '+e.message);}
  },

  abrirCronologia: async function(id, apenasVer=false){
    document.getElementById('modalCronologia').classList.add('active');
    document.getElementById('cronId').innerText=id;
    document.getElementById('novaAtualizacao').style.display = apenasVer ? 'none' : 'block';
    document.getElementById('btnAdicionarAtualizacao').style.display = apenasVer ? 'none' : 'block';
    document.getElementById('descricaoChamado').style.display = 'none';
    document.getElementById('descricaoChamado').innerHTML = '';
    
    // Buscar descri√ß√£o do chamado apenas se for visualiza√ß√£o (relat√≥rio)
    if(apenasVer){
      const {data} = await supabaseClient.from('chamados').select('descricao').eq('id', id).single();
      if(data){
        const descDiv = document.getElementById('descricaoChamado');
        descDiv.innerHTML = `<strong style="display:block; margin-bottom:5px; color:#1f2937;">Descri√ß√£o do Chamado:</strong><p style="margin:0; color:#555;">${data.descricao}</p>`;
        descDiv.style.display = 'block';
      }
    }
    
    this.carregarCronologia(id);
  },

  fecharModalCronologia: function(){
    document.getElementById('modalCronologia').classList.remove('active');
    document.getElementById('novaAtualizacao').value='';
    document.getElementById('listaCronologia').innerHTML='';
    document.getElementById('descricaoChamado').innerHTML='';
    document.getElementById('descricaoChamado').style.display='none';
  },

  abrirModalEditar: async function(id){
    try{
      const {data} = await supabaseClient.from('chamados').select('*').eq('id', id).single();
      if(!data) return this.mostrarErro('Chamado n√£o encontrado');
      
      document.getElementById('modalEditar').classList.add('active');
      document.getElementById('editId').innerText = id;
      document.getElementById('editCliente').value = data.cliente;
      document.getElementById('editSolicitante').value = data.solicitante;
      document.getElementById('editTecnico').value = data.tecnico;
      document.getElementById('editDescricao').value = data.descricao;
      
      // Carregar cronologia para edi√ß√£o
      await this.carregarCronologiaParaEditar(id);
    }catch(e){ this.mostrarErro('Erro: '+e.message); }
  },

  fecharModalEditar: function(){
    document.getElementById('modalEditar').classList.remove('active');
  },

  carregarCronologiaParaEditar: async function(chamado_id){
    const {data} = await supabaseClient.from('cronologia_chamados').select('*').eq('chamado_id', chamado_id).order('data', {ascending:true});
    const lista = document.getElementById('listaCronologiaEditar');
    lista.innerHTML = '';
    
    if(!data || data.length === 0){
      lista.innerHTML = '<p style="color:#999;">Nenhuma atualiza√ß√£o</p>';
      return;
    }
    
    data.forEach(c => {
      lista.innerHTML += `
        <div style="padding:8px; background:#f0f0f0; border-radius:4px; margin-bottom:8px;">
          <span style="font-size:10px; color:#555;">[${new Date(c.data).toLocaleString('pt-BR')}]</span>
          <textarea id="cron-${c.id}" style="width:100%; margin:5px 0; padding:5px; border:1px solid #ddd; border-radius:3px; font-size:12px;" rows="2">${c.descricao}</textarea>
          <button class="btn-danger" onclick="app.excluirAtualizacao(${c.id})" style="padding:4px 8px; font-size:11px;">Excluir</button>
        </div>
      `;
    });
  },

  salvarEdicaoChamado: async function(){
    const id = document.getElementById('editId').innerText;
    const cliente = document.getElementById('editCliente').value;
    const solicitante = document.getElementById('editSolicitante').value;
    const tecnico = document.getElementById('editTecnico').value;
    const descricao = document.getElementById('editDescricao').value;
    
    if(!cliente || !solicitante || !tecnico || !descricao){
      alert('Preencha todos os campos!');
      return;
    }
    
    try{
      // Atualizar chamado
      const {error} = await supabaseClient.from('chamados').update({
        cliente, solicitante, tecnico, descricao
      }).eq('id', id);
      
      if(error) return this.mostrarErro('Erro ao atualizar: '+error.message);
      
      // Atualizar atualiza√ß√µes da cronologia
      const textareas = document.querySelectorAll('[id^="cron-"]');
      for(let textarea of textareas){
        const cronId = textarea.id.replace('cron-', '');
        const novoTexto = textarea.value;
        await supabaseClient.from('cronologia_chamados').update({
          descricao: novoTexto
        }).eq('id', cronId);
      }
      
      this.fecharModalEditar();
      this.carregarChamados();
      this.relatorio();
    }catch(e){ this.mostrarErro('Erro: '+e.message); }
  },

  excluirAtualizacao: async function(cronId){
    if(!confirm('Excluir esta atualiza√ß√£o?')) return;
    try{
      const {error} = await supabaseClient.from('cronologia_chamados').delete().eq('id', cronId);
      if(error) return this.mostrarErro('Erro ao excluir: '+error.message);
      const chamadoId = document.getElementById('editId').innerText;
      await this.carregarCronologiaParaEditar(chamadoId);
    }catch(e){ this.mostrarErro('Erro: '+e.message); }
  },

  carregarCronologia: async function(chamado_id){
    const {data,error} = await supabaseClient.from('cronologia_chamados').select('*').eq('chamado_id',chamado_id).order('data',{ascending:true});
    const lista=document.getElementById('listaCronologia'); lista.innerHTML='';
    if(error) return this.mostrarErro('Erro ao carregar cronologia: '+error.message);
    if(!data||data.length===0){lista.innerHTML='Nenhuma atualiza√ß√£o ainda.'; return;}
    data.forEach((c,i)=>{lista.innerHTML+=`<div class="${i===data.length-1?'ultimo':''}"><span>[${new Date(c.data).toLocaleString('pt-BR')}]</span>${c.descricao}</div>`});
  },

  salvarAtualizacao: async function(){
    const desc=document.getElementById('novaAtualizacao').value;
    const id=document.getElementById('cronId').innerText;
    if(!desc) return alert('Digite a atualiza√ß√£o');
    
    // Ajustar a data para o fuso hor√°rio local
    const agora = new Date();
    const offset = agora.getTimezoneOffset() * 60000;
    const dataLocal = new Date(agora.getTime() - offset).toISOString();
    
    const {error}=await supabaseClient.from('cronologia_chamados').insert({chamado_id:id,descricao:desc,data:dataLocal});
    if(error) return this.mostrarErro('Erro ao salvar atualiza√ß√£o: '+error.message);
    document.getElementById('novaAtualizacao').value='';
    this.carregarCronologia(id);
  },

  async salvarConfig(){
    try{
      let {error}=await supabaseClient.from('configuracoes').update({empresa:confEmpresa.value,logo_url:confLogo.value}).eq('id',1);
      if(error && error.code==='PGRST116'){await supabaseClient.from('configuracoes').insert({id:1,empresa:confEmpresa.value,logo_url:confLogo.value});}
      this.carregarConfig();
    }catch(e){this.mostrarErro('Erro: '+e.message);}
  },

  async carregarConfig(){
    try{
      const {data} = await supabaseClient.from('configuracoes').select('*').eq('id',1).single();
      if(!data) return;
      nomeEmpresa.innerText=data.empresa||'Sistema';
      confEmpresa.value=data.empresa||'';
      confLogo.value=data.logo_url||'';
      if(data.logo_url){logoEmpresa.src=data.logo_url;logoEmpresa.classList.remove('hidden');}
    }catch(e){console.error(e);}
  },

  async init(){
    try{await supabaseClient.from('chamados').select('id').limit(1);}catch(e){this.mostrarErro('ERRO de conex√£o: '+e.message); return;}
    this.carregarChamados(); this.carregarClientes(); this.carregarConfig();
  }
};

app.init();
</script>

</body>
</html>
