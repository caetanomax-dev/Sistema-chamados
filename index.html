<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Sistema de Chamados</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:Arial,sans-serif;background:#f4f6f8;min-height:100vh}
.layout{display:flex;min-height:100vh;flex-direction:row}
.sidebar{width:260px;background:#111827;color:#fff;padding:20px;overflow-y:auto}
.sidebar img{max-width:100%;max-height:60px;margin-bottom:10px}
.sidebar h1{font-size:16px;margin:5px 0}
.sidebar button{width:100%;background:none;border:none;color:#d1d5db;padding:12px;text-align:left;border-radius:6px;cursor:pointer;margin-bottom:8px;transition:0.2s}
.sidebar button.active,.sidebar button:hover{background:#2563eb;color:#fff}
.content{flex:1;padding:30px;overflow-y:auto}
.hidden{display:none}

.btn{background:#2563eb;color:#fff;border:none;padding:10px 16px;border-radius:6px;cursor:pointer;transition:0.2s}
.btn:hover{background:#1e40af}
.btn-danger{background:#dc2626;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;transition:0.2s}
.btn-danger:hover{background:#b91c1c}

table{width:100%;border-collapse:collapse;background:#fff;border-radius:8px;margin-top:15px}
th,td{padding:10px;border-bottom:1px solid #e5e7eb;font-size:13px}
th{background:#f9fafb;font-size:12px;text-transform:uppercase}

.status{padding:4px 10px;border-radius:999px;font-size:12px;cursor:pointer}
.pendente{background:#fef3c7;color:#92400e}
.resolvido{background:#dcfce7;color:#166534}

.modal{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:1000}
.modal.active{display:flex}
.modal-content{background:#fff;padding:20px;border-radius:10px;width:400px;max-height:90vh;overflow-y:auto}
.modal-content input,.modal-content textarea{width:100%;margin-bottom:10px;padding:8px;border:1px solid #ddd;border-radius:4px}
.erro{color:#dc2626;padding:10px;background:#fee;border-radius:6px;margin:10px 0}

.autocomplete-list{position:absolute;top:100%;left:0;right:0;background:#fff;border:1px solid #ddd;border-top:none;border-radius:0 0 4px 4px;max-height:200px;overflow-y:auto;display:none;z-index:100}
.autocomplete-list.active{display:block}
.autocomplete-item{padding:10px;cursor:pointer;border-bottom:1px solid #f0f0f0}
.autocomplete-item:hover{background:#f0f4f8}

.cliente-card{background:#fff;border-radius:8px;padding:15px;box-shadow:0 2px 8px rgba(0,0,0,0.1)}
.cliente-card h3{margin:0 0 10px 0;color:#1f2937}
.cliente-actions{display:flex;gap:8px;margin-top:12px}
.cliente-actions button{flex:1;font-size:12px;padding:8px}

.acesso-item{padding:10px;background:#f0f4f8;border-radius:6px;margin-bottom:8px;border-left:4px solid #2563eb}
.acesso-item strong{display:block;margin-bottom:5px}
.acesso-item p{margin:5px 0;font-size:12px;color:#555}
.acesso-item .botoes{display:flex;gap:5px;margin-top:8px}
.acesso-item button{flex:1;font-size:11px;padding:4px 6px}
</style>
</head>

<body>

<div class="layout">
  <aside class="sidebar">
    <img id="logoEmpresa" class="hidden">
    <h1 id="nomeEmpresa">Sistema</h1>
    <button class="active" onclick="app.aba('chamados',this)">üìã Chamados</button>
    <button onclick="app.aba('clientes',this)">üë• Clientes</button>
    <button onclick="app.aba('relatorios',this)">üìä Relat√≥rios</button>
    <button onclick="app.aba('config',this)">‚öôÔ∏è Config</button>
  </aside>

  <main class="content">
    <div id="msgErro"></div>

    <section id="chamados">
      <h2>Chamados</h2>
      <button class="btn" onclick="app.abrirModal()">+ Abrir Chamado</button>
      <table style="margin-top:10px;">
        <thead>
          <tr>
            <th>ID</th><th>Data</th><th>Cliente</th><th>Solicitante</th>
            <th>T√©cnico</th><th>Descri√ß√£o</th><th>Status</th><th>A√ß√£o</th>
          </tr>
        </thead>
        <tbody id="listaChamados"></tbody>
      </table>
    </section>

    <section id="clientes" class="hidden">
      <h2>Clientes</h2>
      <button class="btn" onclick="app.abrirModalNovoCliente()" style="margin-bottom:20px;">+ Novo Cliente</button>
      <div id="listaClientes" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:15px;"></div>
    </section>

    <section id="relatorios" class="hidden">
      <h2>Relat√≥rios</h2>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin-bottom:15px;">
        <input id="fCliente" placeholder="Filtrar por Cliente">
        <input id="fSolicitante" placeholder="Filtrar por Solicitante">
        <input id="fTecnico" placeholder="Filtrar por T√©cnico">
        <input id="fCNPJ" placeholder="Filtrar por CNPJ/CPF">
        <input id="fDataInicio" type="date" placeholder="Data In√≠cio">
        <input id="fDataFim" type="date" placeholder="Data Fim">
        <select id="fStatus" style="padding:8px;border:1px solid #ddd;border-radius:6px;">
          <option value="">Todos os Status</option>
          <option value="pendente">Pendente</option>
          <option value="resolvido">Resolvido</option>
        </select>
        <button class="btn" onclick="app.relatorio()" style="grid-column:1/-1;">üîç Filtrar</button>
      </div>
      <table>
        <thead>
          <tr>
            <th>ID</th><th>Data</th><th>Cliente</th><th>Solicitante</th><th>T√©cnico</th><th>Descri√ß√£o</th><th>Status</th>
          </tr>
        </thead>
        <tbody id="resultadoRelatorio"></tbody>
      </table>
    </section>

    <section id="config" class="hidden">
      <h2>Configura√ß√µes</h2>
      <div style="background:#fff;padding:20px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1);max-width:600px;">
        <h3 style="margin-top:0;">Informa√ß√µes da Empresa</h3>
        <label style="display:block;margin-bottom:8px;font-weight:bold;">Nome da Empresa:</label>
        <input id="confEmpresa" placeholder="Nome da empresa" style="width:100%;margin-bottom:15px;padding:8px;border:1px solid #ddd;border-radius:4px;">
        
        <label style="display:block;margin-bottom:8px;font-weight:bold;">URL da Logo:</label>
        <input id="confLogo" placeholder="URL da logo" style="width:100%;margin-bottom:20px;padding:8px;border:1px solid #ddd;border-radius:4px;">
        
        <button class="btn" onclick="app.salvarConfig()" style="width:100%;padding:12px;font-size:16px;">üíæ Salvar Configura√ß√µes</button>
      </div>
    </section>
  </main>
</div>

<!-- MODAL NOVO CHAMADO -->
<div id="modal" class="modal">
  <div class="modal-content">
    <h3 style="margin-top:0;margin-bottom:15px;">Novo Chamado</h3>
    <div style="position:relative;">
      <input id="mCliente" placeholder="Cliente" oninput="app.filtrarClientes()">
      <div id="listaClientesDropdown" class="autocomplete-list"></div>
    </div>
    <input id="mSolicitante" placeholder="Solicitante">
    <input id="mTecnico" placeholder="T√©cnico">
    <textarea id="mDescricao" placeholder="Descri√ß√£o" style="height:80px;"></textarea>
    <button class="btn" onclick="app.salvarChamado()" style="width:100%;margin-bottom:8px;">Salvar</button>
    <button class="btn-danger" onclick="app.fecharModal()" style="width:100%;">Cancelar</button>
  </div>
</div>

<!-- MODAL ACESSOS REMOTOS -->
<div id="modalAcessos" class="modal">
  <div class="modal-content" style="width:550px;">
    <h3 style="margin-top:0;margin-bottom:15px;">üîê Acessos Remotos - <span id="clienteAcessoNome"></span></h3>
    
    <label style="font-weight:bold;display:block;margin-bottom:6px;">Nome/Tipo *</label>
    <input id="arNome" placeholder="Ex: Servidor 1, Caixa PDV">
    
    <label style="font-weight:bold;display:block;margin-bottom:6px;">Dados de Acesso</label>
    <textarea id="arDescricao" placeholder="IP, Usu√°rio, Senha, Porta..." style="height:80px;"></textarea>
    
    <button class="btn" onclick="app.salvarAcessoRemoto()" style="width:100%;margin-bottom:15px;">+ Adicionar Acesso</button>
    
    <h4 style="margin:10px 0;border-top:1px solid #ddd;padding-top:15px;">Acessos Cadastrados</h4>
    <div id="listaAcessosRemoto" style="max-height:250px;overflow-y:auto;margin-bottom:15px;"></div>
    
    <button class="btn-danger" onclick="app.fecharAcessos()" style="width:100%;">Fechar</button>
  </div>
</div>

<!-- MODAL EDITAR CHAMADO -->
<div id="modalEditarChamado" class="modal">
  <div class="modal-content">
    <h3 style="margin-top:0;margin-bottom:15px;">‚úèÔ∏è Editar Chamado <span id="idChamadoEditar"></span></h3>
    
    <label style="font-weight:bold;display:block;margin-bottom:6px;">Cliente</label>
    <input id="pCliente" style="margin-bottom:10px;padding:8px;border:1px solid #ddd;border-radius:4px;width:100%;">
    
    <label style="font-weight:bold;display:block;margin-bottom:6px;">Solicitante</label>
    <input id="pSolicitante" style="margin-bottom:10px;padding:8px;border:1px solid #ddd;border-radius:4px;width:100%;">
    
    <label style="font-weight:bold;display:block;margin-bottom:6px;">T√©cnico</label>
    <input id="pTecnico" style="margin-bottom:10px;padding:8px;border:1px solid #ddd;border-radius:4px;width:100%;">
    
    <label style="font-weight:bold;display:block;margin-bottom:6px;">Descri√ß√£o <span style="font-size:11px;color:#666;">(clique para adicionar atualiza√ß√£o)</span></label>
    <textarea id="pDescricao" placeholder="Clique aqui para adicionar uma atualiza√ß√£o na cronologia..." onclick="app.adicionarAtualizacaoPrompt()" style="width:100%;margin-bottom:15px;padding:8px;border:1px solid #ddd;border-radius:4px;height:80px;font-family:inherit;cursor:pointer;background:#fffef0;"></textarea>
    
    <div style="display:flex;gap:10px;margin-bottom:15px;">
      <button class="btn" onclick="app.salvarEdicaoChamado()" style="flex:1;">üíæ Salvar Altera√ß√µes</button>
      <button class="btn-danger" onclick="app.fecharModalEditar()" style="flex:1;">Fechar</button>
    </div>

    <h4 style="margin:15px 0 10px 0;border-top:1px solid #ddd;padding-top:15px;">Cronologia</h4>
    <div id="listaCronologia" style="max-height:250px;overflow-y:auto;"></div>
  </div>
</div>

<!-- MODAL CRONOLOGIA R√ÅPIDA -->
<div id="modalCronologiaRapida" class="modal">
  <div class="modal-content">
    <h3 style="margin-top:0;margin-bottom:15px;">üìã Cronologia - Chamado <span id="idCronologiaRapida"></span></h3>
    
    <label style="font-weight:bold;display:block;margin-bottom:6px;">Adicionar Atualiza√ß√£o</label>
    <textarea id="descricaoCronologiaRapida" placeholder="Digite a atualiza√ß√£o..." style="width:100%;margin-bottom:12px;padding:8px;border:1px solid #ddd;border-radius:4px;height:80px;font-family:inherit;"></textarea>
    
    <button class="btn" onclick="app.salvarCronologiaRapida()" style="width:100%;margin-bottom:15px;">‚ûï Adicionar</button>
    
    <h4 style="margin:10px 0;border-top:1px solid #ddd;padding-top:15px;">Hist√≥rico</h4>
    <div id="listaCronologiaRapida" style="max-height:300px;overflow-y:auto;font-size:13px;"></div>
    
    <button class="btn-danger" onclick="app.fecharCronologiaRapida()" style="width:100%;margin-top:15px;">Fechar</button>
  </div>
</div>

<!-- MODAL CRONOLOGIA VISUALIZA√á√ÉO (RELAT√ìRIO) -->
<div id="modalCronologiaVisualizacao" class="modal">
  <div class="modal-content">
    <h3 style="margin-top:0;margin-bottom:15px;">üìã Cronologia - Chamado <span id="idCronologiaVis"></span></h3>
    
    <h4 style="margin:10px 0;">Hist√≥rico</h4>
    <div id="listaCronologiaVis" style="max-height:400px;overflow-y:auto;font-size:13px;"></div>
    
    <button class="btn-danger" onclick="app.fecharCronologiaVisualizacao()" style="width:100%;margin-top:15px;">Fechar</button>
  </div>
</div>

<!-- MODAL NOVO CLIENTE -->
<div id="modalNovoCliente" class="modal">
  <div class="modal-content" style="width:500px;">
    <h3 style="margin-top:0;margin-bottom:15px;">‚ûï Novo Cliente</h3>
    
    <label style="font-weight:bold;display:block;margin-bottom:6px;">Nome do Cliente *</label>
    <input id="ncNome" placeholder="Nome (obrigat√≥rio)" style="width:100%;margin-bottom:12px;padding:8px;border:1px solid #ddd;border-radius:4px;">
    
    <label style="font-weight:bold;display:block;margin-bottom:6px;">Raz√£o Social</label>
    <input id="ncRazao" placeholder="Raz√£o Social (opcional)" style="width:100%;margin-bottom:12px;padding:8px;border:1px solid #ddd;border-radius:4px;">
    
    <label style="font-weight:bold;display:block;margin-bottom:6px;">CNPJ ou CPF</label>
    <input id="ncCNPJ" placeholder="CNPJ ou CPF (opcional)" style="width:100%;margin-bottom:12px;padding:8px;border:1px solid #ddd;border-radius:4px;">
    
    <label style="font-weight:bold;display:block;margin-bottom:6px;">Endere√ßo</label>
    <input id="ncEndereco" placeholder="Endere√ßo (opcional)" style="width:100%;margin-bottom:12px;padding:8px;border:1px solid #ddd;border-radius:4px;">
    
    <label style="font-weight:bold;display:block;margin-bottom:6px;">Dados do Cliente</label>
    <textarea id="ncObservacoes" placeholder="Observa√ß√µes e dados do cliente..." style="width:100%;margin-bottom:15px;padding:8px;border:1px solid #ddd;border-radius:4px;height:80px;font-family:inherit;"></textarea>
    
    <div style="display:flex;gap:10px;">
      <button class="btn" id="btnSalvarCliente" onclick="app.salvarNovoCliente()" style="flex:1;">üíæ Salvar Cliente</button>
      <button class="btn-danger" onclick="app.fecharModalNovoCliente()" style="flex:1;">Cancelar</button>
    </div>
  </div>
</div>

<script>
const SUPABASE_URL = 'https://boendmrotsttljydigld.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJvZW5kbXJvdHN0dGxqeWRpZ2xkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1OTI5NTksImV4cCI6MjA4MjE2ODk1OX0.k6vVvD6kNV8r-a9lR6jaTcAm1wz5c_jbTDnjKlpo0cE';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const app = {
  clienteAcessoAtual: null,
  acessoEditandoId: null,
  chamadoEditandoId: null,
  chamadoCronologiaRapidaId: null,

  mostrarErro(msg){
    const div = document.getElementById('msgErro');
    div.innerHTML = `<div class="erro">‚ùå ${msg}</div>`;
    setTimeout(() => div.innerHTML = '', 5000);
  },
  
  aba(id, btn){
    document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
    document.querySelectorAll('.sidebar button').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    if(id === 'clientes') this.carregarClientes();
  },
  
  abrirModal(){ 
    document.getElementById('modal').classList.add('active');
    document.getElementById('mCliente').value = '';
    document.getElementById('mSolicitante').value = '';
    document.getElementById('mTecnico').value = '';
    document.getElementById('mDescricao').value = '';
  },
  
  fecharModal(){ 
    document.getElementById('modal').classList.remove('active');
  },

  filtrarClientes(){
    const input = document.getElementById('mCliente').value.toLowerCase();
    const dropdown = document.getElementById('listaClientesDropdown');
    
    if(input.length === 0){
      dropdown.classList.remove('active');
      return;
    }
    
    sb.from('clientes').select('nome').then(({data}) => {
      dropdown.innerHTML = '';
      if(!data || data.length === 0){dropdown.classList.remove('active'); return;}
      const filtrados = data.filter(c => c.nome.toLowerCase().includes(input));
      if(filtrados.length === 0){dropdown.classList.remove('active'); return;}
      filtrados.forEach(cliente => {
        const item = document.createElement('div');
        item.className = 'autocomplete-item';
        item.textContent = cliente.nome;
        item.onclick = () => {
          document.getElementById('mCliente').value = cliente.nome;
          dropdown.classList.remove('active');
        };
        dropdown.appendChild(item);
      });
      dropdown.classList.add('active');
    });
  },

  async carregarChamados(){
    try {
      const {data, error} = await sb.from('chamados').select('*').order('id',{ascending:false});
      if(error) return this.mostrarErro('Erro ao carregar chamados');
      const tbody = document.getElementById('listaChamados');
      tbody.innerHTML='';
      if(!data || data.length===0){tbody.innerHTML='<tr><td colspan="8">Nenhum chamado</td></tr>';return;}
      
      const hoje = new Date();
      const dataHojeFormatada = hoje.getFullYear() + '-' + String(hoje.getMonth() + 1).padStart(2, '0') + '-' + String(hoje.getDate()).padStart(2, '0');
      
      const chamadosFiltrados = data.filter(c => {
        const dataChamado = c.created_at.substring(0, 10);
        const ehDeHoje = dataChamado === dataHojeFormatada;
        const ehPendente = c.status === 'pendente';
        
        if(ehDeHoje) return true;
        if(ehPendente) return true;
        return false;
      });
      
      if(chamadosFiltrados.length === 0){
        tbody.innerHTML='<tr><td colspan="8">Nenhum chamado pendente ou de hoje</td></tr>';
        return;
      }
      
      chamadosFiltrados.forEach(c=>{
        tbody.innerHTML+=`<tr>
          <td>${c.id}</td>
          <td>${c.created_at ? new Date(c.created_at).toLocaleDateString('pt-BR') : '--'}</td>
          <td>${c.cliente}</td>
          <td>${c.solicitante}</td>
          <td>${c.tecnico}</td>
          <td style="cursor:pointer;text-decoration:underline;color:#2563eb;" onclick="app.abrirCronologiaRapida(${c.id})">${c.descricao}</td>
          <td><span class="status ${c.status}">${c.status}</span></td>
          <td><button class="btn" onclick="app.abrirModalEditar(${c.id})" style="font-size:11px;padding:4px 6px;">‚úèÔ∏è</button></td>
        </tr>`;
      });
    } catch(e){ this.mostrarErro('Erro: '+e.message); }
  },

  async salvarChamado(){
    if(!document.getElementById('mCliente').value||!document.getElementById('mSolicitante').value||!document.getElementById('mTecnico').value||!document.getElementById('mDescricao').value){
      alert('Preencha todos os campos!');
      return;
    }
    try{
      const {error} = await sb.from('chamados').insert({
        cliente: document.getElementById('mCliente').value,
        solicitante: document.getElementById('mSolicitante').value,
        tecnico: document.getElementById('mTecnico').value,
        descricao: document.getElementById('mDescricao').value,
        status: 'pendente',
        created_at: new Date().toISOString()
      });
      if(error) return this.mostrarErro('Erro ao salvar');
      this.fecharModal();
      this.carregarChamados();
      this.carregarClientes();
    }catch(e){ this.mostrarErro('Erro: '+e.message); }
  },

  async carregarClientes(){
    try{
      const {data} = await sb.from('clientes').select('*');
      const div = document.getElementById('listaClientes');
      div.innerHTML = '';
      if(!data || data.length === 0){
        div.innerHTML = '<p style="grid-column:1/-1;text-align:center;color:#999;">Nenhum cliente</p>';
        return;
      }
      data.forEach(c=>{
        div.innerHTML+=`
          <div class="cliente-card">
            <h3>üë§ ${c.nome}</h3>
            ${c.razao_social ? `<p style="font-size:12px;color:#666;"><strong>Raz√£o:</strong> ${c.razao_social}</p>` : ''}
            ${c.cnpj ? `<p style="font-size:12px;color:#666;"><strong>CNPJ/CPF:</strong> ${c.cnpj}</p>` : ''}
            ${c.endereco ? `<p style="font-size:12px;color:#666;"><strong>Endere√ßo:</strong> ${c.endereco}</p>` : ''}
            ${c.observacoes ? `<p style="font-size:12px;color:#888;font-style:italic;margin-top:8px;">${c.observacoes}</p>` : ''}
            <div class="cliente-actions">
              <button class="btn" onclick="app.abrirModalEditarCliente('${c.nome.replace(/'/g, "\\'")}')" style="flex:1;">‚úèÔ∏è Alterar</button>
              <button class="btn" onclick="app.abrirAcessos('${c.nome.replace(/'/g, "\\'")}')" style="flex:1;">üîê Acessos</button>
              <button class="btn-danger" onclick="app.excluirCliente('${c.nome.replace(/'/g, "\\'")}')" style="flex:1;">üóëÔ∏è Excluir</button>
            </div>
          </div>
        `;
      });
    }catch(e){console.error(e);}
  },

  abrirAcessos(cliente){
    this.clienteAcessoAtual = cliente;
    this.acessoEditandoId = null;
    document.getElementById('clienteAcessoNome').innerText = cliente;
    document.getElementById('arNome').value = '';
    document.getElementById('arDescricao').value = '';
    document.getElementById('modalAcessos').classList.add('active');
    this.carregarAcessosRemoto(cliente);
  },

  fecharAcessos(){
    document.getElementById('modalAcessos').classList.remove('active');
  },

  async carregarAcessosRemoto(cliente){
    try{
      const {data} = await sb.from('acessos_remotos').select('*').eq('cliente_nome', cliente).order('id',{ascending:false});
      const lista = document.getElementById('listaAcessosRemoto');
      lista.innerHTML = '';
      if(!data || data.length === 0){
        lista.innerHTML = '<p style="text-align:center;color:#999;">Nenhum acesso cadastrado</p>';
        return;
      }
      data.forEach(a => {
        lista.innerHTML += `
          <div class="acesso-item">
            <strong>${a.nome}</strong>
            <p>${a.descricao || '(sem dados)'}</p>
            <div class="botoes">
              <button class="btn" onclick="app.editarAcesso(${a.id},'${a.nome.replace(/'/g, "\\'")}','${(a.descricao || '').replace(/'/g, "\\'").replace(/\n/g, '\\n')}')" style="flex:1;">‚úèÔ∏è Editar</button>
              <button class="btn-danger" onclick="app.excluirAcesso(${a.id})" style="flex:1;">üóëÔ∏è Deletar</button>
            </div>
          </div>
        `;
      });
    }catch(e){console.error(e);}
  },

  async salvarAcessoRemoto(){
    const nome = document.getElementById('arNome').value.trim();
    const desc = document.getElementById('arDescricao').value.trim();
    if(!nome){alert('Nome √© obrigat√≥rio!');return;}
    try{
      const {error} = await sb.from('acessos_remotos').insert({
        cliente_nome: this.clienteAcessoAtual,
        nome: nome,
        descricao: desc || null
      });
      if(error) return this.mostrarErro('Erro ao salvar');
      document.getElementById('arNome').value = '';
      document.getElementById('arDescricao').value = '';
      this.carregarAcessosRemoto(this.clienteAcessoAtual);
    }catch(e){this.mostrarErro('Erro: '+e.message);}
  },

  editarAcesso(id, nome, descricao){
    const novaDesc = prompt(`Editar acesso: ${nome}\n\nDados de acesso:`, descricao);
    if(novaDesc !== null){
      this.salvarEditacaoAcesso(id, novaDesc);
    }
  },

  async salvarEditacaoAcesso(id, descricao){
    try{
      const {error} = await sb.from('acessos_remotos').update({descricao: descricao || null}).eq('id', id);
      if(error) return this.mostrarErro('Erro ao atualizar');
      this.carregarAcessosRemoto(this.clienteAcessoAtual);
    }catch(e){this.mostrarErro('Erro: '+e.message);}
  },

  async excluirAcesso(id){
    if(!confirm('Excluir este acesso?')) return;
    try{
      const {error} = await sb.from('acessos_remotos').delete().eq('id', id);
      if(error) return this.mostrarErro('Erro ao excluir');
      this.carregarAcessosRemoto(this.clienteAcessoAtual);
    }catch(e){this.mostrarErro('Erro: '+e.message);}
  },

  async relatorio(){
    try{
      let q = sb.from('chamados').select('*');
      if(document.getElementById('fCliente').value) q = q.ilike('cliente','%'+document.getElementById('fCliente').value+'%');
      if(document.getElementById('fSolicitante').value) q = q.ilike('solicitante','%'+document.getElementById('fSolicitante').value+'%');
      if(document.getElementById('fTecnico').value) q = q.ilike('tecnico','%'+document.getElementById('fTecnico').value+'%');
      if(document.getElementById('fStatus').value) q = q.eq('status',document.getElementById('fStatus').value);
      
      const {data,error} = await q.order('created_at',{ascending:false});
      if(error) return this.mostrarErro('Erro no relat√≥rio: ' + error.message);
      
      let resultados = data || [];
      
      // Filtro por CNPJ
      const cnpjFiltro = document.getElementById('fCNPJ').value.trim();
      if(cnpjFiltro){
        const {data: clientes} = await sb.from('clientes').select('nome, cnpj').ilike('cnpj', '%'+cnpjFiltro+'%');
        const nomesClientes = clientes ? clientes.map(c => c.nome) : [];
        resultados = resultados.filter(c => nomesClientes.includes(c.cliente));
      }
      
      // Filtro por per√≠odo
      const dataInicio = document.getElementById('fDataInicio').value;
      const dataFim = document.getElementById('fDataFim').value;
      
      if(dataInicio || dataFim){
        resultados = resultados.filter(c => {
          const dataChamado = c.created_at.substring(0, 10);
          
          if(dataInicio && dataChamado < dataInicio) return false;
          if(dataFim && dataChamado > dataFim) return false;
          
          return true;
        });
      }
      
      const tbody = document.getElementById('resultadoRelatorio');
      tbody.innerHTML = '';
      if(!resultados || resultados.length === 0){
        tbody.innerHTML = '<tr><td colspan="6">Nenhum resultado</td></tr>';
        return;
      }
      resultados.forEach(c=>{
        tbody.innerHTML+=`<tr>
          <td>${c.id}</td>
          <td>${c.created_at ? new Date(c.created_at).toLocaleDateString('pt-BR') : '--'}</td>
          <td>${c.cliente}</td>
          <td>${c.solicitante}</td>
          <td>${c.tecnico}</td>
          <td style="cursor:pointer;color:#2563eb;text-decoration:underline;" onclick="app.abrirCronologiaRelatorio(${c.id})">${c.descricao}</td>
          <td><span class="status ${c.status}">${c.status}</span></td>
        </tr>`;
      });
    }catch(e){this.mostrarErro('Erro: '+e.message);}
  },

  async salvarConfig(){
    const nome = document.getElementById('confEmpresa').value;
    const logo = document.getElementById('confLogo').value;
    if(nome) document.getElementById('nomeEmpresa').innerText = nome;
    if(logo){
      document.getElementById('logoEmpresa').src = logo;
      document.getElementById('logoEmpresa').classList.remove('hidden');
    }
    alert('‚úÖ Configura√ß√µes salvas!');
  },

  async carregarConfig(){
    try{
      const {data} = await sb.from('configuracoes').select('*').eq('id',1).single();
      if(!data) return;
      document.getElementById('confEmpresa').value = data.empresa || '';
      document.getElementById('confLogo').value = data.logo_url || '';
      if(data.empresa) document.getElementById('nomeEmpresa').innerText = data.empresa;
      if(data.logo_url){
        document.getElementById('logoEmpresa').src = data.logo_url;
        document.getElementById('logoEmpresa').classList.remove('hidden');
      }
    }catch(e){console.error(e);}
  },

  async abrirModalEditar(chamadoId){
    try{
      const {data: chamado} = await sb.from('chamados').select('*').eq('id', chamadoId).single();
      if(!chamado) return this.mostrarErro('Chamado n√£o encontrado');
      
      const {data: cronologia} = await sb.from('cronologia_chamados').select('*').eq('chamado_id', chamadoId).order('data',{ascending:true});
      
      document.getElementById('idChamadoEditar').innerText = chamadoId;
      document.getElementById('pCliente').value = chamado.cliente;
      document.getElementById('pSolicitante').value = chamado.solicitante;
      document.getElementById('pTecnico').value = chamado.tecnico;
      document.getElementById('pDescricao').value = chamado.descricao;
      document.getElementById('pDescricao').placeholder = `Descri√ß√£o: ${chamado.descricao}\n\nClique para adicionar atualiza√ß√£o na cronologia...`;
      
      let cronHtml = '';
      if(cronologia && cronologia.length > 0){
        cronHtml = cronologia.map(c => `
          <div style="padding:10px;background:#f0f0f0;border-radius:4px;margin-bottom:8px;border-left:3px solid #2563eb;">
            <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:6px;">
              <span style="font-weight:bold;font-size:12px;">${new Date(c.data).toLocaleString('pt-BR')}</span>
              <div style="display:flex;gap:5px;">
                <button class="btn" onclick="app.editarCronologia(${c.id},'${(c.descricao || '').replace(/'/g, "\\'").replace(/\n/g, '\\n')}')" style="padding:3px 8px;font-size:10px;background:#16a34a;">‚úèÔ∏è</button>
                <button class="btn-danger" onclick="app.excluirCronologia(${c.id})" style="padding:3px 8px;font-size:10px;">üóëÔ∏è</button>
              </div>
            </div>
            <p style="margin:0;word-break:break-word;white-space:pre-wrap;font-size:12px;">${c.descricao}</p>
          </div>
        `).join('');
      } else {
        cronHtml = '<p style="color:#999;text-align:center;padding:20px;">Nenhuma atualiza√ß√£o</p>';
      }
      document.getElementById('listaCronologia').innerHTML = cronHtml;
      
      this.chamadoEditandoId = chamadoId;
      document.getElementById('modalEditarChamado').classList.add('active');
    }catch(e){this.mostrarErro('Erro: '+e.message);}
  },

  fecharModalEditar(){
    document.getElementById('modalEditarChamado').classList.remove('active');
  },

  async salvarEdicaoChamado(){
    try{
      const {error} = await sb.from('chamados').update({
        cliente: document.getElementById('pCliente').value,
        solicitante: document.getElementById('pSolicitante').value,
        tecnico: document.getElementById('pTecnico').value
      }).eq('id', this.chamadoEditandoId);
      
      if(error) return this.mostrarErro('Erro ao salvar');
      alert('‚úÖ Chamado atualizado!');
      this.fecharModalEditar();
      this.carregarChamados();
    }catch(e){this.mostrarErro('Erro: '+e.message);}
  },

  async adicionarAtualizacaoPrompt(){
    const desc = prompt('Adicionar atualiza√ß√£o na cronologia:');
    if(desc !== null && desc.trim()){
      try{
        const {error} = await sb.from('cronologia_chamados').insert({
          chamado_id: this.chamadoEditandoId,
          descricao: desc.trim(),
          data: new Date().toISOString()
        });
        if(error) return this.mostrarErro('Erro ao salvar');
        this.abrirModalEditar(this.chamadoEditandoId);
      }catch(e){this.mostrarErro('Erro: '+e.message);}
    }
  },

  async salvarAtualizacaoChamado(){
    const desc = document.getElementById('pDescricao').value.trim();
    if(!desc){alert('Digite uma atualiza√ß√£o!');return;}
    try{
      const {error} = await sb.from('cronologia_chamados').insert({
        chamado_id: this.chamadoEditandoId,
        descricao: desc,
        data: new Date().toISOString()
      });
      if(error) return this.mostrarErro('Erro ao salvar atualiza√ß√£o');
      document.getElementById('pDescricao').value = '';
      this.abrirModalEditar(this.chamadoEditandoId);
    }catch(e){this.mostrarErro('Erro: '+e.message);}
  },

  async editarCronologia(cronId, descricao){
    const novaDesc = prompt('Editar atualiza√ß√£o:', descricao);
    if(novaDesc !== null && novaDesc.trim()){
      try{
        const {error} = await sb.from('cronologia_chamados').update({
          descricao: novaDesc.trim()
        }).eq('id', cronId);
        if(error) return this.mostrarErro('Erro ao atualizar');
        this.abrirModalEditar(this.chamadoEditandoId);
      }catch(e){this.mostrarErro('Erro: '+e.message);}
    }
  },

  async excluirCronologia(cronId){
    if(!confirm('Excluir esta atualiza√ß√£o?')) return;
    try{
      const {error} = await sb.from('cronologia_chamados').delete().eq('id', cronId);
      if(error) return this.mostrarErro('Erro ao excluir');
      this.abrirModalEditar(this.chamadoEditandoId);
    }catch(e){this.mostrarErro('Erro: '+e.message);}
  },

  async abrirCronologiaRapida(chamadoId){
    try{
      const {data: cronologia} = await sb.from('cronologia_chamados').select('*').eq('chamado_id', chamadoId).order('data',{ascending:true});
      
      let cronHtml = '';
      if(cronologia && cronologia.length > 0){
        cronHtml = cronologia.map(c => `
          <div style="padding:10px;background:#f0f0f0;border-radius:4px;margin-bottom:8px;border-left:3px solid #2563eb;">
            <span style="font-weight:bold;font-size:12px;">${new Date(c.data).toLocaleString('pt-BR')}</span>
            <p style="margin:6px 0 0 0;word-break:break-word;white-space:pre-wrap;font-size:12px;">${c.descricao}</p>
          </div>
        `).join('');
      } else {
        cronHtml = '<p style="color:#999;text-align:center;padding:20px;">Nenhuma atualiza√ß√£o</p>';
      }
      
      document.getElementById('idCronologiaRapida').innerText = chamadoId;
      document.getElementById('listaCronologiaRapida').innerHTML = cronHtml;
      document.getElementById('descricaoCronologiaRapida').value = '';
      this.chamadoCronologiaRapidaId = chamadoId;
      document.getElementById('modalCronologiaRapida').classList.add('active');
    }catch(e){this.mostrarErro('Erro: '+e.message);}
  },

  fecharCronologiaRapida(){
    document.getElementById('modalCronologiaRapida').classList.remove('active');
  },

  async salvarCronologiaRapida(){
    const desc = document.getElementById('descricaoCronologiaRapida').value.trim();
    if(!desc){alert('Digite uma atualiza√ß√£o!');return;}
    try{
      const {error} = await sb.from('cronologia_chamados').insert({
        chamado_id: this.chamadoCronologiaRapidaId,
        descricao: desc,
        data: new Date().toISOString()
      });
      if(error) return this.mostrarErro('Erro ao salvar');
      this.abrirCronologiaRapida(this.chamadoCronologiaRapidaId);
    }catch(e){this.mostrarErro('Erro: '+e.message);}
  },

  abrirModalNovoCliente(){
    document.getElementById('modalNovoCliente').classList.add('active');
    document.getElementById('modalNovoCliente').dataset.nomeOriginal = '';
    document.querySelector('#modalNovoCliente h3').innerText = '‚ûï Novo Cliente';
    document.getElementById('btnSalvarCliente').onclick = function() { app.salvarNovoCliente(); };
    document.getElementById('ncNome').value = '';
    document.getElementById('ncRazao').value = '';
    document.getElementById('ncCNPJ').value = '';
    document.getElementById('ncEndereco').value = '';
    document.getElementById('ncObservacoes').value = '';
  },

  fecharModalNovoCliente(){
    document.getElementById('modalNovoCliente').classList.remove('active');
    document.getElementById('modalNovoCliente').dataset.nomeOriginal = '';
    document.querySelector('#modalNovoCliente h3').innerText = '‚ûï Novo Cliente';
    document.getElementById('ncNome').value = '';
    document.getElementById('ncRazao').value = '';
    document.getElementById('ncCNPJ').value = '';
    document.getElementById('ncEndereco').value = '';
    document.getElementById('ncObservacoes').value = '';
  },

  async salvarNovoCliente(){
    const nome = document.getElementById('ncNome').value.trim();
    if(!nome){
      alert('Nome do cliente √© obrigat√≥rio!');
      return;
    }
    try{
      const {error} = await sb.from('clientes').insert({
        nome: nome,
        razao_social: document.getElementById('ncRazao').value.trim() || null,
        cnpj: document.getElementById('ncCNPJ').value.trim() || null,
        endereco: document.getElementById('ncEndereco').value.trim() || null,
        observacoes: document.getElementById('ncObservacoes').value.trim() || null
      });
      if(error) return this.mostrarErro('Erro ao salvar cliente');
      alert('‚úÖ Cliente cadastrado com sucesso!');
      this.fecharModalNovoCliente();
      this.carregarClientes();
    }catch(e){this.mostrarErro('Erro: '+e.message);}
  },

  async abrirModalEditarCliente(nomeCliente){
    try{
      const {data} = await sb.from('clientes').select('*').eq('nome', nomeCliente).single();
      if(!data) return this.mostrarErro('Cliente n√£o encontrado');
      
      document.getElementById('ncNome').value = data.nome || '';
      document.getElementById('ncRazao').value = data.razao_social || '';
      document.getElementById('ncCNPJ').value = data.cnpj || '';
      document.getElementById('ncEndereco').value = data.endereco || '';
      document.getElementById('ncObservacoes').value = data.observacoes || '';
      
      document.getElementById('modalNovoCliente').dataset.nomeOriginal = nomeCliente;
      document.querySelector('#modalNovoCliente h3').innerText = '‚úèÔ∏è Editar Cliente';
      document.getElementById('btnSalvarCliente').onclick = function() { app.salvarEdicaoCliente(); };
      document.getElementById('modalNovoCliente').classList.add('active');
    }catch(e){this.mostrarErro('Erro: '+e.message);}
  },

  async salvarEdicaoCliente(){
    const nomeOriginal = document.getElementById('modalNovoCliente').dataset.nomeOriginal;
    const novoNome = document.getElementById('ncNome').value.trim();
    
    if(!novoNome){
      alert('Nome do cliente √© obrigat√≥rio!');
      return;
    }
    
    try{
      const {error} = await sb.from('clientes').update({
        nome: novoNome,
        razao_social: document.getElementById('ncRazao').value.trim() || null,
        cnpj: document.getElementById('ncCNPJ').value.trim() || null,
        endereco: document.getElementById('ncEndereco').value.trim() || null,
        observacoes: document.getElementById('ncObservacoes').value.trim() || null
      }).eq('nome', nomeOriginal);
      
      if(error) return this.mostrarErro('Erro ao atualizar cliente');
      alert('‚úÖ Cliente atualizado com sucesso!');
      this.fecharModalNovoCliente();
      this.carregarClientes();
    }catch(e){this.mostrarErro('Erro: '+e.message);}
  },

  async excluirCliente(nomeCliente){
    try{
      const {data: chamados} = await sb.from('chamados').select('id').eq('cliente', nomeCliente).limit(1);
      
      if(chamados && chamados.length > 0){
        alert('‚ùå N√£o √© poss√≠vel excluir!\n\nEste cliente possui chamados associados.');
        return;
      }
      
      if(!confirm(`Tem certeza que deseja excluir o cliente "${nomeCliente}"?`)){
        return;
      }
      
      const {error} = await sb.from('clientes').delete().eq('nome', nomeCliente);
      if(error) return this.mostrarErro('Erro ao excluir cliente');
      
      alert('‚úÖ Cliente exclu√≠do com sucesso!');
      this.carregarClientes();
    }catch(e){this.mostrarErro('Erro: '+e.message);}
  },

  async abrirCronologiaRelatorio(chamadoId){
    try{
      const {data: cronologia} = await sb.from('cronologia_chamados').select('*').eq('chamado_id', chamadoId).order('data',{ascending:true});
      
      let cronHtml = '';
      if(cronologia && cronologia.length > 0){
        cronHtml = cronologia.map(c => `
          <div style="padding:10px;background:#f0f0f0;border-radius:4px;margin-bottom:8px;border-left:3px solid #2563eb;">
            <span style="font-weight:bold;font-size:12px;">${new Date(c.data).toLocaleString('pt-BR')}</span>
            <p style="margin:6px 0 0 0;word-break:break-word;white-space:pre-wrap;font-size:12px;">${c.descricao}</p>
          </div>
        `).join('');
      } else {
        cronHtml = '<p style="color:#999;text-align:center;padding:20px;">Nenhuma atualiza√ß√£o</p>';
      }
      
      document.getElementById('idCronologiaVis').innerText = chamadoId;
      document.getElementById('listaCronologiaVis').innerHTML = cronHtml;
      document.getElementById('modalCronologiaVisualizacao').classList.add('active');
    }catch(e){this.mostrarErro('Erro: '+e.message);}
  },

  fecharCronologiaVisualizacao(){
    document.getElementById('modalCronologiaVisualizacao').classList.remove('active');
  },



  async abrirPainel(chamadoId){
    try{
      const {data: chamado} = await sb.from('chamados').select('*').eq('id', chamadoId).single();
      if(!chamado) return this.mostrarErro('Chamado n√£o encontrado');
      
      const {data: cronologia} = await sb.from('cronologia_chamados').select('*').eq('chamado_id', chamadoId).order('data',{ascending:true});
      
      let cronHtml = '';
      if(cronologia && cronologia.length > 0){
        cronHtml = cronologia.map(c => `
          <div style="padding:8px;background:#f0f0f0;border-radius:4px;margin-bottom:6px;font-size:12px;">
            <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
              <span style="font-weight:bold;">${new Date(c.data).toLocaleString('pt-BR')}</span>
              <button class="btn-danger" onclick="app.excluirCronologia(${c.id})" style="padding:2px 6px;font-size:10px;">üóëÔ∏è</button>
            </div>
            <p style="margin:0;word-break:break-word;white-space:pre-wrap;">${c.descricao}</p>
          </div>
        `).join('');
      } else {
        cronHtml = '<p style="color:#999;text-align:center;">Nenhuma atualiza√ß√£o</p>';
      }
      
      const painel = document.getElementById('painel');
      const conteudo = document.getElementById('painelConteudo');
      
      conteudo.innerHTML = `
        <label style="font-weight:bold;display:block;margin-bottom:6px;">Cliente</label>
        <input id="pCliente" value="${chamado.cliente}" style="width:100%;margin-bottom:10px;padding:6px;border:1px solid #ddd;border-radius:4px;">
        
        <label style="font-weight:bold;display:block;margin-bottom:6px;">Solicitante</label>
        <input id="pSolicitante" value="${chamado.solicitante}" style="width:100%;margin-bottom:10px;padding:6px;border:1px solid #ddd;border-radius:4px;">
        
        <label style="font-weight:bold;display:block;margin-bottom:6px;">T√©cnico</label>
        <input id="pTecnico" value="${chamado.tecnico}" style="width:100%;margin-bottom:10px;padding:6px;border:1px solid #ddd;border-radius:4px;">
        
        <label style="font-weight:bold;display:block;margin-bottom:6px;">Descri√ß√£o</label>
        <textarea id="pDescricao" style="width:100%;margin-bottom:10px;padding:6px;border:1px solid #ddd;border-radius:4px;height:80px;font-family:inherit;">${chamado.descricao}</textarea>
        
        <button class="btn" onclick="app.salvarEdicaoChamado(${chamadoId})" style="width:100%;margin-bottom:8px;font-size:13px;">üíæ Salvar</button>
        
        <h4 style="margin:15px 0 8px 0;border-top:1px solid #ddd;padding-top:10px;">Cronologia</h4>
        <div style="max-height:200px;overflow-y:auto;margin-bottom:10px;">
          ${cronHtml}
        </div>
        
        <label style="font-weight:bold;display:block;margin-bottom:6px;font-size:13px;">Adicionar Atualiza√ß√£o</label>
        <textarea id="pAtualizacao" placeholder="Descri√ß√£o..." style="width:100%;padding:6px;border:1px solid #ddd;border-radius:4px;height:60px;margin-bottom:8px;font-family:inherit;font-size:12px;"></textarea>
        
        <button class="btn" onclick="app.adicionarAtualizacao(${chamadoId})" style="width:100%;font-size:13px;">‚ûï Adicionar</button>
      `;
      
      document.getElementById('painelTitulo').innerText = `Chamado #${chamadoId}`;
      painel.style.display = 'block';
      painel.scrollTop = 0;
    }catch(e){this.mostrarErro('Erro: '+e.message);}
  },

  async init(){
    await this.carregarConfig();
    this.carregarChamados();
  }
};

app.init();
</script>

</body>
</html>
