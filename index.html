<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Sistema de Chamados</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; font-family: Arial, sans-serif; background: #f4f6f8; min-height: 100vh; }
    .layout { display: flex; min-height: 100vh; }
    .sidebar { width: 260px; background: #111827; color: #fff; padding: 20px; overflow-y: auto; }
    .sidebar img { max-width: 100%; max-height: 60px; margin-bottom: 10px; }
    .sidebar h1 { font-size: 16px; margin: 5px 0; }
    .sidebar button { width: 100%; background: none; border: none; color: #d1d5db; padding: 12px; text-align: left; border-radius: 6px; cursor: pointer; margin-bottom: 8px; transition: 0.2s; }
    .sidebar button.active, .sidebar button:hover { background: #2563eb; color: #fff; }
    .sidebar .user-info { border-top: 1px solid #374151; margin-top: 20px; padding-top: 15px; font-size: 12px; color: #9ca3af; }
    .content { flex: 1; padding: 30px; overflow-y: auto; }
    .hidden { display: none; }
    .btn { background: #2563eb; color: #fff; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; transition: 0.2s; }
    .btn:hover { background: #1e40af; }
    .btn-danger { background: #dc2626; color: #fff; border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer; transition: 0.2s; }
    .btn-danger:hover { background: #b91c1c; }
    table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 8px; margin-top: 15px; }
    th, td { padding: 10px; border-bottom: 1px solid #e5e7eb; font-size: 13px; }
    th { background: #f9fafb; font-size: 12px; text-transform: uppercase; }
    .status { padding: 4px 10px; border-radius: 999px; font-size: 12px; cursor: pointer; }
    .pendente { background: #fef3c7; color: #92400e; }
    .resolvido { background: #dcfce7; color: #166534; }
    .modal { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.6); display: none; align-items: center; justify-content: center; z-index: 1000; }
    .modal.active { display: flex; }
    .modal-content { background: #fff; padding: 20px; border-radius: 10px; max-height: 90vh; overflow-y: auto; }
    .modal-content input, .modal-content textarea, .modal-content select { width: 100%; margin-bottom: 10px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; }
    .erro { color: #dc2626; padding: 10px; background: #fee; border-radius: 6px; margin: 10px 0; }
    .sucesso { color: #166534; padding: 10px; background: #dcfce7; border-radius: 6px; margin: 10px 0; }
    .login-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; background: #f4f6f8; }
    .login-box { background: #fff; padding: 40px; border-radius: 10px; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15); width: 100%; max-width: 400px; }
    .login-box h1 { text-align: center; color: #1f2937; margin-bottom: 30px; }
    .login-box input { width: 100%; margin-bottom: 15px; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
    .login-box .btn { width: 100%; padding: 12px; font-size: 16px; margin-bottom: 15px; }
    .cliente-card { background: #fff; border-radius: 8px; padding: 15px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); }
    .cliente-card h3 { margin: 0 0 10px 0; color: #1f2937; }
    .cliente-actions { display: flex; gap: 8px; margin-top: 12px; }
    .cliente-actions button { flex: 1; font-size: 12px; padding: 8px; }
    .menu-toggle { display: none; }
    @media (max-width: 768px) {
      .layout { flex-direction: column; }
      .sidebar { position: sticky; top: 0; width: 100%; padding: 14px 12px; z-index: 1000; display: flex; flex-direction: column; align-items: center; }
      .user-info { width: 100%; text-align: center; border: none !important; padding: 0 !important; margin-bottom: 10px; }
      .user-info #usuarioNome { font-size: 14px; font-weight: bold; color: #fff; display: block; }
      .user-info #usuarioEmail { font-size: 11px; color: #9ca3af; display: block; margin-top: 2px; }
      .user-info button { display: none; }
      .sidebar img { height: 40px; margin: 6px 0; }
      .sidebar h1 { font-size: 14px; text-align: center; margin: 4px 0 10px 0; white-space: nowrap; }
      .menu-toggle { display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 22px; background: none; border: none; color: #fff; cursor: pointer; margin: 6px 0 10px 0; }
      .menu-toggle::after { content: "MENU"; font-size: 12px; font-weight: bold; letter-spacing: 1px; color: #9ca3af; margin-top: 4px; }
      .menu-items { display: none; width: 100%; margin-top: 8px; text-align: center; }
      .sidebar.open .menu-items { display: block; }
      .menu-items button { width: 100%; padding: 12px; text-align: center; border-top: 1px solid #1f2937; font-size: 14px; }
      .content { padding: 12px; }
      .modal-content { width: 90%; max-width: 500px; }
    }
  </style>
</head>
<body>

<div id="telaLogin" class="login-container">
  <div class="login-box">
    <h1>üîê Sistema de Chamados</h1>
    <div id="msgLogin"></div>
    <input id="loginEmail" type="email" placeholder="Email" autocomplete="email">
    <input id="loginSenha" type="password" placeholder="Senha" autocomplete="current-password">
    <button class="btn" id="btnLogin" style="width: 100%;">Entrar</button>
  </div>
</div>

<div id="appContainer" class="hidden">
  <div class="layout">
    <aside class="sidebar">
      <img id="logoEmpresa" class="hidden">
      <h1 id="nomeEmpresa">Sistema</h1>
      <button id="menuToggle" class="menu-toggle">‚ò∞</button>
      <div class="menu-items">
        <button class="active" onclick="app.aba('chamados',this)">üìã Chamados</button>
        <button onclick="app.aba('clientes',this)">üë• Clientes</button>
        <button onclick="app.aba('relatorios',this)">üìä Relat√≥rios</button>
        <button onclick="app.aba('usuarios',this)">üë®‚Äçüíº Usu√°rios</button>
        <button onclick="app.aba('auditoria',this)">üîç Auditoria</button>
        <button onclick="app.aba('config',this)">‚öôÔ∏è Config</button>
      </div>
      <div class="user-info">
        <div>üë§ <span id="usuarioNome">Usu√°rio</span></div>
        <div style="margin-top:10px;color:#6b7280;"><small id="usuarioEmail"></small></div>
        <button class="btn" id="btnLogout" style="width:100%;margin-top:15px;padding:8px;font-size:12px;">Sair</button>
      </div>
    </aside>

    <main class="content">
      <div id="msgErro"></div>
      <section id="chamados">
        <h2>Chamados</h2>
        <button class="btn" onclick="app.abrirModal()">+ Abrir Chamado</button>
        <table><thead><tr><th>ID</th><th>Data</th><th>Cliente</th><th>Solicitante</th><th>T√©cnico</th><th>Categoria</th><th>Status</th><th>A√ß√£o</th></tr></thead><tbody id="listaChamados"></tbody></table>
      </section>
      <section id="clientes" class="hidden">
        <h2>Clientes</h2>
        <button class="btn" onclick="app.abrirModalNovoCliente()" style="margin-bottom:20px;">+ Novo Cliente</button>
        <div id="listaClientes" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:15px;"></div>
      </section>
      <section id="relatorios" class="hidden">
        <h2>Relat√≥rios</h2>
        <div style="background:#fff;padding:20px;border-radius:8px;margin-bottom:20px;">
          <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:15px;margin-bottom:15px;">
            <div>
              <label style="font-weight:bold;display:block;margin-bottom:6px;">Cliente</label>
              <div style="position:relative;"><input id="fCliente" placeholder="Filtrar por Cliente" autocomplete="off" oninput="app.buscarClientesFiltro()" onblur="setTimeout(() => { document.getElementById('listaClientesFiltro').style.display = 'none'; }, 200)" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;"><div id="listaClientesFiltro" style="position:absolute;top:100%;left:0;right:0;background:#fff;border:1px solid #ddd;border-radius:4px;max-height:150px;overflow-y:auto;z-index:10;display:none;"></div></div>
            </div>
			
			<div>
  <label style="font-weight:bold;display:block;margin-bottom:6px;">
    CNPJ
  </label>

  <input id="fCNPJ"
         placeholder="Filtrar por CNPJ"
         style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
</div>

            <div>
              <label style="font-weight:bold;display:block;margin-bottom:6px;">Solicitante</label>
              <input id="fSolicitante" placeholder="Filtrar por Solicitante" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
            </div>
            <div>
              <label style="font-weight:bold;display:block;margin-bottom:6px;">T√©cnico</label>
              <select id="fTecnico" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;"><option value="">Todos os T√©cnicos</option></select>
            </div>
            <div>
              <label style="font-weight:bold;display:block;margin-bottom:6px;">Categoria</label>
              <select id="fCategoria" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;"><option value="">Todas as Categorias</option><option value="Caixa">Caixa</option><option value="Equipamento">Equipamento</option><option value="Retaguarda">Retaguarda</option><option value="Treinamento">Treinamento</option><option value="Apresenta√ß√£o">Apresenta√ß√£o</option><option value="Instala√ß√£o">Instala√ß√£o</option></select>
            </div>
            <div>
              <label style="font-weight:bold;display:block;margin-bottom:6px;">Tipo de Atendimento</label>
              <select id="fTipoAtendimento" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;"><option value="">Todos os Tipos</option><option value="Remoto">Remoto</option><option value="Presencial">Presencial</option></select>
            </div>
            <div>
              <label style="font-weight:bold;display:block;margin-bottom:6px;">Status</label>
              <select id="fStatus" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;"><option value="">Todos</option><option value="pendente">Pendente</option><option value="resolvido">Resolvido</option></select>
            </div>
            <div>
              <label style="font-weight:bold;display:block;margin-bottom:6px;">Data In√≠cio</label>
              <input id="fDataInicio" type="date" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
            </div>
            <div>
              <label style="font-weight:bold;display:block;margin-bottom:6px;">Data Fim</label>
              <input id="fDataFim" type="date" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
            </div>
         
          <div style="display:flex;gap:10px;margin-top:10px;">
  <button class="btn" onclick="app.relatorio()" style="flex:1;padding:12px;font-size:16px;">üîç Filtrar</button>
  <button class="btn" onclick="app.imprimirRelatorio()" style="flex:1;padding:12px;font-size:16px;background:#16a34a;">üñ®Ô∏è Imprimir</button>
</div>
        
       <table><thead><tr><th>ID</th><th>Data</th><th>Cliente</th><th>Solicitante</th><th>T√©cnico</th><th>Categoria</th><th>Tipo</th><th>Status</th><th>Descri√ß√£o</th></tr></thead><tbody id="resultadoRelatorio"></tbody></table>
      </section>
      <section id="usuarios" class="hidden">
        <h2>Gerenciar Usu√°rios</h2>
        <button class="btn" onclick="app.abrirModalNovoUsuario()" style="margin-bottom:20px;">+ Novo Usu√°rio</button>
        <table><thead><tr><th>Nome</th><th>Email</th><th>Permiss√µes</th><th>Cadastro</th><th>A√ß√µes</th></tr></thead><tbody id="listaUsuarios"></tbody></table>
      </section>
      <section id="auditoria" class="hidden">
        <h2>Auditoria (Hist√≥rico de A√ß√µes)</h2>
        <div style="background:#fff;padding:20px;border-radius:8px;margin-bottom:20px;">
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin-bottom:15px;">
            <input id="auditFiltroUsuario" placeholder="Filtrar por usu√°rio">
            <input id="auditFiltroAcao" placeholder="Filtrar por a√ß√£o">
            <input id="auditFiltroDataInicio" type="date">
            <input id="auditFiltroDataFim" type="date">
          </div>
          <div style="display:flex;gap:10px;">
            <button class="btn" onclick="app.filtrarAuditoria()" style="flex:1;">üîç Pesquisar</button>
            <button class="btn-danger" onclick="app.limparAuditoria()" style="flex:1;">üóëÔ∏è Limpar</button>
          </div>
        </div>
        <table><thead><tr><th>Data/Hora</th><th>Usu√°rio</th><th>A√ß√£o</th><th>Detalhes</th></tr></thead><tbody id="listaAuditoria"></tbody></table>
      </section>
      <section id="config" class="hidden">
        <h2>Configura√ß√µes</h2>
        <div style="background:#fff;padding:20px;border-radius:8px;max-width:600px;">
          <h3 style="margin-top:0;">Informa√ß√µes da Empresa</h3>
          <label style="display:block;margin-bottom:8px;font-weight:bold;">Nome:</label>
          <input id="confEmpresa" placeholder="Nome da empresa" style="width:100%;margin-bottom:15px;padding:8px;border:1px solid #ddd;border-radius:4px;">
          <label style="display:block;margin-bottom:8px;font-weight:bold;">Logo:</label>
          <input id="confLogo" placeholder="URL da logo" style="width:100%;margin-bottom:20px;padding:8px;border:1px solid #ddd;border-radius:4px;">
          <button class="btn" onclick="app.salvarConfig()" style="width:100%;">üíæ Salvar</button>
        </div>
      </section>
    </main>
  </div>
</div>

<div id="modal" class="modal"><div class="modal-content" style="width:400px;"><h3 style="margin-top:0;">Novo Chamado</h3><label style="font-weight:bold;display:block;margin-bottom:6px;">Cliente *</label><div style="position:relative;margin-bottom:10px;"><input id="mCliente" placeholder="Digite o cliente" autocomplete="off" oninput="app.buscarClientes()" onblur="setTimeout(() => { document.getElementById('listaClientesAutoComplete').style.display = 'none'; }, 200)"><div id="listaClientesAutoComplete" style="position:absolute;top:100%;left:0;right:0;background:#fff;border:1px solid #ddd;border-radius:4px;max-height:150px;overflow-y:auto;z-index:10;display:none;"></div></div><input id="mSolicitante" placeholder="Solicitante"><label style="font-weight:bold;display:block;margin-bottom:6px;">T√©cnico *</label><select id="mTecnico" style="width:100%;margin-bottom:10px;padding:8px;border:1px solid #ddd;border-radius:4px;"><option value="">Selecione um t√©cnico</option></select><label style="font-weight:bold;display:block;margin-bottom:6px;">Categoria *</label><select id="mCategoria" style="width:100%;margin-bottom:10px;padding:8px;border:1px solid #ddd;border-radius:4px;"><option value="">Selecione uma categoria</option><option value="Caixa">Caixa</option><option value="Equipamento">Equipamento</option><option value="Retaguarda">Retaguarda</option><option value="Treinamento">Treinamento</option><option value="Apresenta√ß√£o">Apresenta√ß√£o</option><option value="Instala√ß√£o">Instala√ß√£o</option></select><label style="font-weight:bold;display:block;margin-bottom:6px;">Tipo de Atendimento *</label><select id="mTipoAtendimento" style="width:100%;margin-bottom:10px;padding:8px;border:1px solid #ddd;border-radius:4px;"><option value="">Selecione o tipo</option><option value="Remoto">Remoto</option><option value="Presencial">Presencial</option></select><textarea id="mDescricao" placeholder="Descri√ß√£o" style="height:80px;"></textarea><button class="btn" onclick="app.salvarChamado()" style="width:100%;margin-bottom:8px;">Salvar</button><button class="btn-danger" onclick="app.fecharModal()" style="width:100%;">Cancelar</button></div></div>

<div id="modalNovoUsuario" class="modal"><div class="modal-content" style="width:500px;"><h3>‚ûï Novo Usu√°rio</h3><div id="msgNovoUsuario"></div><label style="font-weight:bold;display:block;margin-bottom:6px;">Nome *</label><input id="novoUsuarioNome" type="text" placeholder="Nome completo"><label style="font-weight:bold;display:block;margin-bottom:6px;">Email *</label><input id="novoUsuarioEmail" type="email" placeholder="Email"><label style="font-weight:bold;display:block;margin-bottom:6px;">Senha *</label><input id="novoUsuarioSenha" type="password" placeholder="M√≠n. 6 caracteres"><label style="font-weight:bold;display:block;margin-bottom:6px;">Confirmar *</label><input id="novoUsuarioConfirma" type="password" placeholder="Confirmar senha"><label style="font-weight:bold;display:block;margin-bottom:10px;">Permiss√µes:</label><div style="background:#f0f4f8;padding:15px;border-radius:6px;margin-bottom:20px;border:1px solid #ddd;"><div style="display:flex;align-items:center;margin-bottom:10px;"><input type="checkbox" id="permChamados" checked style="margin-right:10px;"><label for="permChamados" style="cursor:pointer;margin:0;">üìã Chamados</label></div><div style="display:flex;align-items:center;margin-bottom:10px;"><input type="checkbox" id="permClientes" checked style="margin-right:10px;"><label for="permClientes" style="cursor:pointer;margin:0;">üë• Clientes</label></div><div style="display:flex;align-items:center;margin-bottom:10px;"><input type="checkbox" id="permRelatorios" checked style="margin-right:10px;"><label for="permRelatorios" style="cursor:pointer;margin:0;">üìä Relat√≥rios</label></div><div style="display:flex;align-items:center;"><input type="checkbox" id="permUsuarios" style="margin-right:10px;"><label for="permUsuarios" style="cursor:pointer;margin:0;">üë®‚Äçüíº Admin</label></div></div><div style="display:flex;gap:10px;"><button class="btn" id="btnSalvarUsuario" onclick="app.criarNovoUsuario()" style="flex:1;">üíæ Criar</button><button class="btn-danger" onclick="app.fecharModalNovoUsuario()" style="flex:1;">Cancelar</button></div></div></div>

<div id="modalNovoCliente" class="modal"><div class="modal-content" style="width:500px;"><h3>‚ûï Novo Cliente</h3><input id="ncNome" placeholder="Nome *"><input id="ncRazao" placeholder="Raz√£o Social"><input id="ncCNPJ" placeholder="CNPJ/CPF"><input id="ncEndereco" placeholder="Endere√ßo"><textarea id="ncObservacoes" placeholder="Observa√ß√µes..." style="height:80px;"></textarea><div style="display:flex;gap:10px;"><button class="btn" onclick="app.salvarNovoCliente()" style="flex:1;">üíæ Salvar</button><button class="btn-danger" onclick="app.fecharModalNovoCliente()" style="flex:1;">Cancelar</button></div></div></div>

<div id="modalAcessos" class="modal"><div class="modal-content" style="width:550px;"><h3>üîê Acessos - <span id="clienteAcessoNome"></span></h3><label style="font-weight:bold;">Nome/Tipo *</label><input id="arNome" placeholder="Ex: Servidor 1"><label style="font-weight:bold;">Dados de Acesso</label><textarea id="arDescricao" placeholder="IP, Usu√°rio, Senha..." style="height:80px;"></textarea><button class="btn" onclick="app.salvarAcessoRemoto()" style="width:100%;margin-bottom:15px;">+ Adicionar</button><h4>Acessos Cadastrados</h4><div id="listaAcessosRemoto" style="max-height:250px;overflow-y:auto;margin-bottom:15px;"></div><button class="btn-danger" onclick="app.fecharAcessos()" style="width:100%;">Fechar</button></div></div>

<div id="modalCronologia" class="modal"><div class="modal-content"><h3>üìã Cronologia - <span id="idCronologia"></span></h3> <div id="descricaoPrincipal"></div><label style="font-weight:bold;">Atualiza√ß√£o</label><textarea id="descricaoCronologia" placeholder="Digite..." style="height:80px;"></textarea><button class="btn" onclick="app.salvarCronologia()" style="width:100%;margin-bottom:15px;">‚ûï Adicionar</button><h4>Hist√≥rico</h4><div id="listaCronologia" style="max-height:300px;overflow-y:auto;font-size:13px;"></div><button class="btn-danger" onclick="app.fecharCronologia()" style="width:100%;margin-top:15px;">Fechar</button></div></div>

<script>
const SUPABASE_URL = 'https://boendmrotsttljydigld.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJvZW5kbXJvdHN0dGxqeWRpZ2xkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1OTI5NTksImV4cCI6MjA4MjE2ODk1OX0.k6vVvD6kNV8r-a9lR6jaTcAm1wz5c_jbTDnjKlpo0cE';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
const app = {
  usuarioAtual: null, clienteAcessoAtual: null, chamadoCronologiaId: null,
  async login(){ const email = document.getElementById('loginEmail').value.trim(); const senha = document.getElementById('loginSenha').value; if(!email || !senha) return this.mostrarMsgLogin('‚ùå Preencha email e senha'); try{ const { data, error } = await sb.auth.signInWithPassword({ email, password: senha }); if(error) return this.mostrarMsgLogin('‚ùå ' + error.message); this.usuarioAtual = data.user; this.mostrarApp(); }catch(e){ this.mostrarMsgLogin('‚ùå Erro: ' + e.message); } },
  async registrarHistorico(chamadoId, acao){ try{ await sb.from('historico_chamados').insert({ chamado_id: chamadoId, acao, usuario_id: this.usuarioAtual?.id || null, usuario_nome: this.usuarioAtual?.user_metadata?.full_name || this.usuarioAtual?.email || 'Sistema', created_at: new Date().toISOString() }); }catch(e){console.error('Erro ao registrar hist√≥rico:', e.message);} },
  async registrarAuditoria(acao, detalhes = ''){ try{ await sb.from('auditoria').insert({ usuario_id: this.usuarioAtual?.id || null, usuario_nome: this.usuarioAtual?.user_metadata?.full_name || this.usuarioAtual?.email || 'Sistema', acao: acao, detalhes: detalhes, data_acao: new Date().toISOString() }); }catch(e){console.error('Erro ao registrar auditoria:', e.message);} },
  async logout(){ try{ await sb.auth.signOut(); this.usuarioAtual = null; document.getElementById('telaLogin').style.display = 'flex'; document.getElementById('appContainer').classList.add('hidden'); document.getElementById('loginEmail').value = ''; document.getElementById('loginSenha').value = ''; document.getElementById('msgLogin').innerHTML = ''; }catch(e){console.error('Erro ao sair:', e);} },
  mostrarMsgLogin(msg){ const div = document.getElementById('msgLogin'); const bg = msg.includes('‚úÖ') ? 'background:#dcfce7;color:#166534;' : 'background:#fee;color:#dc2626;'; div.innerHTML = `<div style="padding:10px;border-radius:6px;${bg}">${msg}</div>`; setTimeout(() => div.innerHTML = '', 5000); },
  async mostrarApp(){ setTimeout(async () => { document.getElementById('telaLogin').style.display = 'none'; document.getElementById('appContainer').classList.remove('hidden'); const nome = this.usuarioAtual.user_metadata?.full_name || this.usuarioAtual.email; document.getElementById('usuarioNome').innerText = nome; document.getElementById('usuarioEmail').innerText = this.usuarioAtual.email; try{ const {data} = await sb.from('usuarios').select('permissoes').eq('email', this.usuarioAtual.email).single(); const perms = data?.permissoes ? JSON.parse(data.permissoes) : {chamados: true, clientes: true, relatorios: true, usuarios: true, auditoria: true}; this.salvarPermissoes(perms); this.mostrarAbasPermitidas(perms); }catch(e){ const perms = {chamados: true, clientes: true, relatorios: true, usuarios: true, auditoria: true}; this.salvarPermissoes(perms); this.mostrarAbasPermitidas(perms); } this.carregarChamados(); this.carregarConfig(); }, 100); },
  mostrarAbasPermitidas(perms){ document.querySelectorAll('.menu-items button').forEach(btn => { const txt = btn.innerText; let aba = ''; if(txt.includes('Chamados')) aba = 'chamados'; else if(txt.includes('Clientes')) aba = 'clientes'; else if(txt.includes('Relat√≥rios')) aba = 'relatorios'; else if(txt.includes('Usu√°rios')) aba = 'usuarios'; else if(txt.includes('Auditoria')) aba = 'auditoria'; btn.style.display = (aba && perms[aba] === false) ? 'none' : 'block'; }); },
  mostrarErro(msg){ const div = document.getElementById('msgErro'); div.innerHTML = `<div class="erro">‚ùå ${msg}</div>`; setTimeout(() => div.innerHTML = '', 5000); },
  aba(id, btn){ const perms = this.obterPermissoes(); const abasOk = {chamados: perms.chamados !== false, clientes: perms.clientes !== false, relatorios: perms.relatorios !== false, usuarios: perms.usuarios !== false, auditoria: perms.auditoria !== false, config: true}; if(!abasOk[id]) return alert('‚ùå Sem permiss√£o para acessar'); document.querySelectorAll('section').forEach(s => s.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); document.querySelectorAll('.sidebar button').forEach(b => b.classList.remove('active')); btn.classList.add('active'); if(id === 'clientes') this.carregarClientes(); if(id === 'usuarios') this.carregarUsuarios(); if(id === 'auditoria') this.carregarAuditoria(); if(id === 'relatorios') this.carregarTecnicos();
},
  obterPermissoes(){ try{ return JSON.parse(localStorage.getItem('userPermissions') || '{}'); }catch{ return {chamados: true, clientes: true, relatorios: true, usuarios: true, auditoria: true}; } },
  salvarPermissoes(perms){ localStorage.setItem('userPermissions', JSON.stringify(perms)); },
  abrirModal(){ document.getElementById('modal').classList.add('active'); this.carregarTecnicos(); },
  async carregarTecnicos(){
  try{
    const {data} = await sb
      .from('usuarios')
      .select('nome, email')
      .order('nome',{ascending:true});

    // üîπ Modal Novo Chamado
    const mSelect = document.getElementById('mTecnico');
    if(mSelect){
      mSelect.innerHTML = '<option value="">Selecione um t√©cnico</option>';
      data.forEach(u => {
        const nome = u.nome || u.email;
        mSelect.innerHTML += `<option value="${nome}">${nome}</option>`;
      });
    }

    // üîπ Relat√≥rios
    const fSelect = document.getElementById('fTecnico');
    if(fSelect){
      fSelect.innerHTML = '<option value="">Todos os T√©cnicos</option>';
      data.forEach(u => {
        const nome = u.nome || u.email;
        fSelect.innerHTML += `<option value="${nome}">${nome}</option>`;
      });
    }

  }catch(e){
    console.error('Erro ao carregar t√©cnicos:', e);
  }
},

  fecharModal(){ document.getElementById('modal').classList.remove('active'); },
  async carregarChamados(){ try{ const {data} = await sb.from('chamados').select('*').order('id',{ascending:false}); const tbody = document.getElementById('listaChamados'); tbody.innerHTML = '';       if(!data || !data.length) return tbody.innerHTML = '<tr><td colspan="8">Nenhum chamado</td></tr>';       const hoje = new Date().toISOString().split('T')[0]; const filtrados = data.filter(c => c.created_at.substring(0,10) === hoje || c.status === 'pendente'); if(!filtrados.length) return tbody.innerHTML = '<tr><td colspan="8">Nenhum chamado pendente ou de hoje</td></tr>';       filtrados.forEach(c => tbody.innerHTML += `<tr><td>${c.id}</td><td>${new Date(c.created_at).toLocaleDateString('pt-BR')}</td><td>${c.cliente}</td><td>${c.solicitante}</td><td>${c.tecnico}</td><td><strong>${c.categoria || 'N/A'}</strong></td><td><span class="status ${c.status}" onclick="app.alterarStatus(${c.id},'${c.status}')">${c.status}</span></td><td><button class="btn" onclick="app.abrirCronologia(${c.id})" style="font-size:11px;padding:4px 6px;">üìã</button></td></tr>`); }catch(e){this.mostrarErro('Erro: '+e.message);} },
  async alterarStatus(id, status){ const novo = status === 'pendente' ? 'resolvido' : 'pendente'; try{ const {error} = await sb.from('chamados').update({status: novo}).eq('id', id); if(error) return this.mostrarErro('Erro ao alterar'); await this.registrarHistorico(id, `Status alterado para ${novo}`); await this.registrarAuditoria('Alterou status do chamado', `ID: ${id} | Novo status: ${novo}`); this.carregarChamados(); }catch(e){this.mostrarErro('Erro: '+e.message);} },
  async buscarClientes(){ const valor = document.getElementById('mCliente').value.trim(); const lista = document.getElementById('listaClientesAutoComplete'); if(valor.length < 1){ lista.style.display = 'none'; lista.innerHTML = ''; return; } try{ const {data} = await sb.from('clientes').select('nome').ilike('nome', `%${valor}%`).limit(20); lista.innerHTML = ''; if(!data || !data.length){ lista.innerHTML = `<div style="padding:10px;cursor:pointer;color:#2563eb;" onmousedown="app.selecionarCliente('${valor}')"><strong>+ Criar novo: ${valor}</strong></div>`; lista.style.display = 'block'; return; } data.forEach(c => lista.innerHTML += `<div style="cursor:pointer;border-bottom:1px solid #eee;" onmousedown="app.selecionarCliente('${c.nome}')">${c.nome}</div>`); lista.style.display = 'block'; }catch(e){console.error(e);} },
  selecionarCliente(nome){ document.getElementById('mCliente').value = nome; document.getElementById('listaClientesAutoComplete').style.display = 'none'; },
  async salvarChamado(){ const c = document.getElementById('mCliente').value.trim(); const s = document.getElementById('mSolicitante').value.trim(); const t = document.getElementById('mTecnico').value.trim(); const cat = document.getElementById('mCategoria').value.trim(); const tipo = document.getElementById('mTipoAtendimento').value.trim(); const d = document.getElementById('mDescricao').value.trim(); if(!c||!s||!t||!cat||!tipo||!d) return alert('Preencha todos os campos!'); try{ const {data:clienteExiste} = await sb.from('clientes').select('nome').eq('nome', c).single(); if(!clienteExiste){ await sb.from('clientes').insert({nome:c}); } const {data, error} = await sb.from('chamados').insert({cliente:c,solicitante:s,tecnico:t,categoria:cat,tipo_atendimento:tipo,descricao:d,status:'pendente',created_at:new Date().toISOString(),criado_por_id:this.usuarioAtual.id,criado_por_nome:this.usuarioAtual.user_metadata?.full_name || this.usuarioAtual.email,criado_por_email:this.usuarioAtual.email}).select().single(); if(error) return this.mostrarErro('Erro: '+error.message); await this.registrarHistorico(data.id, 'Chamado criado'); await this.registrarAuditoria('Criou chamado', `ID: ${data.id} | Cliente: ${c} | Categoria: ${cat} | Tipo: ${tipo}`); this.fecharModal(); this.carregarChamados(); }catch(e){this.mostrarErro('Erro: '+e.message);} },
  async carregarClientes(){ try{ const {data} = await sb.from('clientes').select('*'); const div = document.getElementById('listaClientes'); div.innerHTML = ''; if(!data || !data.length) return div.innerHTML = '<p style="grid-column:1/-1;text-align:center;">Nenhum cliente</p>'; data.forEach(c => div.innerHTML += `<div class="cliente-card"><h3>üë§ ${c.nome}</h3>${c.razao_social ? `<p style="font-size:12px;color:#666;"><strong>Raz√£o:</strong> ${c.razao_social}</p>` : ''}${c.cnpj ? `<p style="font-size:12px;color:#666;"><strong>CNPJ/CPF:</strong> ${c.cnpj}</p>` : ''}${c.endereco ? `<p style="font-size:12px;color:#666;"><strong>Endere√ßo:</strong> ${c.endereco}</p>` : ''}${c.observacoes ? `<p style="font-size:12px;color:#888;font-style:italic;margin-top:8px;">${c.observacoes}</p>` : ''}<div class="cliente-actions"><button class="btn" onclick="app.editarCliente('${c.nome.replace(/'/g, "\\'")}')" style="flex:1;">‚úèÔ∏è Alterar</button><button class="btn" onclick="app.abrirAcessos('${c.nome.replace(/'/g, "\\'")}')" style="flex:1;background:#16a34a;">üîê Acessos</button><button class="btn-danger" onclick="app.excluirCliente('${c.nome.replace(/'/g, "\\'")}')" style="flex:1;">üóëÔ∏è Excluir</button></div></div>`); }catch(e){console.error(e);} },
  abrirModalNovoCliente(){ document.getElementById('modalNovoCliente').classList.add('active'); document.getElementById('ncNome').value = ''; document.getElementById('ncRazao').value = ''; document.getElementById('ncCNPJ').value = ''; document.getElementById('ncEndereco').value = ''; document.getElementById('ncObservacoes').value = ''; },
  fecharModalNovoCliente(){ document.getElementById('modalNovoCliente').classList.remove('active'); },
  async salvarNovoCliente(){ const nome = document.getElementById('ncNome').value.trim(); if(!nome) return alert('Nome √© obrigat√≥rio!'); try{ const {error} = await sb.from('clientes').insert({nome,razao_social:document.getElementById('ncRazao').value.trim()||null,cnpj:document.getElementById('ncCNPJ').value.trim()||null,endereco:document.getElementById('ncEndereco').value.trim()||null,observacoes:document.getElementById('ncObservacoes').value.trim()||null}); if(error) return this.mostrarErro('Erro: '+error.message); await this.registrarAuditoria('Criou cliente', `Nome: ${nome} | CNPJ: ${document.getElementById('ncCNPJ').value.trim()}`); alert('‚úÖ Cliente cadastrado!'); this.fecharModalNovoCliente(); this.carregarClientes(); }catch(e){this.mostrarErro('Erro: '+e.message);} },
  async editarCliente(nome){ const {data} = await sb.from('clientes').select('*').eq('nome', nome).single(); if(!data) return this.mostrarErro('Cliente n√£o encontrado'); document.getElementById('ncNome').value = data.nome || ''; document.getElementById('ncRazao').value = data.razao_social || ''; document.getElementById('ncCNPJ').value = data.cnpj || ''; document.getElementById('ncEndereco').value = data.endereco || ''; document.getElementById('ncObservacoes').value = data.observacoes || ''; document.getElementById('modalNovoCliente').dataset.nomeOriginal = nome; const btnSalvar = document.querySelector('#modalNovoCliente .btn'); btnSalvar.innerText = 'üíæ Atualizar'; btnSalvar.onclick = () => this.salvarEdicaoCliente(); document.getElementById('modalNovoCliente').classList.add('active'); },
  async salvarEdicaoCliente(){ const original = document.getElementById('modalNovoCliente').dataset.nomeOriginal; const novo = document.getElementById('ncNome').value.trim(); if(!novo) return alert('Nome √© obrigat√≥rio!'); try{ const {error} = await sb.from('clientes').update({nome:novo,razao_social:document.getElementById('ncRazao').value.trim()||null,cnpj:document.getElementById('ncCNPJ').value.trim()||null,endereco:document.getElementById('ncEndereco').value.trim()||null,observacoes:document.getElementById('ncObservacoes').value.trim()||null}).eq('nome', original); if(error) return this.mostrarErro('Erro: '+error.message); alert('‚úÖ Cliente atualizado!'); this.fecharModalNovoCliente(); this.carregarClientes(); }catch(e){this.mostrarErro('Erro: '+e.message);} },
  async excluirCliente(nome){ const {data:chamados} = await sb.from('chamados').select('id').eq('cliente', nome).limit(1); if(chamados && chamados.length) return alert('‚ùå N√£o √© poss√≠vel excluir!\nEste cliente possui chamados.'); if(!confirm(`Tem certeza que deseja excluir "${nome}"?`)) return; try{ const {error} = await sb.from('clientes').delete().eq('nome', nome); if(error) return this.mostrarErro('Erro: '+error.message); alert('‚úÖ Cliente exclu√≠do!'); this.carregarClientes(); }catch(e){this.mostrarErro('Erro: '+e.message);} },
  async carregarUsuarios(){ try{ const {data, error} = await sb.from('usuarios').select('*').order('criado_em',{ascending:false}); if(error) return this.mostrarErro('Erro: Tabela "usuarios" n√£o configurada'); const tbody = document.getElementById('listaUsuarios'); tbody.innerHTML = ''; if(!data || !data.length) return tbody.innerHTML = '<tr><td colspan="5">Nenhum usu√°rio</td></tr>'; data.forEach(u => { const perms = u.permissoes ? JSON.parse(u.permissoes) : {chamados:true,clientes:true,relatorios:true,usuarios:false}; const lista = [perms.chamados && 'Chamados',perms.clientes && 'Clientes',perms.relatorios && 'Relat√≥rios',perms.usuarios && 'Admin'].filter(Boolean).join(', '); tbody.innerHTML += `<tr><td>${u.nome || u.email}</td><td>${u.email}</td><td>${lista}</td><td>${u.criado_em ? new Date(u.criado_em).toLocaleDateString('pt-BR') : '--'}</td><td><button class="btn" onclick="app.editarPermissoes('${u.id}','${u.nome || u.email}')" style="font-size:11px;padding:4px 6px;margin-right:5px;">‚úèÔ∏è</button><button class="btn-danger" onclick="app.excluirUsuario('${u.id}')" style="font-size:11px;padding:4px 6px;">üóëÔ∏è</button></td></tr>`; }); }catch(e){console.error(e);this.mostrarErro('Erro: '+e.message);} },
  abrirModalNovoUsuario(){ document.getElementById('modalNovoUsuario').classList.add('active'); document.getElementById('novoUsuarioNome').value = ''; document.getElementById('novoUsuarioEmail').value = ''; document.getElementById('novoUsuarioSenha').value = ''; document.getElementById('novoUsuarioConfirma').value = ''; document.getElementById('permChamados').checked = true; document.getElementById('permClientes').checked = true; document.getElementById('permRelatorios').checked = true; document.getElementById('permUsuarios').checked = false; document.getElementById('msgNovoUsuario').innerHTML = ''; },
  fecharModalNovoUsuario(){ document.getElementById('modalNovoUsuario').classList.remove('active'); document.querySelector('#modalNovoUsuario h3').innerText = '‚ûï Novo Usu√°rio'; document.getElementById('btnSalvarUsuario').innerText = 'üíæ Criar Usu√°rio'; document.getElementById('btnSalvarUsuario').onclick = () => this.criarNovoUsuario(); },
  async criarNovoUsuario(){ const nome = document.getElementById('novoUsuarioNome').value.trim(); const email = document.getElementById('novoUsuarioEmail').value.trim(); const senha = document.getElementById('novoUsuarioSenha').value; const confirma = document.getElementById('novoUsuarioConfirma').value; if(!nome || !email || !senha || !confirma) return this.mostrarMsgNU('‚ùå Preencha todos'); if(senha !== confirma) return this.mostrarMsgNU('‚ùå Senhas n√£o conferem'); if(senha.length < 6) return this.mostrarMsgNU('‚ùå M√≠nimo 6 caracteres'); try{ const {data, error} = await sb.auth.signUp({email, password: senha, options: {data: {full_name: nome}}}); if(error) return this.mostrarMsgNU('‚ùå '+error.message); const perms = {chamados:document.getElementById('permChamados').checked,clientes:document.getElementById('permClientes').checked,relatorios:document.getElementById('permRelatorios').checked,usuarios:document.getElementById('permUsuarios').checked}; const {error:dbErr} = await sb.from('usuarios').insert({id:data.user.id,nome,email,permissoes:JSON.stringify(perms),criado_em:new Date().toISOString()}); if(dbErr) return this.mostrarMsgNU('‚ùå '+dbErr.message); this.mostrarMsgNU('‚úÖ Usu√°rio criado!'); setTimeout(() => this.fecharModalNovoUsuario(), 1500); this.carregarUsuarios(); }catch(e){this.mostrarMsgNU('‚ùå '+e.message);} },
  mostrarMsgNU(msg){ const div = document.getElementById('msgNovoUsuario'); const bg = msg.includes('‚úÖ') ? '#dcfce7' : '#fee'; const cor = msg.includes('‚úÖ') ? '#166534' : '#dc2626'; div.innerHTML = `<div style="padding:10px;border-radius:6px;background:${bg};color:${cor};">${msg}</div>`; },
  async editarPermissoes(id, nome){ const {data} = await sb.from('usuarios').select('*').eq('id', id).single(); const perms = data.permissoes ? JSON.parse(data.permissoes) : {chamados:true,clientes:true,relatorios:true,usuarios:false}; document.getElementById('novoUsuarioNome').value = data.nome || data.email; document.getElementById('novoUsuarioEmail').value = data.email; document.getElementById('novoUsuarioSenha').value = ''; document.getElementById('novoUsuarioConfirma').value = ''; document.getElementById('novoUsuarioSenha').placeholder = '(deixar vazio = n√£o alterar)'; document.getElementById('novoUsuarioConfirma').placeholder = '(deixar vazio = n√£o alterar)'; document.getElementById('permChamados').checked = perms.chamados; document.getElementById('permClientes').checked = perms.clientes; document.getElementById('permRelatorios').checked = perms.relatorios; document.getElementById('permUsuarios').checked = perms.usuarios; document.querySelector('#modalNovoUsuario h3').innerText = '‚úèÔ∏è Editar - '+nome; document.getElementById('btnSalvarUsuario').innerText = 'üíæ Atualizar'; document.getElementById('btnSalvarUsuario').onclick = () => this.salvarEdicaoUsuario(id); document.getElementById('modalNovoUsuario').classList.add('active'); },
  async salvarEdicaoUsuario(id){ const perms = {chamados:document.getElementById('permChamados').checked,clientes:document.getElementById('permClientes').checked,relatorios:document.getElementById('permRelatorios').checked,usuarios:document.getElementById('permUsuarios').checked}; try{ const {error} = await sb.from('usuarios').update({permissoes:JSON.stringify(perms)}).eq('id', id); if(error) return this.mostrarMsgNU('‚ùå '+error.message); this.mostrarMsgNU('‚úÖ Atualizado!'); setTimeout(() => this.fecharModalNovoUsuario(), 1500); this.carregarUsuarios(); }catch(e){this.mostrarMsgNU('‚ùå '+e.message);} },
  async excluirUsuario(id){ if(!confirm('Excluir usu√°rio?')) return; try{ const {error} = await sb.from('usuarios').delete().eq('id', id); if(error) return this.mostrarErro('Erro: '+error.message); this.carregarUsuarios(); }catch(e){this.mostrarErro('Erro: '+e.message);} },
  abrirAcessos(cliente){ this.clienteAcessoAtual = cliente; document.getElementById('clienteAcessoNome').innerText = cliente; document.getElementById('arNome').value = ''; document.getElementById('arDescricao').value = ''; document.getElementById('modalAcessos').classList.add('active'); this.carregarAcessos(); },
  fecharAcessos(){ document.getElementById('modalAcessos').classList.remove('active'); },
  async carregarAcessos(){ try{ const {data} = await sb.from('acessos_remotos').select('*').eq('cliente_nome', this.clienteAcessoAtual).order('id',{ascending:false}); const lista = document.getElementById('listaAcessosRemoto'); lista.innerHTML = ''; if(!data || !data.length) return lista.innerHTML = '<p style="text-align:center;color:#999;">Nenhum acesso</p>'; data.forEach(a => lista.innerHTML += `<div style="padding:10px;background:#f0f4f8;border-radius:6px;margin-bottom:8px;border-left:4px solid #2563eb;"><strong>${a.nome}</strong><p style="margin:5px 0;font-size:12px;white-space:pre-wrap;">${a.descricao || '(sem dados)'}</p><button class="btn" onclick="app.editarAcesso(${a.id},'${a.nome.replace(/'/g,"\\'")}','${(a.descricao||'').replace(/'/g,"\\'")}')" style="padding:4px 6px;font-size:11px;margin-right:5px;">‚úèÔ∏è</button><button class="btn-danger" onclick="app.excluirAcesso(${a.id})" style="padding:4px 6px;font-size:11px;">üóëÔ∏è</button></div>`); }catch(e){console.error(e);} },
  async salvarAcessoRemoto(){ const nome = document.getElementById('arNome').value.trim(); const desc = document.getElementById('arDescricao').value.trim(); if(!nome) return alert('Nome √© obrigat√≥rio!'); try{ const {error} = await sb.from('acessos_remotos').insert({cliente_nome:this.clienteAcessoAtual,nome,descricao:desc||null}); if(error) return this.mostrarErro('Erro: '+error.message); document.getElementById('arNome').value = ''; document.getElementById('arDescricao').value = ''; this.carregarAcessos(); }catch(e){this.mostrarErro('Erro: '+e.message);} },
  editarAcesso(id, nome, desc){ const novo = prompt(`Editar: ${nome}`, desc); if(novo !== null) this.salvarEditAcesso(id, novo); },
  async salvarEditAcesso(id, desc){ try{ const {error} = await sb.from('acessos_remotos').update({descricao:desc||null}).eq('id', id); if(error) return this.mostrarErro('Erro: '+error.message); this.carregarAcessos(); }catch(e){this.mostrarErro('Erro: '+e.message);} },
  async excluirAcesso(id){ if(!confirm('Excluir?')) return; try{ const {error} = await sb.from('acessos_remotos').delete().eq('id', id); if(error) return this.mostrarErro('Erro: '+error.message); this.carregarAcessos(); }catch(e){this.mostrarErro('Erro: '+e.message);} },
  abrirCronologia(id){ this.chamadoCronologiaId = id; document.getElementById('idCronologia').innerText = id; document.getElementById('descricaoCronologia').value = ''; this.carregarChamadoDescricao(); this.carregarCronologia(); document.getElementById('modalCronologia').classList.add('active'); },
  fecharCronologia(){ document.getElementById('modalCronologia').classList.remove('active'); },
  async carregarCronologia(){ try{ const {data} = await sb.from('cronologia_chamados').select('*').eq('chamado_id', this.chamadoCronologiaId).order('data',{ascending:true}); const lista = document.getElementById('listaCronologia'); lista.innerHTML = '';       if(!data || !data.length) return lista.innerHTML = '<p style="color:#999;text-align:center;padding:20px;">Nenhuma atualiza√ß√£o</p>'; data.forEach(c => lista.innerHTML += `<div style="padding:10px;background:#f0f0f0;border-radius:4px;margin-bottom:8px;border-left:3px solid #2563eb;"><span style="font-weight:bold;">Data: ${new Date(c.data).toLocaleString('pt-BR')}</span><br><small style="color:#666;"><strong>Por:</strong> ${c.usuario_nome || 'N/A'}</small>${c.editado_por ? `<br><small style="color:#d97706;"><strong>Editado por:</strong> ${c.editado_por} em ${new Date(c.data_edicao).toLocaleString('pt-BR')}</small>` : ''}<p style="margin:6px 0 0 0;white-space:pre-wrap;">${c.descricao}</p><button class="btn" onclick="app.editarCronologia(${c.id},'${(c.descricao||'').replace(/'/g,"\\'")}')" style="padding:3px 8px;font-size:10px;margin-right:5px;background:#16a34a;">‚úèÔ∏è</button><button class="btn-danger" onclick="app.excluirCronologia(${c.id})" style="padding:3px 8px;font-size:10px;">üóëÔ∏è</button></div>`); }catch(e){console.error(e);} },
  async salvarCronologia(){ const desc = document.getElementById('descricaoCronologia').value.trim(); if(!desc) return alert('Digite uma atualiza√ß√£o!'); try{ const {error} = await sb.from('cronologia_chamados').insert({chamado_id:this.chamadoCronologiaId,descricao:desc,usuario_nome:this.usuarioAtual.user_metadata?.full_name || this.usuarioAtual.email,data:new Date().toISOString()}); if(error) return this.mostrarErro('Erro: '+error.message); await this.registrarHistorico(this.chamadoCronologiaId, 'Adicionou atualiza√ß√£o na cronologia'); await this.registrarAuditoria('Adicionou cronologia', `Chamado ID: ${this.chamadoCronologiaId} | Atualiza√ß√£o: ${desc.substring(0, 50)}...`); this.carregarCronologia(); document.getElementById('descricaoCronologia').value = ''; }catch(e){this.mostrarErro('Erro: '+e.message);} },
  editarCronologia(id, desc){ const novo = prompt('Editar:', desc); if(novo !== null && novo.trim()) this.salvarEditCronologia(id, novo.trim()); },
  async salvarEditCronologia(id, desc){ try{ const {error} = await sb.from('cronologia_chamados').update({descricao:desc,editado_por:this.usuarioAtual.user_metadata?.full_name || this.usuarioAtual.email,data_edicao:new Date().toISOString()}).eq('id', id); if(error) return this.mostrarErro('Erro: '+error.message); await this.registrarAuditoria('Editou cronologia', `Chamado ID: ${this.chamadoCronologiaId} | Nova atualiza√ß√£o: ${desc.substring(0, 50)}...`); this.carregarCronologia(); }catch(e){this.mostrarErro('Erro: '+e.message);} },
  async excluirCronologia(id){ if(!confirm('Excluir?')) return; try{ const {error} = await sb.from('cronologia_chamados').delete().eq('id', id); if(error) return this.mostrarErro('Erro: '+error.message); await this.registrarAuditoria('Deletou cronologia', `Chamado ID: ${this.chamadoCronologiaId}`); this.carregarCronologia(); }catch(e){this.mostrarErro('Erro: '+e.message);} },
  abrirCronologiaVisualizar(id){ this.chamadoCronologiaId = id; document.getElementById('idCronologia').innerText = id; document.getElementById('descricaoCronologia').value = ''; this.carregarCronologia(); document.getElementById('modalCronologia').classList.add('active'); },
  async salvarConfig(){ const nome = document.getElementById('confEmpresa').value.trim(); const logo = document.getElementById('confLogo').value.trim(); if(nome) document.getElementById('nomeEmpresa').innerText = nome; if(logo){ const logoImg = document.getElementById('logoEmpresa'); logoImg.src = logo; logoImg.classList.remove('hidden'); } alert('‚úÖ Configura√ß√µes salvas!'); },
  async carregarConfig(){ try{ const {data} = await sb.from('configuracoes').select('*').eq('id',1).single(); if(!data) return; document.getElementById('confEmpresa').value = data.empresa || ''; document.getElementById('confLogo').value = data.logo_url || ''; if(data.empresa) document.getElementById('nomeEmpresa').innerText = data.empresa; if(data.logo_url){ const logoImg = document.getElementById('logoEmpresa'); logoImg.src = data.logo_url; logoImg.classList.remove('hidden'); } }catch(e){console.error(e);} },
  async relatorio(){ try{ let q = sb.from('chamados').select('*'); if(document.getElementById('fTipoAtendimento').value){
  q = q.eq('tipo_atendimento', document.getElementById('fTipoAtendimento').value);
} if(document.getElementById('fCategoria').value){
  q = q.eq('categoria', document.getElementById('fCategoria').value);
} if(document.getElementById('fCliente').value) q = q.ilike('cliente','%'+document.getElementById('fCliente').value+'%'); if(document.getElementById('fSolicitante').value) q = q.ilike('solicitante','%'+document.getElementById('fSolicitante').value+'%'); if(document.getElementById('fTecnico').value) q = q.ilike('tecnico','%'+document.getElementById('fTecnico').value+'%'); if(document.getElementById('fStatus').value) q = q.eq('status',document.getElementById('fStatus').value); const {data,error} = await q.order('created_at',{ascending:false}); if(error) return this.mostrarErro('Erro: '+error.message); let resultados = data || []; const cnpjFiltro = document.getElementById('fCNPJ').value.trim(); if(cnpjFiltro){ const {data:clientes} = await sb.from('clientes').select('nome, cnpj').ilike('cnpj','%'+cnpjFiltro+'%'); const nomes = clientes ? clientes.map(c => c.nome) : []; resultados = resultados.filter(c => nomes.includes(c.cliente)); } const dataInicio = document.getElementById('fDataInicio').value; const dataFim = document.getElementById('fDataFim').value; if(dataInicio || dataFim){ resultados = resultados.filter(c => { const dataChamado = c.created_at.substring(0, 10); if(dataInicio && dataChamado < dataInicio) return false; if(dataFim && dataChamado > dataFim) return false; return true; }); } const tbody = document.getElementById('resultadoRelatorio'); tbody.innerHTML = '';       if(!resultados || !resultados.length) return tbody.innerHTML = '<tr><td colspan="7">Nenhum resultado</td></tr>';       resultados.forEach(c => tbody.innerHTML += `<tr><td>${c.id}</td><td>${new Date(c.created_at).toLocaleDateString('pt-BR')}</td><td>${c.cliente}</td><td>${c.solicitante}</td><td>${c.tecnico}</td><td>${c.categoria || 'N/A'}</td><td>${c.tipo_atendimento || 'N/A'}</td><td><span class="status ${c.status}">${c.status}</span></td><td style="font-size:12px;max-width:250px;"><strong>Por:</strong> ${c.criado_por_nome || 'N/A'}<br><small style="color:#999;">${new Date(c.created_at).toLocaleString('pt-BR')}</small><p style="margin:8px 0 0 0;">${c.descricao}</p><button class="btn" onclick="app.abrirCronologia(${c.id})" style="font-size:11px;padding:4px 6px;margin-top:8px;">üìã Cronologia</button></td></tr>`); }catch(e){this.mostrarErro('Erro: '+e.message);} },
  async carregarAuditoria(){ try{ const tbody = document.getElementById('listaAuditoria'); tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;padding:20px;color:#999;">Use a pesquisa para filtrar registros</td></tr>'; }catch(e){console.error(e);} },
  async filtrarAuditoria(){ try{ const {data, error} = await sb.from('auditoria').select('*').order('data_acao',{ascending:false}).limit(1000); if(error) return this.mostrarErro('Erro: '+error.message); let resultados = data || []; const usuarioFiltro = document.getElementById('auditFiltroUsuario').value.trim().toLowerCase(); if(usuarioFiltro){ resultados = resultados.filter(a => a.usuario_nome.toLowerCase().includes(usuarioFiltro)); } const acaoFiltro = document.getElementById('auditFiltroAcao').value.trim().toLowerCase(); if(acaoFiltro){ resultados = resultados.filter(a => a.acao.toLowerCase().includes(acaoFiltro)); } const dataInicio = document.getElementById('auditFiltroDataInicio').value; const dataFim = document.getElementById('auditFiltroDataFim').value; if(dataInicio || dataFim){ resultados = resultados.filter(a => { const dataAcao = a.data_acao.substring(0, 10); if(dataInicio && dataAcao < dataInicio) return false; if(dataFim && dataAcao > dataFim) return false; return true; }); } const tbody = document.getElementById('listaAuditoria'); tbody.innerHTML = ''; if(!resultados.length) return tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;padding:20px;">Nenhum resultado encontrado</td></tr>'; resultados.forEach(a => { const dataFormatada = new Date(a.data_acao).toLocaleString('pt-BR'); tbody.innerHTML += `<tr><td>${dataFormatada}</td><td><strong>${a.usuario_nome}</strong></td><td>${a.acao}</td><td style="font-size:12px;color:#666;">${a.detalhes || '--'}</td></tr>`; }); }catch(e){this.mostrarErro('Erro: '+e.message);} },
  limparAuditoria(){ document.getElementById('auditFiltroUsuario').value = ''; document.getElementById('auditFiltroAcao').value = ''; document.getElementById('auditFiltroDataInicio').value = ''; document.getElementById('auditFiltroDataFim').value = ''; const tbody = document.getElementById('listaAuditoria'); tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;padding:20px;color:#999;">Use a pesquisa para filtrar registros</td></tr>'; },
  // ADICIONE ESTA FUN√á√ÉO NO OBJETO "app"

imprimirRelatorio(){
  const nomeEmpresa = document.getElementById('nomeEmpresa').innerText;
  const dataAtual = new Date().toLocaleDateString('pt-BR');
  const resultados = document.getElementById('resultadoRelatorio').getElementsByTagName('tr');
  
  if(resultados.length === 0){
    alert('‚ùå Nenhum dado para imprimir! Fa√ßa uma busca primeiro.');
    return;
  }

  let html = `
    <!DOCTYPE html>
    <html lang="pt-BR">
    <head>
      <meta charset="UTF-8">
      <title>Relat√≥rio de Chamados</title>
      <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; color: #333; }
        .header { text-align: center; margin-bottom: 30px; border-bottom: 3px solid #2563eb; padding-bottom: 20px; }
        .header h1 { font-size: 24px; color: #1f2937; margin-bottom: 5px; }
        .header p { font-size: 13px; color: #666; }
        .filtros { background: #f3f4f6; padding: 12px; border-radius: 6px; margin-bottom: 20px; font-size: 12px; }
        .filtros h3 { font-size: 13px; font-weight: bold; margin-bottom: 8px; color: #1f2937; }
        .filtro-item { display: inline-block; margin-right: 15px; margin-bottom: 5px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; font-size: 12px; }
        th { background: #2563eb; color: #fff; font-weight: bold; }
        tr:nth-child(even) { background: #f9fafb; }
        .status-pendente { background: #fef3c7; color: #92400e; padding: 4px 8px; border-radius: 4px; font-size: 11px; }
        .status-resolvido { background: #dcfce7; color: #166534; padding: 4px 8px; border-radius: 4px; font-size: 11px; }
        .footer { margin-top: 30px; text-align: center; font-size: 11px; color: #999; border-top: 1px solid #ddd; padding-top: 15px; }
        @media print {
          body { background: white; }
          .no-print { display: none; }
        }
      </style>
    </head>
    <body>
      <div class="header">
        <h1>${nomeEmpresa}</h1>
        <p>Relat√≥rio de Chamados</p>
        <p>Gerado em ${dataAtual}</p>
      </div>

      <div class="filtros">
        <h3>üìã Filtros Aplicados:</h3>
        <div class="filtro-item"><strong>Cliente:</strong> ${document.getElementById('fCliente').value || 'Todos'}</div>
        <div class="filtro-item"><strong>T√©cnico:</strong> ${document.getElementById('fTecnico').value || 'Todos'}</div>
        <div class="filtro-item"><strong>Categoria:</strong> ${document.getElementById('fCategoria').value || 'Todas'}</div>
        <div class="filtro-item"><strong>Status:</strong> ${document.getElementById('fStatus').value || 'Todos'}</div>
        <div class="filtro-item"><strong>Tipo:</strong> ${document.getElementById('fTipoAtendimento').value || 'Todos'}</div>
      </div>

      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Data</th>
            <th>Cliente</th>
            <th>Solicitante</th>
            <th>T√©cnico</th>
            <th>Categoria</th>
            <th>Tipo</th>
            <th>Status</th>
            <th>Descri√ß√£o</th>
          </tr>
        </thead>
        <tbody>
  `;

  // Adiciona linhas da tabela
  for(let i = 1; i < resultados.length; i++){
    const cells = resultados[i].getElementsByTagName('td');
    if(cells.length === 0) continue;
    
    const id = cells[0]?.innerText || '';
    const data = cells[1]?.innerText || '';
    const cliente = cells[2]?.innerText || '';
    const solicitante = cells[3]?.innerText || '';
    const tecnico = cells[4]?.innerText || '';
    const categoria = cells[5]?.innerText || '';
    const tipo = cells[6]?.innerText || '';
    const status = cells[7]?.innerText?.trim().toLowerCase() || '';
    const descricao = cells[8]?.innerText?.split('\n')[0] || '';
    
    const statusClass = status === 'pendente' ? 'status-pendente' : 'status-resolvido';
    const statusLabel = status === 'pendente' ? 'Pendente' : 'Resolvido';

    html += `
      <tr>
        <td>${id}</td>
        <td>${data}</td>
        <td>${cliente}</td>
        <td>${solicitante}</td>
        <td>${tecnico}</td>
        <td>${categoria}</td>
        <td>${tipo}</td>
        <td><span class="${statusClass}">${statusLabel}</span></td>
        <td>${descricao.substring(0, 50)}...</td>
      </tr>
    `;
  }

  html += `
        </tbody>
      </table>

      <div class="footer">
        <p>Total de registros: ${resultados.length - 1}</p>
        <p>Sistema de Chamados - Impress√£o em ${dataAtual}</p>
      </div>
    </body>
    </html>
  `;

  const janelaImpressao = window.open('', '', 'width=1200,height=800');
  janelaImpressao.document.write(html);
  janelaImpressao.document.close();
  janelaImpressao.print();
},
  async carregarChamadoDescricao(){
  try{
    const {data} = await sb.from('chamados').select('descricao').eq('id', this.chamadoCronologiaId).single();
    if(!data) return;
    
    const descricaoDiv = document.getElementById('descricaoPrincipal');
    if(descricaoDiv){
      descricaoDiv.innerHTML = `
        <div style="padding:15px;background:#e3f2fd;border-radius:6px;margin-bottom:20px;border-left:4px solid #1976d2;">
          <h4 style="margin:0 0 10px 0;color:#1565c0;">üìù Descri√ß√£o do Chamado</h4>
          <p style="margin:0;white-space:pre-wrap;color:#333;">${data.descricao}</p>
          <button class="btn" onclick="app.editarDescricaoChamado(${this.chamadoCronologiaId},'${(data.descricao||'').replace(/'/g,"\\'")}')" style="padding:6px 10px;font-size:11px;margin-top:10px;background:#16a34a;">‚úèÔ∏è Editar</button>
          <button class="btn-danger" onclick="app.excluirDescricaoChamado()" style="padding:6px 10px;font-size:11px;margin-top:10px;margin-left:5px;">üóëÔ∏è Limpar</button>
        </div>
      `;
    }
  }catch(e){
    console.error(e);
  }
},

async editarDescricaoChamado(id, descricaoAtual){
  const novaDesc = prompt('Editar descri√ß√£o do chamado:', descricaoAtual);
  if(novaDesc !== null && novaDesc.trim()){
    try{
      const {error} = await sb.from('chamados').update({descricao: novaDesc.trim()}).eq('id', id);
      if(error) return this.mostrarErro('Erro: '+error.message);
      
      await this.registrarAuditoria('Editou descri√ß√£o do chamado', `Chamado ID: ${id} | Nova descri√ß√£o: ${novaDesc.substring(0, 50)}...`);
      this.carregarChamadoDescricao();
    }catch(e){
      this.mostrarErro('Erro: '+e.message);
    }
  }
},

async excluirDescricaoChamado(){
  if(!confirm('Tem certeza que deseja limpar a descri√ß√£o do chamado?')) return;
  
  try{
    const {error} = await sb.from('chamados').update({descricao: ''}).eq('id', this.chamadoCronologiaId);
    if(error) return this.mostrarErro('Erro: '+error.message);
    
    await this.registrarAuditoria('Deletou descri√ß√£o do chamado', `Chamado ID: ${this.chamadoCronologiaId}`);
    this.carregarChamadoDescricao();
  }catch(e){
    this.mostrarErro('Erro: '+e.message);
  }
},
  init(){ document.getElementById('btnLogin').addEventListener('click', () => this.login()); document.getElementById('btnLogout').addEventListener('click', () => this.logout()); document.getElementById('loginEmail').addEventListener('keypress', (e) => {if(e.key === 'Enter') this.login();}); document.getElementById('loginSenha').addEventListener('keypress', (e) => {if(e.key === 'Enter') this.login();}); document.getElementById('telaLogin').style.display = 'flex'; document.getElementById('appContainer').classList.add('hidden'); const menuToggle = document.getElementById('menuToggle'); const sidebar = document.querySelector('.sidebar'); if(menuToggle && sidebar){ menuToggle.addEventListener('click', () => sidebar.classList.toggle('open')); document.querySelectorAll('.menu-items button').forEach(btn => { btn.addEventListener('click', () => sidebar.classList.remove('open')); }); } }
};
window.addEventListener('load', () => app.init());
</script>
</body>
</html>
